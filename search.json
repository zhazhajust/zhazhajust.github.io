[{"title":"Linux cgroup å®ç° SSH ç”¨æˆ·èµ„æºé™åˆ¶æŒ‡å—","url":"/2025/12/21/linux-cgroup-ssh-limit/","content":"\næœ¬æ–‡è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ cgroup å¯¹ SSH ç™»å½•ç”¨æˆ·è¿›è¡Œèµ„æºé™åˆ¶ï¼ŒåŒ…æ‹¬ CPUã€å†…å­˜å’Œ GPU èµ„æºçš„é…é¢ç®¡ç†ã€‚\n\n## ä¸€ã€cgroup é™åˆ¶åŸç†\n\n### 1. èµ„æºæ§åˆ¶å±‚æ¬¡\n```mermaid\ngraph TD\n    A[ç³»ç»Ÿèµ„æº] --> B[cgroup å±‚çº§]\n    B --> C[ç”¨æˆ·ä¼šè¯]\n    B --> D[ç”¨æˆ·è¿›ç¨‹]\n    C --> E[CPU é™åˆ¶]\n    C --> F[å†…å­˜é™åˆ¶]\n    C --> G[GPU é™åˆ¶]\n```\n\n### 2. å…³é”®ç»„ä»¶\n| ç»„ä»¶ | åŠŸèƒ½ | é…ç½®æ–‡ä»¶ |\n|------|------|----------|\n| cgconfig | cgroup å®šä¹‰ | `/etc/cgconfig.conf` |\n| cgred | è§„åˆ™å¼•æ“ | `/etc/cgrules.conf` |\n| pam_cgroup | PAM é›†æˆ | `/etc/pam.d/sshd` |\n\n## äºŒã€åŸºç¡€ç¯å¢ƒé…ç½®\n\n### 1. å®‰è£…å¿…è¦å·¥å…·\n```bash\n# CentOS/RHEL\nsudo dnf install libcgroup libcgroup-tools\n\n# Ubuntu/Debian\nsudo apt install cgroup-tools cgroupfs-mount\n```\n\n### 2. å¯ç”¨ cgroup æœåŠ¡\n```bash\nsudo systemctl enable cgconfig\nsudo systemctl enable cgred\n```\n\n## ä¸‰ã€SSH ç”¨æˆ·èµ„æºé™åˆ¶é…ç½®\n\n### 1. åˆ›å»º cgroup æ¨¡æ¿\nç¼–è¾‘ `/etc/cgconfig.conf`ï¼š\n```conf\n# CPU é™åˆ¶ï¼ˆç›¸å¯¹æƒé‡ï¼‰\ngroup ssh_limit/cpu {\n    cpu {\n        cpu.shares = 512;  # é»˜è®¤1024ï¼Œå€¼è¶Šå°æƒé‡è¶Šä½\n    }\n}\n\n# å†…å­˜é™åˆ¶ï¼ˆç¡¬é™åˆ¶ï¼‰\ngroup ssh_limit/memory {\n    memory {\n        memory.limit_in_bytes = 8G;\n        memory.memsw.limit_in_bytes = 16G;  # åŒ…å«äº¤æ¢ç©ºé—´\n    }\n}\n\n# CPU æ ¸ç»‘å®š\ngroup ssh_limit/cpuset {\n    cpuset {\n        cpuset.cpus = \"0-3\";  # åªå…è®¸ä½¿ç”¨0-3å·CPUæ ¸å¿ƒ\n        cpuset.mems = \"0\";    # NUMAèŠ‚ç‚¹\n    }\n}\n```\n\n### 2. é…ç½®ç”¨æˆ·æ˜ å°„è§„åˆ™\nç¼–è¾‘ `/etc/cgrules.conf`ï¼š\n```conf\n# æ ¼å¼ï¼šç”¨æˆ·:è¿›ç¨‹ æ§åˆ¶å™¨ç»„ è·¯å¾„\n*:user1  cpu,memory,cpuset  ssh_limit/\n*:user2  cpu,memory,cpuset  ssh_limit/\n*:@devteam  cpu,memory,cpuset  ssh_limit/  # ç”¨æˆ·ç»„\n```\n\n### 3. é›†æˆ SSH è®¤è¯\nç¼–è¾‘ `/etc/pam.d/sshd`ï¼š\n```conf\n# åœ¨ session éƒ¨åˆ†æ·»åŠ \nsession    required     pam_cgroup.so\n```\n\n### 4. é‡å¯æœåŠ¡\n```bash\nsudo systemctl restart cgconfig cgred sshd\n```\n\n## å››ã€GPU èµ„æºé™åˆ¶ï¼ˆNVIDIAï¼‰\n\n### 1. å®‰è£… GPU cgroup å·¥å…·\n```bash\n# NVIDIA ä¸“ç”¨å·¥å…·\nsudo dnf install nvidia-cgroup-tools\n\n# æˆ–æ‰‹åŠ¨é…ç½®\nsudo mkdir /sys/fs/cgroup/devices/gpu_limited\n```\n\n### 2. é…ç½® GPU è®¾å¤‡è§„åˆ™\n```bash\n# ç¦æ­¢æ‰€æœ‰GPUè®¾å¤‡\necho 'c 195:* rwm' | sudo tee /sys/fs/cgroup/devices/gpu_limited/devices.deny\n\n# æŒ‰éœ€å…è®¸ç‰¹å®šè®¾å¤‡\necho 'c 195:0 rwm' | sudo tee /sys/fs/cgroup/devices/gpu_limited/devices.allow  # /dev/nvidia0\necho 'c 195:1 rwm' | sudo tee /sys/fs/cgroup/devices/gpu_limited/devices.allow  # /dev/nvidia1\n```\n\n### 3. ç”¨æˆ· GPU é…é¢\nåœ¨ `/etc/cgrules.conf` æ·»åŠ ï¼š\n```conf\n*:gpu_user  devices  gpu_limited/\n```\n\n## äº”ã€èµ„æºä½¿ç”¨ç›‘æ§\n\n### 1. å®æ—¶æŸ¥çœ‹ cgroup çŠ¶æ€\n```bash\n# CPU ä½¿ç”¨\ncgget -g cpu:ssh_limit/cpu\n\n# å†…å­˜ä½¿ç”¨\ncgget -g memory:ssh_limit/memory\n\n# GPU è®¾å¤‡è®¿é—®\ncgget -g devices:gpu_limited\n```\n\n### 2. ç”Ÿæˆèµ„æºæŠ¥å‘Š\n```bash\n# æ¯å°æ—¶è®°å½•èµ„æºä½¿ç”¨\n*/60 * * * * root cgget -g cpu,memory:ssh_limit/ > /var/log/cgroup-usage.log\n```\n\n## å…­ã€é«˜çº§é…ç½®æŠ€å·§\n\n### 1. åŠ¨æ€è°ƒæ•´é™åˆ¶\n```bash\n# ä¸´æ—¶å¢åŠ å†…å­˜é…é¢ï¼ˆ8G â†’ 12Gï¼‰\ncgset -r memory.limit_in_bytes=12G ssh_limit/memory\n\n# æ°¸ä¹…ä¿®æ”¹éœ€æ›´æ–° /etc/cgconfig.conf\n```\n\n### 2. ç”¨æˆ·ç»„é…é¢ç»§æ‰¿\n```conf\n# çˆ¶ç»„å®šä¹‰\ngroup parent_group {\n    cpu {\n        cpu.shares = 1024;\n    }\n}\n\n# å­ç»„ç»§æ‰¿\ngroup parent_group/child_group {\n    cpu {\n        cpu.shares = 512;\n    }\n}\n```\n\n## ä¸ƒã€å¸¸è§é—®é¢˜æ’æŸ¥\n\n### 1. SSH ç™»å½•åæ— é™åˆ¶\n**æ£€æŸ¥ç‚¹**ï¼š\n1. `pam_cgroup` æ˜¯å¦åœ¨ `/etc/pam.d/sshd` ä¸­å¯ç”¨\n2. ç”¨æˆ·æ˜¯å¦åœ¨ `/etc/cgrules.conf` ä¸­å®šä¹‰\n3. cgred æœåŠ¡çŠ¶æ€ï¼š`systemctl status cgred`\n\n### 2. GPU è®¾å¤‡è®¿é—®è¢«æ‹’\n**è§£å†³æ­¥éª¤**ï¼š\n```bash\n# æŸ¥çœ‹è®¾å¤‡æƒé™\ncgget -g devices:gpu_limited\n\n# æ·»åŠ ç¼ºå¤±è®¾å¤‡\necho 'c 195:2 rwm' | sudo tee /sys/fs/cgroup/devices/gpu_limited/devices.allow\n```\n\n### 3. å†…å­˜è¶…é™å¤„ç†\né…ç½® OOM é€šçŸ¥ï¼š\n```conf\n# /etc/cgconfig.conf\ngroup ssh_limit/memory {\n    memory {\n        memory.oom_control = 1;  # å¯ç”¨OOMé€šçŸ¥\n    }\n}\n```\n\nç›‘æ§ OOM äº‹ä»¶ï¼š\n```bash\nsudo tail -f /var/log/messages | grep -i oom\n```\n\n> æœ¬æ–‡æ¡£æ›´æ–°æ—¥æœŸï¼š2025-12-21  \n> é€‚ç”¨ç³»ç»Ÿï¼šCentOS/RHEL 8+, Ubuntu 20.04+\n","tags":["Linux","cgroup","èµ„æºç®¡ç†"]},{"title":"å¹¿ä¹‰åŠ¨é‡å®ˆæ’æ¨å¯¼","url":"/2025/02/27/rel_mom/","content":"\nä¸‹é¢ç»™å‡ºä¸€ä¸ªè¾ƒä¸ºè¯¦ç»†çš„æ¨å¯¼æ€è·¯ï¼Œè¯´æ˜ä¸ºä»€ä¹ˆä¼šå¾—åˆ°æ–¹ç¨‹\n$$\n\\frac{d}{dt}\\left(\\mathbf{p}_\\perp + q\\,\\mathbf{A}\\right) = 0 \\quad \\Longrightarrow \\quad \\mathbf{p}_\\perp = \\mathbf{p}_\\perp^0 - q\\,\\mathbf{A},\n$$\nä»¥åŠ $\\mathbf{p}_\\perp^0 = m \\gamma^0 \\mathbf{v}_\\perp^0$ ç­‰ç»“æœã€‚è¿™é‡Œ $\\mathbf{p}_\\perp$ æŒ‡çš„æ˜¯ç²’å­çš„æ¨ªå‘(ä¸ä¸»ä¼ æ’­æ–¹å‘æ­£äº¤)åŠ¨é‡ï¼Œ$\\mathbf{A}$ æ˜¯ç”µç£åŠ¿(çŸ¢åŠ¿)ï¼Œ$q$ æ˜¯ç²’å­ç”µè·ï¼Œ$m$ æ˜¯ç²’å­è´¨é‡ï¼Œ$\\gamma$ æ˜¯ç›¸å¯¹è®ºå› å­ã€‚ä¸‹é¢åˆ†æ­¥éª¤è¯´æ˜ã€‚\n\n---\n\n## 1. å¹¿ä¹‰åŠ¨é‡çš„å®šä¹‰ä¸è¿åŠ¨æ–¹ç¨‹\n\nåœ¨ç»å…¸ç”µåŠ¨åŠ›å­¦ä¸­ï¼Œå¸¦ç”µç²’å­åœ¨ç”µç£åœºä¸­è¿åŠ¨çš„æ‹‰æ ¼æœ—æ—¥é‡å¯ä»¥å†™ä½œ  \n$$\n\\mathcal{L} \\;=\\; -\\,m c^2\\,\\sqrt{1 - v^2/c^2} \\;+\\; q\\,\\mathbf{A}\\cdot\\mathbf{v} \\;-\\; q\\,\\phi,\n$$  \nå…¶ä¸­ $\\mathbf{A}$ æ˜¯çŸ¢åŠ¿ã€$\\phi$ æ˜¯æ ‡åŠ¿ï¼Œ$\\mathbf{v}$ æ˜¯ç²’å­é€Ÿåº¦ï¼Œ$c$ æ˜¯å…‰é€Ÿã€‚ç›¸åº”çš„**å¹¿ä¹‰åŠ¨é‡**(canonical momentum)å®šä¹‰ä¸º  \n$$\n\\mathbf{P} \\;=\\; \\frac{\\partial \\mathcal{L}}{\\partial \\mathbf{v}} \n\\;=\\; \\mathbf{p} + q\\,\\mathbf{A},\n$$  \nå…¶ä¸­  \n$$\n\\mathbf{p} \\;=\\; \\gamma m\\,\\mathbf{v} \n\\quad (\\text{æƒ¯æ€§åŠ¨é‡æˆ–æœºæ¢°åŠ¨é‡}).\n$$  \nå› æ­¤  \n$$\n\\mathbf{p} \\;=\\; \\mathbf{P} \\;-\\; q\\,\\mathbf{A}.\n$$\n\n### ç”µç£åœºä¸­çš„ç‰›é¡¿æ–¹ç¨‹\nå¸¦ç”µç²’å­åœ¨ç”µç£åœºä¸­çš„ç›¸å¯¹è®ºè¿åŠ¨æ–¹ç¨‹(ç‰›é¡¿-æ´›ä¼¦å…¹æ–¹ç¨‹)å¯ä»¥å†™ä½œ  \n$$\n\\frac{d\\mathbf{p}}{dt} \\;=\\; q\\,\\bigl(\\mathbf{E} + \\mathbf{v}\\times\\mathbf{B}\\bigr).\n$$  \nè‹¥ç”¨å¹¿ä¹‰åŠ¨é‡ $\\mathbf{P} = \\mathbf{p} + q\\mathbf{A}$ æ¥è¡¨è¿°ï¼Œåˆ™æœ‰  \n$$\n\\frac{d\\mathbf{P}}{dt} \n\\;=\\; q\\,\\mathbf{E} + q\\,\\frac{d\\mathbf{A}}{dt} \n\\;=\\; q\\bigl(\\mathbf{E} + \\mathbf{v}\\times\\mathbf{B}\\bigr),\n$$  \nå› ä¸º $\\mathbf{E} = -\\,\\nabla \\phi - \\partial_t \\mathbf{A}$ ä¸” $\\mathbf{v}\\times\\mathbf{B}$ ä¹Ÿå¯ä»¥ç”¨ $\\mathbf{A}$ è¡¨ç¤ºã€‚ç»è¿‡ä¸€ç³»åˆ—æ¨å¯¼åï¼Œè‹¥åœ¨æŸäº›æ–¹å‘(æ¯”å¦‚æ¨ªå‘æ–¹å‘ $\\perp$)ä¸Šï¼Œç³»ç»Ÿçš„å¯¹ç§°æ€§æˆ–å¹³ç§»ä¸å˜æ€§ä¿è¯äº†å¯¹è¯¥åˆ†é‡çš„å¹¿ä¹‰åŠ¨é‡å®ˆæ’ï¼Œé‚£ä¹ˆå°±ä¼šå¾—åˆ°  \n$$\n\\frac{d}{dt}(\\mathbf{p}_\\perp + q\\,\\mathbf{A}_\\perp) \\;=\\; 0.\n$$\n\n---\n\n## 2. ä¸ºä½• $\\frac{d}{dt}(\\mathbf{p}_\\perp + q\\,\\mathbf{A}) = 0$ï¼Ÿ\n\nåœ¨æ–‡ä¸­(æ–¹ç¨‹(10b))ï¼Œä½œè€…ç»™å‡ºçš„ç†ç”±æ˜¯ã€Œç”±äºåœ¨ $y$ å’Œ $z$ æ–¹å‘çš„å¹³ç§»ä¸å˜æ€§(translational invariance)ã€ï¼Œå¯¼è‡´æ¨ªå‘å¹¿ä¹‰åŠ¨é‡ä¸éšæ—¶é—´å˜åŒ–ï¼Œå³  \n$$\n\\frac{d}{dt}\\bigl(\\mathbf{p}_\\perp + q\\,\\mathbf{A}\\bigr) = 0.\n$$  \næ¢è¨€ä¹‹ï¼Œåœ¨æ¨ªå‘æ–¹å‘(ç›¸å¯¹äºä¸»ä¼ æ’­æˆ–æµåŠ¨æ–¹å‘)æ²¡æœ‰ç©ºé—´ä¸Šçš„å˜åŒ–æˆ–å¤–åŠ›çš„é¢å¤–ä¾èµ–ï¼Œå› è€Œè¯¥åˆ†é‡çš„å¹¿ä¹‰åŠ¨é‡å®ˆæ’ã€‚  \n\nå¦‚æœä»¤ $\\mathbf{p}_\\perp^0$ è¡¨ç¤º $t < 0$ æ—¶åˆ»(æˆ–â€œåˆå§‹â€)çš„æ¨ªå‘åŠ¨é‡ï¼Œä¸”å½“ $t<0$ æ—¶çŸ¢åŠ¿ $\\mathbf{A} = 0$ï¼Œé‚£ä¹ˆå®ˆæ’é‡å°±æ˜¯  \n$$\n\\mathbf{p}_\\perp^0 + q\\,\\mathbf{A}\\big|_{t<0} \\;=\\; \\mathbf{p}_\\perp^0.\n$$  \nå› ä¸ºå®ˆæ’ï¼Œæ‰€ä»¥åœ¨ $t\\ge 0$ çš„ä»»ä½•æ—¶åˆ»éƒ½æ»¡è¶³  \n$$\n\\mathbf{p}_\\perp(t) + q\\,\\mathbf{A}(t) \\;=\\; \\mathbf{p}_\\perp^0.\n$$  \nä»è€Œå¾—åˆ°  \n$$\n\\mathbf{p}_\\perp(t) \n\\;=\\; \\mathbf{p}_\\perp^0 - q\\,\\mathbf{A}(t).\n$$  \nè¿™æ­£æ˜¯æ–¹ç¨‹(11)çš„ä¸»è¦å½¢å¼ã€‚\n\n---\n\n## 3. åˆå§‹æ¨ªå‘åŠ¨é‡ $\\mathbf{p}_\\perp^0$ çš„ç‰©ç†å«ä¹‰\n\n<!-- ä½œè€…æ¥ä¸‹æ¥åˆå†™é“   -->\n$$\n\\mathbf{p}_\\perp^0 \\;=\\; m\\,\\gamma^0 \\,\\mathbf{v}_\\perp^0 \n\\;=\\; -\\,\\hat{\\mathbf{y}}\\,m\\,c\\,\\tan\\alpha,\n$$  \nè¡¨æ˜æœ€åˆ(æ¯”å¦‚ç­‰ç¦»å­ä½“è¿˜æœªå—åˆ°åç»­åœºä½œç”¨æ—¶ï¼Œ$t<0$)ï¼Œå¸¦ç”µç²’å­åœ¨æ¨ªå‘($\\perp$)æ–¹å‘æœ‰ä¸€ä¸ªåˆå§‹é€Ÿåº¦ $\\mathbf{v}_\\perp^0$ï¼Œå¯¹åº”çš„ç›¸å¯¹è®ºåŠ¨é‡å³  \n$$\n\\mathbf{p}_\\perp^0 = \\gamma^0 m \\mathbf{v}_\\perp^0.\n$$  \nè¿™é‡Œ $\\gamma^0 = 1/\\sqrt{1 - (v_\\perp^0)^2/c^2}$ è¡¨ç¤ºåˆå§‹é€Ÿåº¦å¯¹åº”çš„ç›¸å¯¹è®ºå› å­ã€‚æ–‡ä¸­ä¸¾ä¾‹ç»™å‡ºäº† $\\mathbf{p}_\\perp^0 = -\\,\\hat{\\mathbf{y}}\\,m\\,c\\,\\tan\\alpha$ è¿™æ ·ä¸€ä¸ªå…·ä½“æ•°å€¼ï¼Œè¯´æ˜ç²’å­åˆå§‹æ—¶åœ¨è´Ÿ $y$ æ–¹å‘ä»¥ä¸€å®šé€Ÿåº¦($\\tan\\alpha$ ç›¸å…³)è¿åŠ¨ã€‚\n\n---\n\n## 4. æ€»ç»“æ¨å¯¼è„‰ç»œ\n\n1. **å¹¿ä¹‰åŠ¨é‡å®ˆæ’çš„å…³é”®**ï¼šç”±äºåœ¨æ¨ªå‘æ–¹å‘ä¸Š(è¿™é‡ŒæŒ‡ $y,z$ æˆ–è€…ä½œè€…åªå…³æ³¨æŸä¸ªæ­£äº¤æ–¹å‘)ä¸å­˜åœ¨å¯¹ç²’å­çš„å‡€æ¨åŠ›ï¼Œæˆ–è€…è¯´ç³»ç»Ÿåœ¨è¯¥æ–¹å‘ä¸Šå…·å¤‡å¹³ç§»å¯¹ç§°æ€§ï¼Œå› æ­¤$\\mathbf{p}_\\perp + q\\,\\mathbf{A}$ å®ˆæ’ã€‚  \n2. **åˆå§‹æ¡ä»¶**ï¼š$t<0$ æ—¶ï¼Œ$\\mathbf{A}=0$ï¼Œæ•…åˆå§‹æ—¶åˆ»çš„å¹¿ä¹‰åŠ¨é‡å°±æ˜¯ç²’å­çš„æœºæ¢°åŠ¨é‡ $\\mathbf{p}_\\perp^0$ã€‚  \n3. **éšæ—¶é—´æ¨æ¼”**ï¼šç”±äºå®ˆæ’é‡ä¸å˜ï¼Œå¯å†™å‡º  \n   $$\n   \\mathbf{p}_\\perp(t) + q\\,\\mathbf{A}(t) \n   \\;=\\; \\mathbf{p}_\\perp^0 \n   \\quad\\Longrightarrow\\quad\n   \\mathbf{p}_\\perp(t) \n   \\;=\\; \\mathbf{p}_\\perp^0 - q\\,\\mathbf{A}(t).\n   $$  \n4. **ç›¸å¯¹è®ºåŠ¨é‡è¡¨è¾¾**ï¼š$\\mathbf{p}_\\perp^0 = m\\,\\gamma^0\\,\\mathbf{v}_\\perp^0$ï¼Œå¹¶ä¸”åœ¨å…·ä½“ç‰©ç†æƒ…æ™¯(ä¾‹å¦‚ç­‰ç¦»å­ä½“æµåŠ¨)ä¸­å¯ä»¥ç»™å‡ºé€Ÿåº¦æˆ–åŠ¨é‡çš„æ–¹å‘å’Œå¤§å°ï¼Œå¦‚æ–‡ä¸­çš„ $-\\hat{\\mathbf{y}}\\,m\\,c\\,\\tan\\alpha$ã€‚\n\n<!-- è¿™å°±æ˜¯æ–‡ä¸­æ–¹ç¨‹(10b) å’Œ(11)èƒŒåçš„ä¸»è¦æ¨å¯¼é€»è¾‘ã€‚ -->\nè¦ç‚¹åœ¨äºï¼š  \n- ç”µç£åœºä¸­ï¼Œ**æœºæ¢°åŠ¨é‡** $\\mathbf{p}$ å¹¶éä¸€å®šå®ˆæ’ï¼Œä½†**å¹¿ä¹‰åŠ¨é‡** $\\mathbf{p} + q\\mathbf{A}$ å¯èƒ½ç”±äºå¯¹ç§°æ€§è€Œå®ˆæ’ã€‚  \n- ä¸€æ—¦è®¤å®šåœ¨æŸä¸ªæ–¹å‘ä¸Šæ— å‡€åŠ›(æˆ–åœºç»“æ„å…·å¤‡å¹³ç§»ä¸å˜æ€§)ï¼Œå°±å¯æ–­è¨€é‚£ä¸€æ–¹å‘çš„å¹¿ä¹‰åŠ¨é‡å®ˆæ’ï¼Œä»è€Œå¾—åˆ° $\\mathbf{p}_\\perp = \\mathbf{p}_\\perp^0 - q\\mathbf{A}$ è¿™æ ·çš„å½¢å¼ã€‚  \n- åˆå§‹æ¡ä»¶å†³å®šäº† $\\mathbf{p}_\\perp^0$ çš„å…·ä½“å€¼ï¼Œå†ç»“åˆå®ˆæ’æ–¹ç¨‹å°±èƒ½å¾—åˆ°éšæ—¶é—´æ¼”åŒ–çš„æ¨ªå‘åŠ¨é‡ã€‚"},{"title":"Cloudflare tunnel å†…ç½‘ç©¿é€","url":"/2025/02/02/cloudflare/","content":"\n- https://cloudflared.cn/get-started/create-local-tunnel/\n\nCloudflare å®ç°å†…ç½‘ç©¿é€ä¸»è¦é€šè¿‡å…¶ **Cloudflare Tunnel**ï¼ˆä¹Ÿå« Argo Tunnelï¼‰åŠŸèƒ½æ¥å®ç°ã€‚å®ƒå…è®¸ä½ åœ¨ä¸æš´éœ²å…¬å…± IP çš„æƒ…å†µä¸‹ï¼Œå°†æœ¬åœ°æœåŠ¡å™¨æˆ–åº”ç”¨æš´éœ²åˆ°äº’è”ç½‘ä¸Šï¼Œä»è€Œå®ç°å†…ç½‘ç©¿é€ã€‚ä»¥ä¸‹æ˜¯ Cloudflare Tunnel çš„åŸºæœ¬å·¥ä½œåŸç†å’Œæ­¥éª¤ï¼š\n\n### å·¥ä½œåŸç†ï¼š\n1. **Cloudflare Tunnel** åˆ›å»ºäº†ä¸€ä¸ªä»æœ¬åœ°æœåŠ¡å™¨åˆ° Cloudflare çš„åŠ å¯†éš§é“ã€‚ä½ çš„åº”ç”¨æˆ–æœåŠ¡è¿è¡Œåœ¨å†…ç½‘ä¸­ï¼Œä½†å®ƒé€šè¿‡è¿™ä¸ªéš§é“è¿æ¥åˆ° Cloudflare çš„ç½‘ç»œã€‚\n2. **Cloudflare ç½‘ç»œ** æ¥æ”¶åˆ°æ¥è‡ªç”¨æˆ·è¯·æ±‚çš„æµé‡ï¼Œç„¶åè½¬å‘åˆ°æœ¬åœ°æœåŠ¡å™¨ã€‚\n3. ç”¨æˆ·ä¸æœ¬åœ°æœåŠ¡è¿›è¡Œäº¤äº’æ—¶ï¼Œæ•°æ®æµç»è¿‡åŠ å¯†éš§é“ä¼ è¾“ï¼Œä»è€Œé¿å…äº†æš´éœ²å†…ç½‘ IP åœ°å€å’Œç«¯å£ã€‚\n\n### å®ç°æ­¥éª¤ï¼š\n1. **æ³¨å†Œ Cloudflare è´¦æˆ·å¹¶æ·»åŠ åŸŸåï¼š**\n   - å¦‚æœè¿˜æ²¡æœ‰ Cloudflare è´¦æˆ·ï¼Œé¦–å…ˆå» [Cloudflare å®˜ç½‘](https://www.cloudflare.com) æ³¨å†Œä¸€ä¸ªã€‚\n   - å°†ä½ çš„åŸŸåæ·»åŠ åˆ° Cloudflareï¼Œå¹¶ä¿®æ”¹ DNS è®¾ç½®ï¼ˆå¦‚æœæ˜¯ç°æœ‰åŸŸåï¼‰ã€‚\n\n2. **å®‰è£… Cloudflare Tunnel å®¢æˆ·ç«¯ï¼š**\n   - åœ¨ä½ çš„æœ¬åœ°æœåŠ¡å™¨ä¸Šå®‰è£… `cloudflared` å®¢æˆ·ç«¯ã€‚ä½ å¯ä»¥é€šè¿‡ [Cloudflare çš„å®˜æ–¹æ–‡æ¡£](https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation) äº†è§£è¯¦ç»†çš„å®‰è£…è¿‡ç¨‹ã€‚å¤§è‡´æ­¥éª¤ï¼š\n     - åœ¨ Linux ä¸Šï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š\n       ```bash\n       wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb\n       sudo dpkg -i cloudflared-linux-amd64.deb\n       ```\n       å¯¹äºæ²¡æœ‰sudoæƒé™çš„æ™®é€šç”¨æˆ·\n       ```bash\n       wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64\n       ```\n     - ä¹Ÿå¯ä»¥åœ¨ macOSã€Windows ç­‰å…¶ä»–å¹³å°ä¸Šè¿›è¡Œç±»ä¼¼å®‰è£…ã€‚\n     \n\n3. **è®¤è¯ Cloudflare Tunnelï¼š**\n   - åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè¿›è¡Œè®¤è¯ï¼š\n     ```bash\n     cloudflared tunnel login\n     ```\n   - è¯¥å‘½ä»¤ä¼šæ‰“å¼€ä¸€ä¸ªæµè§ˆå™¨çª—å£ï¼Œè¦æ±‚ä½ ç™»å½•åˆ° Cloudflare è´¦æˆ·å¹¶æˆæƒã€‚\n\n4. **åˆ›å»º Tunnelï¼š**\n   - åˆ›å»ºä¸€ä¸ªæ–°çš„ Tunnelï¼š\n     ```bash\n     cloudflared tunnel create <tunnel-name>\n     ```\n   - è¿™ä¼šç”Ÿæˆä¸€ä¸ªéš§é“ ID å’Œè¯ä¹¦æ–‡ä»¶ã€‚\n\n5. **é…ç½® Tunnel ä»£ç†ï¼š**\n   - è®¾ç½®éš§é“ä»£ç†ï¼Œé€šå¸¸æ˜¯åœ¨æœ¬åœ°åº”ç”¨ç›‘å¬çš„ç«¯å£ä¸Šã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ çš„æœåŠ¡åœ¨ `localhost:8080` ä¸Šè¿è¡Œï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†æµé‡é€šè¿‡éš§é“è½¬å‘ï¼š\n     ```bash\n     cloudflared tunnel --url http://localhost:8080\n     ```\n   - æˆ–è€…ä¹Ÿå¯ä»¥ç›´æ¥æ›´æ”¹é…ç½®æ–‡ä»¶\"~/.cloudflared/config.yml\"\n    ```\n    tunnel: 6bc4c976-1c0c-45a4-bab0-93b7eed4e1d1 # ä½ çš„ Tunnel ID\n    credentials-file: /home/yujq2/.cloudflared/6bc4c976-1c0c-45a4-bab0-93b7eed4e1d1.json\n\n    ingress:\n    - hostname: rentereview.cn\n        service: http://localhost:8080  # ä½ çš„ Web æœåŠ¡ç›‘å¬ç«¯å£\n    - service: http_status:404\n    ```\n   - ç„¶åè¿è¡Œ\n    ```bash\n    cloudflared tunnel run <tunnel-name>\n    ```\n6. **é…ç½® DNS å’Œè·¯ç”±ï¼š**\n   - åœ¨ Cloudflare æ§åˆ¶é¢æ¿ä¸­ï¼Œé…ç½®ä½ çš„ DNS è®¾ç½®ï¼Œå°†åŸŸåæŒ‡å‘ `cloudflare-tunnel`ã€‚\n   - åœ¨ Cloudflare çš„ DNS é…ç½®ä¸­ï¼Œæ·»åŠ ä¸€æ¡ CNAME è®°å½•ï¼Œå°†å­åŸŸï¼ˆä¾‹å¦‚ `tunnel.yourdomain.com`ï¼‰æŒ‡å‘ `tunnel.cloudflare.com`ã€‚\n   - æ€»ç»“ä¸€ä¸‹\n   - åœ¨ Cloudflare æ§åˆ¶é¢æ¿ä¸­ï¼Œé€šè¿‡ DNS è®¾ç½®ï¼Œæ‰‹åŠ¨æ·»åŠ ä¸€ä¸ª CNAME è®°å½•ï¼Œå°†å­åŸŸï¼ˆå¦‚ tunnel.retereview.cnï¼‰æŒ‡å‘ your-tunnel-id.cfargotunnel.comã€‚\n   - ç¡®ä¿ä½ çš„ Cloudflare Tunnel åœ¨æœ¬åœ°å¯åŠ¨å¹¶è¿è¡Œã€‚\n   - ç­‰å¾… DNS è®°å½•ç”Ÿæ•ˆåï¼Œä½ åº”è¯¥å°±å¯ä»¥é€šè¿‡è®¿é—® tunnel.retereview.cn æ¥è®¿é—®ä½ æœ¬åœ°çš„æœåŠ¡äº†ã€‚\n\n   - æˆ–è€…é€šè¿‡cloudflaredç¨‹åºè¿›è¡Œè·¯ç”±\n   ```bash\n   cloudflared tunnel route dns jayzquaz rentereview.cn\n   ```\n   - è¿™å°†æŠŠåŸŸå retereview.cn è·¯ç”±åˆ°åä¸º jayzquaz çš„ Tunnelã€‚\n7. **å¯åŠ¨å’ŒéªŒè¯ï¼š**\n    - è¿è¡Œ Cloudflare Tunnel æœåŠ¡ï¼š\n      ```bash\n      cloudflared tunnel run <tunnel-name>\n      ```\n    - æ­¤æ—¶ï¼Œä½ çš„æœ¬åœ°æœåŠ¡å°±å·²ç»é€šè¿‡ Cloudflare Tunnel æš´éœ²åˆ°äº’è”ç½‘ä¸Šäº†ã€‚\n\n8. **æŒä¹…åŒ–æœåŠ¡ï¼ˆä½¿ç”¨ systemdï¼‰**\n    - ä»¥ä¸Šæ­¥éª¤ä¸­è¿è¡Œ `cloudflared tunnel run` çš„æ–¹å¼åœ¨ç»ˆç«¯é€€å‡ºåå°±ä¼šåœæ­¢ï¼Œä¸ºäº†è®©æœåŠ¡åœ¨åå°æŒç»­è¿è¡Œï¼Œå¯ä»¥ä½¿ç”¨ systemd æ¥ç®¡ç†ã€‚\n\n    **æ–¹æ³•ä¸€ï¼šä½¿ç”¨ systemd åˆ›å»ºæœåŠ¡ï¼ˆæ¨èï¼‰**\n\n    1. åˆ›å»ºæœåŠ¡æ–‡ä»¶\n       ä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨åˆ›å»ºæœåŠ¡æ–‡ä»¶ï¼š\n       ```bash\n       sudo nano /etc/systemd/system/cloudflared-tunnel.service\n       ```\n\n    2. æœåŠ¡æ–‡ä»¶å†…å®¹\n       å°†ä»¥ä¸‹å†…å®¹å¤åˆ¶åˆ°æ–‡ä»¶ä¸­ï¼Œæ³¨æ„æ›¿æ¢ `<tunnel-name>` ä¸ºä½ çš„éš§é“åç§°ï¼š\n       ```\n       [Unit]\n       Description=Cloudflare Tunnel\n       After=network.target\n\n       [Service]\n       Type=simple\n       User=root\n       ExecStart=/usr/local/bin/cloudflared tunnel run <tunnel-name>\n       Restart=always\n       RestartSec=5\n       # å¯é€‰ï¼šè®¾ç½®ç¯å¢ƒå˜é‡\n       Environment=TUNNEL_ORIGIN_CERT=/path/to/cert.pem\n       # å¯é€‰ï¼šæŒ‡å®šé…ç½®æ–‡ä»¶\n       Environment=CLOUDFLARED_CONFIG=/path/to/config.yml\n\n       [Install]\n       WantedBy=multi-user.target\n       ```\n\n    3. å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡\n       ä¾æ¬¡æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\n       ```bash\n       # é‡æ–°åŠ è½½ systemd\n       sudo systemctl daemon-reload\n\n       # å¯ç”¨å¼€æœºè‡ªå¯\n       sudo systemctl enable cloudflared-tunnel.service\n\n       # å¯åŠ¨æœåŠ¡\n       sudo systemctl start cloudflared-tunnel.service\n       ```\n\n       ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥æœåŠ¡çŠ¶æ€å’Œæ—¥å¿—ï¼š\n       ```bash\n       # æ£€æŸ¥çŠ¶æ€\n       sudo systemctl status cloudflared-tunnel.service\n\n       # æŸ¥çœ‹æ—¥å¿—\n       sudo journalctl -u cloudflared-tunnel.service -f\n       ```\n\n9. **å¯ç”¨ \"Always Use HTTPS\" è®¾ç½®**\n    - Cloudflare æä¾›äº†ä¸€ä¸ªéå¸¸ç®€å•çš„æ–¹æ³•æ¥è‡ªåŠ¨å°†æ‰€æœ‰ HTTP æµé‡é‡å®šå‘åˆ° HTTPSï¼šé€šè¿‡ \"Always Use HTTPS\" é€‰é¡¹ã€‚è¿™æ˜¯æœ€ç›´æ¥çš„æ–¹å¼ï¼Œé€‚ç”¨äºå¤§å¤šæ•°åœºæ™¯ã€‚\n\n    - æ“ä½œæ­¥éª¤ï¼š\n    - ç™»å½•åˆ°ä½ çš„ Cloudflare æ§åˆ¶é¢æ¿ã€‚\n    - é€‰æ‹©ä½ è¦é…ç½®çš„åŸŸåã€‚\n    - è¿›å…¥ \"SSL/TLS\" è®¾ç½®é¡µé¢ã€‚\n    - åœ¨é¡µé¢é¡¶éƒ¨ï¼Œç‚¹å‡» \"Edge Certificates\" é€‰é¡¹å¡ã€‚\n    - å‘ä¸‹æ»šåŠ¨ï¼Œæ‰¾åˆ° \"Always Use HTTPS\" è®¾ç½®ã€‚\n    - å¼€å¯è¿™ä¸ªé€‰é¡¹ï¼Œå°†æ‰€æœ‰çš„ HTTP è¯·æ±‚è‡ªåŠ¨é‡å®šå‘åˆ° HTTPSã€‚\n\n### ä¼˜ç‚¹ï¼š\n- **å®‰å…¨æ€§é«˜**ï¼šå†…ç½‘ä¸éœ€è¦æš´éœ²åœ¨å…¬ç½‘ï¼Œåªé€šè¿‡åŠ å¯†éš§é“è¿›è¡Œé€šä¿¡ã€‚\n- **æ— å…¬ç½‘ IP**ï¼šé€‚ç”¨äºæ²¡æœ‰å›ºå®šå…¬ç½‘ IP çš„ç¯å¢ƒã€‚\n- **ç®€åŒ–é…ç½®**ï¼šä¸éœ€è¦å¤æ‚çš„ç«¯å£æ˜ å°„æˆ– NAT é…ç½®ã€‚\n\n### æ³¨æ„ï¼š\n- Cloudflare Tunnel æ˜¯ä¸€ç§åŸºäº Cloudflare çš„æœåŠ¡ï¼Œå› æ­¤éœ€è¦æœ‰ä¸€ä¸ª Cloudflare è´¦æˆ·ï¼Œå¹¶ä¸” DNS éœ€è¦æŒ‡å‘ Cloudflare æ‰èƒ½ä½¿ç”¨ã€‚\n- å¯èƒ½ä¼šæœ‰æµé‡é™åˆ¶æˆ–è´¹ç”¨é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜æµé‡åœºæ™¯ä¸‹ã€‚\n\nè¿™ç§æ–¹å¼çš„å¥½å¤„æ˜¯å¯ä»¥è½»æ¾å®ç°å†…ç½‘ç©¿é€ï¼Œå¹¶ä¸”åˆ©ç”¨ Cloudflare çš„å…¨çƒåŠ é€Ÿå’Œå®‰å…¨é˜²æŠ¤åŠŸèƒ½ï¼Œä½¿ä½ çš„åº”ç”¨æ›´åŠ å¯é å’Œå®‰å…¨ã€‚å¦‚æœæœ‰å…¶ä»–é—®é¢˜ï¼Œæˆ–å¯¹æŸäº›é…ç½®æœ‰ç–‘é—®ï¼Œæ¬¢è¿ç»§ç»­æé—®ï¼\n"},{"title":"CentOS Stream 9 å•èŠ‚ç‚¹ Slurm é›†ç¾¤éƒ¨ç½²æŒ‡å—","url":"/2025/02/02/slurm-server/","content":"\næœ¬æ–‡æä¾› CentOS Stream 9 å•èŠ‚ç‚¹ç¯å¢ƒä¸‹å®‰è£…é…ç½® Slurmï¼ˆå« slurmctld + slurmdï¼‰çš„æ ‡å‡†æµç¨‹ï¼Œé€‚ç”¨äºå¼€å‘ã€æµ‹è¯•åŠå•æœºè°ƒåº¦åœºæ™¯ã€‚\n\n## ä¸€ã€ç¯å¢ƒå‡è®¾ä¸ç›®æ ‡æ¶æ„\n\n### 1. ç¯å¢ƒå‡è®¾\n- æ“ä½œç³»ç»Ÿï¼šCentOS Stream 9ï¼ˆæœ€å°åŒ–æˆ–æ ‡å‡†å®‰è£…ï¼‰\n- ä¸»æœºåï¼šnode1\n- IPï¼š192.168.1.10ï¼ˆç¤ºä¾‹ï¼‰\n- è§’è‰²ï¼š\n  - æ§åˆ¶èŠ‚ç‚¹ï¼ˆControllerï¼‰ï¼šnode1\n  - è®¡ç®—èŠ‚ç‚¹ï¼ˆComputeï¼‰ï¼šnode1\n\n### 2. Slurm ç»„ä»¶\n- slurmctldï¼šæ§åˆ¶å®ˆæŠ¤è¿›ç¨‹\n- slurmdï¼šè®¡ç®—èŠ‚ç‚¹å®ˆæŠ¤è¿›ç¨‹\n- slurmdbdï¼šå•æœºæµ‹è¯•é€šå¸¸ä¸éœ€è¦\n\n## äºŒã€ç³»ç»ŸåŸºç¡€å‡†å¤‡\n\n### 1. è®¾ç½®ä¸»æœºåä¸ hosts\n```bash\nhostnamectl set-hostname node1\ncat >> /etc/hosts <<EOF\n192.168.1.10   node1\nEOF\n```\n\n### 2. å…³é—­é˜²ç«å¢™ï¼ˆæµ‹è¯•ç¯å¢ƒå»ºè®®ï¼‰\n```bash\nsystemctl disable --now firewalld\n```\n\n### 3. å…³é—­ SELinux\n```bash\nsed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config\nsetenforce 0\n```\n\n## ä¸‰ã€å®‰è£… Slurm åŠä¾èµ–\nCentOS 9 å®˜æ–¹ä»“åº“å·²åŒ…å« Slurmï¼Œæ— éœ€è‡ªè¡Œç¼–è¯‘ã€‚\n\n### 1. å®‰è£… EPEL\n```bash\ndnf install -y epel-release\n```\n\n### 2. å®‰è£… Slurm\n```bash\ndnf install -y slurm slurm-slurmd slurm-slurmctld munge\n```\n\n## å››ã€é…ç½® Mungeï¼ˆSlurm è®¤è¯æ ¸å¿ƒï¼‰\nSlurm å¼ºä¾èµ– munge è¿›è¡ŒèŠ‚ç‚¹è®¤è¯ã€‚\n\n### 1. åˆ›å»º munge key\n```bash\n/usr/sbin/create-munge-key\n```\n\n### 2. è®¾ç½®æƒé™\n```bash\nchown -R munge:munge /etc/munge /var/lib/munge /var/log/munge\nchmod 400 /etc/munge/munge.key\n```\n\n### 3. å¯åŠ¨ munge\n```bash\nsystemctl enable --now munge\n```\n\n### 4. éªŒè¯ munge\n```bash\nmunge -n | unmunge\n```\næ­£å¸¸åº”çœ‹åˆ°ï¼š\n```\nSTATUS:          Success (0)\n```\n\n## äº”ã€åˆ›å»º Slurm ç”¨æˆ·ä¸ç›®å½•\n\n### 1. åˆ›å»º slurm ç”¨æˆ·\n```bash\nuseradd -r -s /sbin/nologin slurm\n```\n\n### 2. åˆ›å»ºå¿…è¦ç›®å½•\n```bash\nmkdir -p /var/spool/slurm/{ctld,d}\nmkdir -p /var/log/slurm\nchown -R slurm:slurm /var/spool/slurm /var/log/slurm\n```\n\n## å…­ã€é…ç½® slurm.confï¼ˆæ ¸å¿ƒï¼‰\n\n### 1. ç”ŸæˆåŸºç¡€æ¨¡æ¿\n```bash\ncp /etc/slurm/slurm.conf.example /etc/slurm/slurm.conf\n```\n\n### 2. ç¼–è¾‘ /etc/slurm/slurm.conf\næœ€å°å¯ç”¨å•æœºé…ç½®ç¤ºä¾‹ï¼š\n\nslurm.conf ç¤ºä¾‹ï¼š\n```conf\n############################\n# åŸºæœ¬é›†ç¾¤ä¿¡æ¯\n############################\nClusterName=single_cluster\nSlurmctldHost=node1(127.0.0.1)\nSlurmUser=slurm\nSlurmdUser=root\n\n############################\n# ç«¯å£\n############################\nSlurmctldPort=6817\nSlurmdPort=6818\n\n############################\n# çŠ¶æ€ä¸æ—¥å¿—\n############################\nStateSaveLocation=/var/spool/slurm/ctld\nSlurmdSpoolDir=/var/spool/slurm/d\nSlurmctldLogFile=/var/log/slurm/slurmctld.log\nSlurmdLogFile=/var/log/slurm/slurmd.log\n\n############################\n# è®¤è¯\n############################\nAuthType=auth/munge\nCryptoType=crypto/munge\n\n############################\n# è°ƒåº¦å™¨\n############################\nSchedulerType=sched/backfill\nSchedulerParameters=bf_continue,bf_interval=30\n\n############################\n# èµ„æºé€‰æ‹©ï¼ˆå…³é”®ï¼‰\n############################\nSelectType=select/cons_res\nSelectTypeParameters=CR_Core_Memory\n\n############################\n# cgroupï¼ˆç”Ÿäº§å¿…å¼€ï¼‰\n############################\nProctrackType=proctrack/cgroup\nTaskPlugin=task/cgroup\n# TaskPluginParam=Sched\nJobAcctGatherType=jobacct_gather/cgroup\n\n############################\n# è¿›ç¨‹è·Ÿè¸ª / æ¸…ç†\n############################\nKillOnBadExit=1\nReturnToService=2\n\n############################\n# è¶…æ—¶\n############################\nSlurmctldTimeout=300\nSlurmdTimeout=300\n\n############################\n# èŠ‚ç‚¹å®šä¹‰ï¼ˆæŒ‰çœŸå®èµ„æºï¼‰\n############################\nNodeName=node1 \\\n  CPUs=56 \\\n  RealMemory=128027 \\\n  Sockets=2 \\\n  CoresPerSocket=28 \\\n  ThreadsPerCore=1 \\\n  Gres=gpu:V100:8 \\\n  State=UNKNOWN\n\nGresTypes=gpu\n\n############################\n# åˆ†åŒºå®šä¹‰\n############################\nPartitionName=debug \\\n  Nodes=node1 \\\n  Default=YES \\\n  MaxTime=1:00:00 \\\n  State=UP\n\nPartitionName=normal \\\n  Nodes=node1 \\\n  MaxTime=7-00:00:00 \\\n  State=UP\n```\n\ncgroup.conf ç¤ºä¾‹ï¼š\n\n```conf\n###\n#\n# Slurm cgroup support configuration file\n#\n# See man slurm.conf and man cgroup.conf for further\n# information on cgroup configuration parameters\n#--\nCgroupMountpoint=/sys/fs/cgroup\nCgroupAutomount=yes\n\nConstrainCores=yes\nConstrainRAMSpace=yes\nConstrainSwapSpace=yes\nConstrainDevices=yes\n\nAllowedRAMSpace=100\nAllowedSwapSpace=0\n\nMaxRAMPercent=98\nMaxSwapPercent=0\n\nMinRAMSpace=30\n```\n\n**æ³¨æ„**ï¼š\n- `CPUs` å’Œ `RealMemory` æ ¹æ® `lscpu`ã€`free -m` å®é™…è°ƒæ•´\n- `NodeName` å¿…é¡»ä¸ hostname å®Œå…¨ä¸€è‡´\n\n## ä¸ƒã€å¯åŠ¨ Slurm æœåŠ¡\n\n### 1. å¯åŠ¨ slurmctld\n```bash\nsystemctl enable --now slurmctld\n```\n\n### 2. å¯åŠ¨ slurmd\n```bash\nsystemctl enable --now slurmd\n```\n\n## å…«ã€éªŒè¯ Slurm çŠ¶æ€\n\n### 1. æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€\n```bash\nsinfo\n```\næœŸæœ›è¾“å‡ºï¼š\n```\nPARTITION AVAIL  TIMELIMIT  NODES  STATE NODELIST\ndebug        up   infinite      1   idle node1\n```\n\n### 2. æŸ¥çœ‹èŠ‚ç‚¹è¯¦æƒ…\n```bash\nscontrol show node node1\n```\n\n## ä¹ã€æäº¤æµ‹è¯•ä»»åŠ¡\n\n### 1. äº¤äº’å¼ä»»åŠ¡\n```bash\nsrun -n 1 hostname\n```\n\n### 2. æ‰¹å¤„ç†ä»»åŠ¡\n```bash\ncat > test.sh <<EOF\n#!/bin/bash\n#SBATCH -n 1\n#SBATCH -o test.out\n\nhostname\nsleep 10\nEOF\n\nsbatch test.sh\n```\n\næŸ¥çœ‹ä»»åŠ¡ï¼š\n```bash\nsqueue\n```\n\n## åã€å¸¸è§é—®é¢˜æ’æŸ¥\n\n### 1. èŠ‚ç‚¹çŠ¶æ€ä¸º DOWN\n```bash\nscontrol update NodeName=node1 State=RESUME\n```\n\n### 2. æŸ¥çœ‹æ—¥å¿—\n```bash\njournalctl -u slurmctld -f\njournalctl -u slurmd -f\n```\n\n### 3. Munge é”™è¯¯\n- ç¡®è®¤ munge æ­£åœ¨è¿è¡Œ\n- `/etc/munge/munge.key` æƒé™å¿…é¡»æ˜¯ 400\n\n## åä¸€ã€slurmdbd éœ€æ±‚åˆ†æ\n\n| åœºæ™¯             | æ˜¯å¦éœ€è¦ |\n|------------------|----------|\n| å•æœºæµ‹è¯•         | å¦       |\n| ä½œä¸šè®¡è´¹/ç»Ÿè®¡    | æ˜¯       |\n| å¤šç”¨æˆ·å®¡è®¡       | æ˜¯       |\n\nå¦‚éœ€ä»¥ä¸‹æ‰©å±•é…ç½®ï¼Œè¯·è¯´æ˜ä½¿ç”¨åœºæ™¯ï¼š\n- CentOS 9 + slurmdbd + MariaDB é…ç½®\n- GPUï¼ˆNVIDIAï¼‰èŠ‚ç‚¹é…ç½®\n- cgroup èµ„æºéš”ç¦»è¯¦ç»†é…ç½®\n- å¤šèŠ‚ç‚¹é›†ç¾¤æ‰©å±•æ–¹æ¡ˆ\n\n## åäºŒã€GPU é…ç½®ï¼ˆV100 ç¤ºä¾‹ï¼‰\n\n### 1. ç¡®è®¤ GPU è®¾å¤‡\n```bash\nls -l /dev/nvidia*\n```\nè¾“å‡ºç¤ºä¾‹ï¼š\n```\n/dev/nvidia0\n/dev/nvidia1\n/dev/nvidiactl\n/dev/nvidia-uvm\n```\n\n### 2. é…ç½® gres.conf\n```bash\nvi /etc/slurm/gres.conf\n```\nç¤ºä¾‹ï¼ˆ2 Ã— V100ï¼‰ï¼š\n```conf\nNodeName=node1 Name=gpu Type=V100 File=/dev/nvidia0\nNodeName=node1 Name=gpu Type=V100 File=/dev/nvidia1\n```\n\n**è¦ç‚¹**ï¼š\n- `Type=V100` æ˜¯ `--gres=gpu:V100:x` å‚æ•°çš„å…³é”®\n- `NodeName` å¿…é¡»å’Œ slurm.conf å®Œå…¨ä¸€è‡´\n\n### 3. ä¿®æ”¹ slurm.conf\nåœ¨èŠ‚ç‚¹å®šä¹‰ä¸­æ·»åŠ  GPU èµ„æºï¼š\n```conf\nNodeName=node1 \\\n  CPUs=64 \\\n  RealMemory=125000 \\\n  Gres=gpu:V100:2 \\\n  State=UNKNOWN\n```\n\n### 4. å¯ç”¨ GPU éš”ç¦»\nç¡®è®¤ `/etc/slurm/cgroup.conf` åŒ…å«ï¼š\n```conf\nConstrainDevices=yes\n```\n**é‡è¦**ï¼šæœªå¯ç”¨éš”ç¦»ä¼šå¯¼è‡´æ‰€æœ‰ä½œä¸šéƒ½èƒ½è®¿é—®å…¨éƒ¨ GPU\n\n### 5. é‡å¯æœåŠ¡\n```bash\nsystemctl restart slurmctld slurmd\n```\n\n## åä¸‰ã€GPU åŠŸèƒ½éªŒè¯\n\n### 1. æŸ¥çœ‹èŠ‚ç‚¹èµ„æº\n```bash\nscontrol show node node1\n```\nåº”åŒ…å«ï¼š\n```\nGres=gpu:V100:2\nGresUsed=0\n```\n\n### 2. æŸ¥çœ‹ GPU è§†å›¾\n```bash\nsinfo -o \"%N %G\"\n```\nè¾“å‡ºç¤ºä¾‹ï¼š\n```\nnode1 gpu:V100:2\n```\n\n## åå››ã€GPU ä½œä¸šç¤ºä¾‹\n\n### 1. äº¤äº’å¼ä»»åŠ¡ï¼ˆå• GPUï¼‰\n```bash\nsrun --gres=gpu:V100:1 --pty bash\nnvidia-smi  # åº”åªçœ‹åˆ°1å¼ GPU\n```\n\n### 2. æ‰¹å¤„ç†ä»»åŠ¡\n```bash\ncat > gpu_test.sh <<'EOF'\n#!/bin/bash\n#SBATCH -J gpu_test\n#SBATCH --gres=gpu:V100:1\n#SBATCH --cpus-per-task=4\n#SBATCH --mem=16G\n#SBATCH -o gpu_test.out\n\nnvidia-smi\nsleep 30\nEOF\n\nsbatch gpu_test.sh\n```\n\n### 3. å¤š GPU ä»»åŠ¡\n```bash\nsrun --gres=gpu:V100:2 --pty bash\n```\n\n## åäº”ã€å¸¸è§ GPU é—®é¢˜\n\n### âŒ ä½œä¸šå†…èƒ½çœ‹åˆ°æ‰€æœ‰ GPU\n**åŸå› **ï¼š\n- `ConstrainDevices=no`\n- æœªä½¿ç”¨ `task/cgroup`\n\n**ä¿®å¤**ï¼š\n```conf\nConstrainDevices=yes\nTaskPlugin=task/cgroup\n```\n\n### âŒ æäº¤ GPU ä½œä¸šä¸€ç›´æ’é˜Ÿ\n```bash\nsqueue\nscontrol show job <jobid>\n```\n**å¸¸è§åŸå› **ï¼š\n- GPU å·²è¢«å ç”¨\n- è¯·æ±‚çš„ GPU ç±»å‹é”™è¯¯ï¼ˆå¦‚å†™æˆ A100ï¼‰\n\n### âŒ GPU è§„æ ¼æŒ‡å®šå·®å¼‚\n| å†™æ³•                | è¡Œä¸º         |\n|---------------------|--------------|\n| `--gres=gpu:1`      | ä½¿ç”¨ä»»æ„ GPU |\n| `--gres=gpu:V100:1` | ä»…ä½¿ç”¨ V100  |\n\nç”Ÿäº§ç¯å¢ƒå»ºè®®å§‹ç»ˆæŒ‡å®š GPU ç±»å‹\n\n## åå…­ã€ç”Ÿäº§ç¯å¢ƒå»ºè®®\n\n### 1. èµ„æºé™åˆ¶\nåœ¨åˆ†åŒºé…ç½®ä¸­æ·»åŠ ï¼š\n```conf\nDefMemPerGPU=32000  # æ¯GPUåˆ†é…32GBå†…å­˜\n```\né¿å… GPU ä½œä¸šæŠ¢å å…¨éƒ¨å†…å­˜\n\n### 2. èŠ‚ç‚¹éš”ç¦»\næœªæ¥æ‰©å±•å¤šèŠ‚ç‚¹æ—¶ï¼Œä½¿ç”¨ç‹¬ç«‹åˆ†åŒºåŒºåˆ† GPU/CPU èŠ‚ç‚¹\n\n## æ€»ç»“\nV100 GPU çš„é…ç½®éœ€è¦åŒæ—¶æ»¡è¶³ï¼š\n1. æ­£ç¡®çš„ `gres.conf` å®šä¹‰\n2. `slurm.conf` ä¸­çš„èµ„æºå£°æ˜\n3. `cgroup.conf` çš„è®¾å¤‡éš”ç¦»\n\næ ¹æ®éœ€æ±‚å¯è¿›ä¸€æ­¥é…ç½®ï¼š\n- MIG / å¤š GPU æ··åˆè°ƒåº¦\n- GPU + CPU ç»‘æ ¸ï¼ˆNUMA äº²å’Œï¼‰\n- GPU åˆ†åŒº / QOS\n- å¤šç”¨æˆ· GPU è®¡è´¹","tags":["Slurm","HPC","é›†ç¾¤ç®¡ç†"]},{"title":"Subtreeä»“åº“æ·»åŠ ","url":"/2025/02/02/subtree/","content":"\n## Step 1\nåˆå§‹åŒ–gitä»“åº“\ngit init\næ·»åŠ README.mdæ–‡ä»¶\ngit add .\ngit commit -m \"Init\"\n\n## Step 2\næ·»åŠ git subtreeä»“åº“\ngit remote add label <git-url>\ngit fetch label\ngit add subtree --prefix=<path> label/<branch>\n"},{"title":"PICæ¨¡æ‹Ÿåå¤„ç†","url":"/2025/02/02/postpic/","content":"\n## PICæ¨¡æ‹Ÿåå¤„ç†è½¯ä»¶\n\n#### postpic\nåœ°å€https://github.com/skuschel/postpic.git\nç¤ºä¾‹https://github.com/skuschel/postpic-examples.git\n\n\n#### VisualPIC\nå¯è§†åŒ–GUIç¨‹åºhttps://github.com/AngelFP/VisualPIC.git@dev\n\n#### PICViewer\nPICViewer is a visualization GUI implemented on PyQt. \ndependency\n```\nhttps://github.com/yt-project/yt.git\n```\n\nInstall\n```\nhttps://bitbucket.org/ecp_warpx/picviewer/\n```"},{"title":"è®¡ç®—è¾å°„ç‰©ç†","url":"/2023/08/10/computation/","content":"\n# ComputationalRadiationPhysics\n\n## Opticspy\n\n Optics diffraction calculation.\n\nhttps://github.com/opticspy/lightpipes.git\n\n## Clara2\n\nClara2 - a parallel classical radiation calculator based on LiÃ©nard-Wiechert potentials.\n\nhttps://github.com/ComputationalRadiationPhysics/clara2\n\n## PIConGPU\n\nPerformance-Portable Particle-in-Cell Simulations for the Exascale Era.\n\nhttps://github.com/ComputationalRadiationPhysics/picongpu.git\n\n## Meep\n\nfree finite-difference time-domain (FDTD) software for electromagnetic simulations\n\nhttps://github.com/NanoComp/meep.git\n\nand MIT Photonic-Bands: computation of photonic band structures in periodic media\n\nhttps://github.com/NanoComp/mpb.git\n\n## GVF\n\nGradient Vector Flow in Python based on the work of [Chenyang Xu and Jerry Prince](http://www.iacl.ece.jhu.edu/static/gvf/).\n\nGradient Vector Flow in 3D based on the work of [Erik Smistad](https://www.eriksmistad.no/3d-gradient-vector-flow-matlab-implementation/).\n\nhttps://github.com/Christophe-Foyer/GVF-Python.git"},{"title":"æœºå™¨å­¦ä¹ èµ„æº","url":"/2023/08/10/datascience/","content":"\n## æ•°æ®åˆ†æå…¥é—¨\n\nhttps://github.com/apachecn/pyda-2e-zh.git\n\n## Twitterç®—æ³•\n\nhttps://github.com/twitter/the-algorithm.git\n\n## Data Scienceç¬”è®°\n\nhttps://github.com/fengdu78/Data-Science-Notes\n\n## Machine Learningç¬”è®°\n\nå´æ©è¾¾Machine learningç¬”è®°ã€‚\n\nhttps://github.com/fengdu78/Coursera-ML-AndrewNg-Notes.git\n\n## 100-Day-Machine-Learning\n\n100-Days-Of-ML-Codeä¸­æ–‡ç‰ˆ\n\nhttps://github.com/MLEveryday/100-Days-Of-ML-Code.git\n\n## Deep Learning Book\n\nDeep Learning Book Chinese onlineï¼š https://exacity.github.io/deeplearningbook-chinese/Chapter1_introduction/\n\nSource Codeï¼š https://github.com/exacity/deeplearningbook-chinese.git\n\n## Huawei æ‹æœˆäº®\n\nhttps://github.com/zhazhajust/Learning-to-See-in-the-Dark.git\n\n## GPT2.0\n\nåŸºäºå¼€æºGPT2.0çš„åˆä»£åˆ›ä½œå‹äººå·¥æ™ºèƒ½ | å¯æ‰©å±•ã€å¯è¿›åŒ–\n\nhttps://github.com/EssayKillerBrain/WriteGPT.git\n\n## Full Stack\n\nğŸš€ fullstack tutorial 2022ï¼Œåå°æŠ€æœ¯æ ˆ/æ¶æ„å¸ˆä¹‹è·¯/å…¨æ ˆå¼€å‘ç¤¾åŒºï¼Œæ˜¥æ‹›/ç§‹æ‹›/æ ¡æ‹›/é¢è¯•ã€‚\n\nhttps://github.com/frank-lam/fullstack-tutorial.git\n\n## Java\n\n21å¤©å­¦ä¼šJAVA\n\nhttps://github.com/DuGuQiuBai/Java.git"},{"title":"è¿œç¨‹è¿æ¥ä¸å”¤é†’","url":"/2023/08/10/remote/","content":"\n## ç®€ä»‹\n\né¦–å…ˆå‡†å¤‡å¥½å…¬ç½‘ipv4 or ipv6ï¼Œä½¿ç”¨ddns-goç»‘å®šåŠ¨æ€ipåœ°å€åˆ°dnsæœåŠ¡å™¨ï¼ˆé™æ€ipä¸éœ€è¦ï¼‰ï¼Œæ­¤æ—¶å¯ã€‚éšåè¿è¡ŒWolGoWebæœåŠ¡ï¼Œå³å¯ä½¿ç”¨urlè¿›è¡Œè¿œç¨‹å”¤é†’ã€‚\n\n## dynv6\n\nä½¿ç”¨ https://dynv6.com è¿›è¡ŒåŠ¨æ€åŸŸåè§£æï¼Œç»‘å®šipv6äºè‡ªå®šä¹‰åŸŸå https://xxx.dynv6.net ã€‚\n\n## ddns-go\n\nç®€å•å¥½ç”¨çš„DDNSã€‚è‡ªåŠ¨æ›´æ–°åŸŸåè§£æåˆ°å…¬ç½‘IP(æ”¯æŒé˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€Dnspodã€Cloudflareã€Callbackã€åä¸ºäº‘ã€ç™¾åº¦äº‘ã€Porkbunã€GoDaddyã€Google Domain)\n\nhttps://github.com/jeessy2/ddns-go.git\n\næ­¤æ—¶ï¼Œipv6å·²è§£æäºddnsæœåŠ¡å™¨ï¼Œé€šè¿‡è‡ªå®šä¹‰urlå¯ä»¥é€šè¿‡è¿œç¨‹è¿æ¥è½¯ä»¶å¦‚rdpã€moonlightã€parsecç­‰ç›´æ¥è®¿é—®ã€‚\n\n## WolGoWeb\n\nåŸºäºGolangçš„WebæœåŠ¡å™¨ï¼Œä½¿ç”¨urlé“¾æ¥å³å¯å‘èµ·wake on lanå±€åŸŸç½‘å”¤é†’ã€‚\n\nhttps://github.com/zhazhajust/WolGoWeb.git\n\nç„¶åæµ‹è¯•urlå”¤é†’ï¼Œåœ¨æµè§ˆå™¨è¾“å…¥ http://xxx:9090/wol?mac=00-00-00-00-00-00 ï¼ˆç½‘å¡MACåœ°å€ï¼‰ã€‚\n\n## Wake On Lan GUI ç¨‹åºï¼ˆOptionalï¼‰\nhttps://github.com/basildane/WakeOnLAN.git\n\n### å‚è€ƒæ–‡çŒ®\n\nhttps://www.jianshu.com/p/6622c33f4cd3\n\nhttps://zhouym.tech/2022/Wake-On-Lan/\n"},{"title":"è¿œç¨‹è¿æ¥ä¸å”¤é†’","url":"/2023/08/10/vtk/","content":"\n# VTK and Paraview\n\nvtk examples:\nhttps://examples.vtk.org/site/Python/IO/WriteXMLLinearCells/\n\nsource:\nhttps://github.com/Kitware/vtk-examples"},{"title":"Frequency moved undulator","url":"/2022/09/15/undulator/","content":"\n## Smilei or EPOCH\n\nMark the oscillate electrons, and save the field produced by them. Then sparated them from the total electric field and save to a new file.\n\n## å…‰æ³¢è¡å™¨æ¨å¯¼\n\nå‡è®¾å¹³é¢æ³¢æ¿€å…‰æ–¹å‘ä¸º$\\hat k = \\frac{\\mathbf{k}}{k_L}$ï¼Œåˆ™ $B = \\frac{(\\hat k \\times E)}{c}$ï¼Œç”µå­åœ¨æ¿€å…‰åœºä¸­è¿åŠ¨æ–¹ç¨‹å†™ä¸ºï¼š\n\n$$\n\\frac{d}{dt}(\\gamma mc \\beta) = -e(E + v \\times B)\n$$\n\n$$\n\\frac{d}{dt}(\\gamma mc \\beta) = -e[E + \\beta \\times (\\hat k \\times E)] = -e[E + (\\beta \\cdot E)\\hat k - (\\beta \\cdot \\hat k)E]\n$$\n\næˆ‘ä»¬å‡è®¾æ¿€å…‰æ²¿ç€xæ–¹å‘åæŒ¯ï¼Œ$E = E_0 \\sin(\\omega_Lt âˆ’ k \\cdot x)\\hat x$ï¼Œæ²¿ç€zæ–¹å‘ä¼ æ’­ï¼Œä¸zè½´å‘ˆå¤¹è§’$\\varphi$ï¼Œæ³¢çŸ¢$k = k_L(0, -\\sin \\varphi, +\\cos \\varphi)$ï¼Œå¹¶ä¸” $\\omega_L = ck_L$ã€‚è¿åŠ¨æ–¹ç¨‹å†™ä¸ºï¼š\n\n$$\n\\frac{d}{dt}(\\gamma mc \\beta) = -eE_0\\sin(ck_Lt - \\mathbf{k} \\cdot x)[1 - (\\hat k \\cdot \\beta)] = \\frac{eE_0}{ck_L}\\frac{d}{dt}\\cos(ck_Lt - \\mathbf{k} \\cdot x)\n$$\n\næ–¹ç¨‹è¡¨æ˜æ°´å¹³æ–¹å‘åŠ¨é‡å®ˆæ’ï¼Œé€šè¿‡ç§¯åˆ†å¯ä»¥å¾ˆå®¹æ˜“å¾—å‡ºï¼Œ\n\n$$\n\\beta_x = \\frac{eE_0}{\\gamma mc^2k_L}\\cos(ck_Lt - \\mathbf{k}\\cdot x)\n$$\n\næ³¢è¡å™¨å‚æ•°ä¸º$K = \\frac{eE_0}{mc^2k_L}$ï¼Œå¯¹äºUndulatorï¼Œ $K<<1$ï¼Œ$t \\approx c/\\beta_z$ï¼Œæ¨ªå‘æŒ¯åŠ¨é€Ÿåº¦ä¸º$\\cos(k_L(1/\\overline{\\beta}_z - \\cos\\varphi)z + k_Ly\\sin\\varphi)$ï¼Œåˆ™æ³¢è¡å™¨å‘¨æœŸä¸ºï¼š\n\n$$\n\\lambda_u \\rightarrow \\frac{\\overline{\\beta}_z\\lambda_L}{1 - \\overline{\\beta}_z\\cos\\varphi}\n$$\n\nå°†æ³¢è¡å™¨å‘¨æœŸå’Œå‚æ•°Kå¸¦å…¥æ³¢è¡å™¨è¾å°„å…¬å¼,\n\n$$\n\\frac{\\lambda_1(\\phi)}{c} = \\frac{\\lambda_u}{c}[\\frac{1 + K^2/(4\\gamma^2)}{\\beta} - (1 - \\frac{\\phi^2}{2})] \\approx \\frac{\\lambda_u}{c}\\frac{1 + K^2/2 + \\gamma^2\\phi^2}{2\\gamma^2}\n$$\n\nåŒæ­¥è¾å°„å…±æŒ¯æ³¢é•¿ä¸º\n\n$$\n\\lambda = \\frac{1 + K^2/2}{2\\gamma^2}\\frac{\\lambda_L}{1 - \\overline{\\beta}_z\\cos\\varphi}\n$$\n\nå½“æ»¡è¶³$\\varphi \\rightarrow 0, K << 1$(undulatorçš„å‡è®¾)æ—¶\n\n$$\n\\lambda \\rightarrow \\lambda_L\n$$\n\n## æ—¶é—´æ”¶ç¼©æ•ˆåº”\n\nå‡è®¾$t^{'}$ä¸ºç²’å­é™æ­¢åæ ‡ç³»ï¼Œåˆ™ $1 - \\beta(t^{'})\\cos\\phi(t^{'})$ ä¸ºæ—¶é—´æ”¶ç¼©å› å­ï¼Œå¯¹äºç›¸å¯¹è®ºç”µå­ï¼Œ\n\n$$\n\\beta = \\sqrt{1 - \\frac{1}{\\gamma^2}} \\approx 1 - \\frac{1}{1\\gamma^2}\n$$\n\nå¯¹äº$\\gamma >> 1$ï¼Œ$\\phi << 1$\n\n$$\n1 - \\beta \\cos\\phi \\approx \\frac{1}{2}(\\frac{1}{\\gamma^2} + \\phi^2)\n$$"},{"title":"å¤ªèµ«å…¹é¬¼æˆåƒ","url":"/2022/08/17/numerical/","content":"\n# åå¾®åˆ†æ–¹ç¨‹æ±‚è§£\n\nå¯¹äºæ³¢åŠ¨æ–¹ç¨‹ç­‰åå¾®åˆ†æ–¹ç¨‹ï¼Œéš¾ä»¥ç›´æ¥æ±‚è§£æè§£ï¼Œä¸€èˆ¬é‡‡ç”¨æ•°å€¼æ–¹æ³•æ±‚è§£ã€‚ç›®å‰ç”µç£å­¦ä¸»è¦é€šè¿‡æœ‰é™å…ƒæ³•ï¼ˆFEMï¼‰ï¼ˆé€šè¿‡Galerkinæ³•åŸºå‡½æ•°åˆ†è§£ï¼‰ã€æœ‰é™æ—¶åŸŸå·®åˆ†æ³•ï¼ˆFDTDï¼‰ã€çŸ©é‡æ³•ï¼ˆMoMï¼‰ç­‰è¿›è¡Œæ•°å€¼æ¨¡æ‹Ÿã€‚å¯¹äºæ›´ä¸€èˆ¬çš„åå¾®åˆ†æ–¹ç¨‹æ±‚è§£æ–¹æ³•ï¼Œè¿™é‡Œä»‹ç»Method of Linesæ–¹æ³•æ±‚è§£ã€‚\n\n## Method of Lines\n\nMethod of Linesæ˜¯æ±‚è§£åå¾®åˆ†æ–¹ç¨‹çš„ä¸€ç§é€šç”¨è®¡ç®—æ–¹æ³•ã€‚Method of Linesæ–¹æ³•é€šè¿‡ç©ºé—´ç¦»æ•£ï¼Œå°†åå¾®åˆ†æ–¹ç¨‹è½¬åŒ–ä¸ºå¸¸å¾®åˆ†æ–¹ç¨‹ç»„ODEsï¼Œåç»­é€šè¿‡Eularæ³•ï¼Œéšå¼æ¬§æ‹‰æ³•ï¼ˆç‰›é¡¿è¿­ä»£ã€ä¸åŠ¨ç‚¹æ³•ï¼‰ç­‰æ±‚è§£ã€‚\n\n## åŸºæœ¬æ¡ˆä¾‹\n\nä¾‹ï¼šæ±‚è§£æ‰©æ•£æ–¹ç¨‹\n\n$$\n\\frac{\\partial u}{\\partial t} = D\\frac{\\partial^2 u}{\\partial x^2}\n$$\n\nå°†$D\\frac{\\partial^2}{\\partial x^2}$ç¦»æ•£åŒ–ä¸ºçŸ©é˜µ$A$ï¼Œå°†$\\frac{d}{dt}U$å†™ä¸º$\\dot U$ï¼Œä½¿ç”¨çŸ©é˜µå½¢å¼è¡¨ç¤ºä¸º$\\dot U = AU$ã€‚\n\n\nä¾‹å¦‚$\\frac{du_i}{dt} = -v\\frac{du}{dx}$\næ–¹ç¨‹è½¬åŒ–ä¸º$\\frac{du_i}{dt} = -v\\frac{(u_i - u_{i-1})}{\\delta x}, 1 \\leq i \\leq M$ï¼Œå†è½¬åŒ–ä¸ºçŸ©é˜µå½¢å¼ã€‚\n\n## forward eular\n\nè®²çŸ©é˜µä¹˜ç§¯å†™ä¸ºå‡½æ•°å½¢å¼\n$$\n\\dot U = F(U)\n$$\nåˆ™å¯ä½¿ç”¨å‰å‘æ¬§æ‹‰æ³•è¿›è¡Œæ±‚è§£\n$$\nU_{k+1} = U_k + \\delta tF(U_k)\n$$\n\n## RKæ–¹æ³•\n\né¾™æ ¼åº“å¡”æ–¹æ³•æ˜¾å¼æ±‚è§£Method of Lineså¾—åˆ°çš„ODEsï¼Œå¯ä»¥å¾—åˆ°æ›´é«˜ç²¾åº¦çš„è§£ã€‚\n\nç§¯åˆ†ä¸­å€¼å®šç†å¯ä»¥å¾—å‡º\n$$\nU(t + \\delta t) = U(t) + \\delta tF(U(t + \\frac{1}{2}\\delta t)) + O(\\delta t^3)\n$$\n\né¾™æ ¼åº“å¡”æ³•é€šè¿‡é¢„æµ‹$U(t + \\frac{1}{2}\\delta t)$æ¥ä½¿ç”¨å‰å‘æ¬§æ‹‰æ³•\n$$\n\\widetilde U_{k+\\frac{1}{2}} = U_k + \\frac{\\delta t}{2}F(U_k)\n$$\n\n$$\nU_{k+1} = U_k + \\delta tF(\\widetilde U_{k+\\frac{1}{2}})\n$$\n\nè¿™æ˜¯ä¸€ç§ä¸¤é˜¶æ®µæ–¹æ³•ã€‚ç¬¬ä¸€é˜¶æ®µé¢„æµ‹ä¸­ç‚¹å€¼ï¼Œç¬¬äºŒé˜¶æ®µï¼Œå³æ ¡æ­£é˜¶æ®µï¼Œä½¿ç”¨é¢„æµ‹çš„ä¸­ç‚¹å€¼è¿›è¡Œæ—¶é—´æ­¥è¿›ã€‚"},{"title":"ç‰›é¡¿è¿­ä»£æ³•éšå¼æ¬§æ‹‰æ³•æ±‚è§£å¾®åˆ†æ–¹ç¨‹","url":"/2022/08/16/NewtonMethod/","content":"\n# ç‰›é¡¿è¿­ä»£æ³•æ±‚è§£ODE\n\né¦–å…ˆæ ¹æ® \\(\\frac{dy}{dx} = f(x, y)\\) æ„å»º \\(F(x, y) = 0\\)ï¼Œç„¶åæ±‚è§£\\(F(x, y)\\)å¯¹\\(y\\)çš„å¯¼æ•°ï¼Œç„¶åè¿­ä»£æ±‚è§£é›¶ç‚¹è¯¯å·® \\(\\text{abs}(F(x, y) - F(x, \\text{next}_y))\\) æœ€å°å¤„çš„\\(y\\)ï¼Œå°†\\(\\text{next}_y\\)ä½œä¸º\\(y\\)å¸¦å…¥ä¸‹ä¸€ä¸ªé€’å½’ï¼Œ\n\n```\nimport matplotlib.pyplot as plt\nimport numpy as np\nimport sympy\n\nx = np.zeros(20)\ny = np.zeros(20)\ny_E = np.zeros(20)\nz = np.zeros(20)\nx[0] = 0\ny[0] = 1\ny_E[0] = 1\nz[0] = (1+2*x[0])**0.5\nh = 0.05\n\n# dy/dx å¯¼æ•°\ndef f(x, y):\n    return y-2*x/y\n\n############################\n##### ç‰›é¡¿è¿­ä»£æ³•æ„å»ºæ–¹ç¨‹ #####\n############################\n\n# dy/dx = f(x, y)\n# y - yn = (x - xn) * f(x, y)\n# h * f(x, y) - (y - yn) = 0\ndef F(x, y, yn):\n    return h * f(x, y) - (y - yn)\n\n# æ±‚è§£dF(x, y, yn)/dy\n# d(0.05 * (y - 2*x/y) - y + yn) / dy\n# 0.05 * (1 + 2*x/y**2) - 1\n# 0.1 * x/y**2 - 0.95\ndef dF(x, y):\n    return 0.1*x/y**2 - 0.95\n\n############################\n############################\n############################\n\ndef newtonMethod(assum, d1, d3):\n    y = assum\n    Next_y = 0\n    if F(d1, y, d3) == 0.0:\n        return  y\n    else:\n        Next_y = y - F(d1, y, d3) / dF(d1, y)\n\n    # é›¶ç‚¹è·ç¦»\n    if abs(F(d1, y, d3) - F(d1, Next_y, d3)) < 1e-5:\n        return Next_y\n        '''è®¾ç½®è¿­ä»£è·³å‡ºæ¡ä»¶, åŒæ—¶è¾“å‡ºæ»¡è¶³f(x) = 0çš„xå€¼'''\n    else:\n        return newtonMethod(Next_y, d1, d3)\n\n\nfor i in range(1, 20):\n    x[i] = x[i-1]+h\n    y[i] = newtonMethod(4, x[i], y[i-1])\n    y_E[i] = y_E[i-1] + h*f(x[i-1], y_E[i-1])\n    z[i] = (1+2*x[i])**0.5\n\nplt.plot(x, y, label='Implicit Euler', color='green')\nplt.plot(x, y_E, label='Euler', color='orange')\nplt.plot(x, z, label='true', color='red')\nplt.legend()\nplt.show()\n```"},{"title":"Marching Cubeç®—æ³•æå–ç½‘æ ¼","url":"/2022/08/15/pymesh/","content":"\n\n# PyMesh3D\n\n## Basic Installation\n\nThis project for mesh render in data science.\n\n```python\npip install --upgrade pip\npip install pymesh3d\n```\n\nIf you need mayavi backend.\n\n```python\npip install mayavi\npip install pyqt\n```\n\n## Quick Start\n\n```python\nimport pymesh\nimport numpy as np\nimport matplotlib.pyplot as plt\n```\n\nLook at the directory example for full example.\n\n```python\n##########################################\n############ Rotate Mesh Data ############\n##########################################\n\nwkdir = \"../../Render\"\n\ney = np.load(wkdir + \"/Ez.npy\")[::2, ::50]\n\nm, n = ey.shape[0], ey.shape[1]\nres = np.zeros([m, n, n])\npymesh.rotate(ey, res, ifhalf = False)\n\nfig = plt.figure(figsize=(4, 3))\nplt.contourf(res[:, int(n/2), :].T)\ncbar = plt.colorbar()\n```\n\n![png](https://github.com/zhazhajust/pymesh/blob/main/example/example_files/example_1_0.png?raw=true)\n\n```python\n##########################################\n############# Save Mesh Data #############\n##########################################\n\nmesh = pymesh.get_iso_surf(res, contours_number = 4, cmap = \"jet\")\ncolor = pymesh.interp_color(mesh.iso_vals, cmap = \"jet\")\nmesh.export(wkdir + \"test\", \"obj\")\n```\n\n```python\n##########################################\n############# Load Mesh Data #############\n##########################################\n\nmesh = pymesh.Mesh.load(wkdir + \"test\", \"obj\")\n```\n\n```python\n##########################################\n############# Plot Mesh Data #############\n##########################################\n```\n\n```python\nfrom mayavi import mlab\n\nmlab_mesh = pymesh.iso_surface(mesh, colormap = \"RdBu\")\nmlab.colorbar()\nmlab.show()\n```\n![png](https://github.com/zhazhajust/pymesh/blob/main/example/example_files/example_3_0.png?raw=true)\n\n```python\n################ plt example #################\n\nsurf = mesh.plt_trisurf(cmap = \"jet\")\nplt.colorbar(surf, orientation = 'horizontal')\nplt.tight_layout()\n```\n\n![png](https://github.com/zhazhajust/pymesh/blob/main/example/example_files/example_2_0.png?raw=true)\n"},{"title":"å¤ªèµ«å…¹é¬¼æˆåƒ","url":"/2022/08/11/ghostimg/","content":"\n# 1 ç®€ä»‹\n\n## 1.1 é‡å­é¬¼æˆåƒ\n\n\n## 1.2 ç»å…¸é¬¼æˆåƒ\n\n## 1.3 è®¡ç®—æˆåƒ\n\n# 2 åŸç†\n\n## 2.1\n\n## 2.2\n\n# 3 é¬¼æˆåƒæ–¹æ¡ˆ\n\n## 3.1 SIç¼–ç \n\n## 3.2 VO2ç¼–ç \n\n## 3.3 æ³µæµ¦å…‰ç¼–ç \n\n# 4 å‘å±•æ–¹å‘\n\n\n\n"},{"title":"åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘","url":"/2022/07/09/segmentTree/","content":"\n## åŠ¨æ€çº¿æ®µæ ‘æ¨¡æ¿\n\n```C++\n\n/**\n * @Description: çº¿æ®µæ ‘ï¼ˆåŠ¨æ€å¼€ç‚¹ï¼‰\n * @Author: LFool\n * @Date 2022/6/7 09:15\n **/\npublic class SegmentTreeDynamic {\n    class Node {\n        Node left, right;\n        int val, add;\n    }\n    private int N = (int) 1e9;\n    private Node root = new Node();\n    public void update(Node node, int start, int end, int l, int r, int val) {\n        if (l <= start && end <= r) {\n            node.val += (end - start + 1) * val;\n            node.add += val;\n            return ;\n        }\n        int mid = (start + end) >> 1;\n        pushDown(node, mid - start + 1, end - mid);\n        if (l <= mid) update(node.left, start, mid, l, r, val);\n        if (r > mid) update(node.right, mid + 1, end, l, r, val);\n        pushUp(node);\n    }\n    public int query(Node node, int start, int end, int l, int r) {\n        if (l <= start && end <= r) return node.val;\n        int mid = (start + end) >> 1, ans = 0;\n        pushDown(node, mid - start + 1, end - mid);\n        if (l <= mid) ans += query(node.left, start, mid, l, r);\n        if (r > mid) ans += query(node.right, mid + 1, end, l, r);\n        return ans;\n    }\n    private void pushUp(Node node) {\n        node.val = node.left.val + node.right.val;\n    }\n    private void pushDown(Node node, int leftNum, int rightNum) {\n        if (node.left == null) node.left = new Node();\n        if (node.right == null) node.right = new Node();\n        if (node.add == 0) return ;\n        node.left.val += node.add * leftNum;\n        node.right.val += node.add * rightNum;\n        // å¯¹åŒºé—´è¿›è¡Œã€ŒåŠ å‡ã€çš„æ›´æ–°æ“ä½œï¼Œä¸‹æ¨æ‡’æƒ°æ ‡è®°æ—¶éœ€è¦ç´¯åŠ èµ·æ¥ï¼Œä¸èƒ½ç›´æ¥è¦†ç›–\n        node.left.add += node.add;\n        node.right.add += node.add;\n        node.add = 0;\n    }\n}\n\n```\n\nå¯¹äºè¡¨ç¤ºä¸ºã€ŒåŒºé—´å’Œã€ä¸”å¯¹åŒºé—´è¿›è¡Œã€ŒåŠ å‡ã€çš„æ›´æ–°æ“ä½œçš„æƒ…å†µï¼Œæˆ‘ä»¬åœ¨æ›´æ–°èŠ‚ç‚¹å€¼çš„æ—¶å€™ã€éœ€è¦âœ–ï¸å·¦å³å­©å­åŒºé—´å¶å­èŠ‚ç‚¹çš„æ•°é‡ (æ³¨æ„æ˜¯å¶å­èŠ‚ç‚¹çš„æ•°é‡)ã€ï¼›æˆ‘ä»¬åœ¨ä¸‹æ¨æ‡’æƒ°æ ‡è®°çš„æ—¶å€™ã€éœ€è¦ç´¯åŠ ã€ï¼ï¼(è¿™ç§æƒ…å†µå’Œæ¨¡ç‰ˆä¸€è‡´ï¼ï¼) å¦‚é¢˜ç›® æœ€è¿‘çš„è¯·æ±‚æ¬¡æ•°\nå¯¹äºè¡¨ç¤ºä¸ºã€ŒåŒºé—´å’Œã€ä¸”å¯¹åŒºé—´è¿›è¡Œã€Œè¦†ç›–ã€çš„æ›´æ–°æ“ä½œçš„æƒ…å†µï¼Œæˆ‘ä»¬åœ¨æ›´æ–°èŠ‚ç‚¹å€¼çš„æ—¶å€™ã€éœ€è¦âœ–ï¸å·¦å³å­©å­åŒºé—´å¶å­èŠ‚ç‚¹çš„æ•°é‡ (æ³¨æ„æ˜¯å¶å­èŠ‚ç‚¹çš„æ•°é‡)ã€ï¼›æˆ‘ä»¬åœ¨ä¸‹æ¨æ‡’æƒ°æ ‡è®°çš„æ—¶å€™ã€ä¸éœ€è¦ç´¯åŠ ã€ï¼ï¼(å› ä¸ºæ˜¯è¦†ç›–æ“ä½œï¼ï¼) å¦‚é¢˜ç›® åŒºåŸŸå’Œæ£€ç´¢ - æ•°ç»„å¯ä¿®æ”¹\nå¯¹äºè¡¨ç¤ºä¸ºã€ŒåŒºé—´æœ€å€¼ã€ä¸”å¯¹åŒºé—´è¿›è¡Œã€ŒåŠ å‡ã€çš„æ›´æ–°æ“ä½œçš„æƒ…å†µï¼Œæˆ‘ä»¬åœ¨æ›´æ–°èŠ‚ç‚¹å€¼çš„æ—¶å€™ã€ä¸éœ€è¦âœ–ï¸å·¦å³å­©å­åŒºé—´å¶å­èŠ‚ç‚¹çš„æ•°é‡ (æ³¨æ„æ˜¯å¶å­èŠ‚ç‚¹çš„æ•°é‡)ã€ï¼›æˆ‘ä»¬åœ¨ä¸‹æ¨æ‡’æƒ°æ ‡è®°çš„æ—¶å€™ã€éœ€è¦ç´¯åŠ ã€ï¼ï¼ å¦‚é¢˜ç›® æˆ‘çš„æ—¥ç¨‹å®‰æ’è¡¨ Iã€æˆ‘çš„æ—¥ç¨‹å®‰æ’è¡¨ III\n\n## æˆ‘çš„æ—¥ç¨‹å®‰æ’è¡¨ I\n\n```C++\n\nclass Node {\n    friend class MyCalendar;\n    // å·¦å³å­©å­èŠ‚ç‚¹\n    Node *left, *right;\n    // å½“å‰èŠ‚ç‚¹å€¼ï¼Œä»¥åŠæ‡’æƒ°æ ‡è®°çš„å€¼\n    int val, add;\n};\n\nclass MyCalendar {\n    public:    \n        MyCalendar():N(1e9), root(new Node()){\n        }\n        bool book(int start, int end) {\n            // å…ˆæŸ¥è¯¢è¯¥åŒºé—´æ˜¯å¦ä¸º 0\n            if (query(root, 0, N, start, end - 1) != 0) return false;\n            // æ›´æ–°è¯¥åŒºé—´\n            update(root, 0, N, start, end - 1, 1);\n            return true;\n        }\n        void update(Node* node, int start, int end, int l, int r, int val) {\n            if (l <= start && end <= r) {\n                node -> val += val;\n                node -> add += val;\n                return ;\n            }\n            pushDown(node);\n            int mid = (start + end) >> 1;\n            if (l <= mid) update(node -> left, start, mid, l, r, val);\n            if (r > mid) update(node -> right, mid + 1, end, l, r, val);\n            pushUp(node);\n        }\n        int query(Node* node, int start, int end, int l, int r) {\n            if (l <= start && end <= r) return node -> val;\n            pushDown(node);\n            int mid = (start + end) >> 1, ans = 0;\n            if (l <= mid) ans = query(node -> left, start, mid, l, r);\n            if (r > mid) ans = max(ans, query(node -> right, mid + 1, end, l, r));\n            return ans;\n        }\n    // *************** ä¸‹é¢æ˜¯æ¨¡ç‰ˆ ***************\n    private:\n        int N;\n        Node* root;\n        void pushUp(Node* node) {\n            // æ¯ä¸ªèŠ‚ç‚¹å­˜çš„æ˜¯å½“å‰åŒºé—´çš„æœ€å¤§å€¼\n            node -> val = max(node -> left -> val, node -> right -> val);\n        }\n        void pushDown(Node* node) {\n            if (node -> left == nullptr) node -> left = new Node();\n            if (node -> right == nullptr) node -> right = new Node();\n            if (node -> add == 0) return ;\n            node -> left -> val += node -> add;\n            node -> right -> val += node -> add;\n            node -> left -> add += node -> add;\n            node -> right ->add += node -> add;\n            node -> add = 0;\n        }\n};\n\n/**\n * Your MyCalendar object will be instantiated and called as such:\n * MyCalendar* obj = new MyCalendar();\n * bool param_1 = obj->book(start,end);\n */\n\n```"},{"title":"åæ»¤æ³¢","url":"/2022/07/05/antiFilter/","content":"\n## ä½¿ç”¨å‚…é‡Œå¶å˜æ¢å»å·ç§¯å’Œé€†æ»¤æ³¢\n\nå¦‚æœå·²ç»æœ‰äº†ä¸€å¼ å…·æœ‰æ¨¡ç³Šæ ¸çš„æ¨¡ç³Šå›¾åƒï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶æ¢å¤åˆ°åŸå§‹å›¾åƒã€‚åŸç†ä¸Šï¼Œæˆ‘ä»¬åªéœ€è¦å¯¹åŸæœ‰çš„æ»¤æ³¢å·ç§¯æ ¸æ¯ä¸€ä¸ªå€¼è¿›è¡Œå€’æ•°çš„æ“ä½œå³å¯å®ç°é€†æ»¤æ³¢å™¨çš„æ•ˆæœã€‚åœ¨æ­¤æˆ‘ä»¬ä»ç„¶æ˜¯åœ¨é¢‘åŸŸä¸Šè¿›è¡Œå·ç§¯ï¼Œä»£ç å¦‚ä¸‹ã€‚\n\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå·ç§¯æ ¸å–åˆ°æ•°çš„è¿‡ç¨‹ä¸­éœ€è¦åœ¨åŸæ¥çš„æ•°å€¼ä¸ŠåŠ ä¸€ä¸ªå¾®å°æ•°å€¼epsilonï¼Œä»¥é¿å…åˆ†æ¯ä¸ºé›¶ã€‚\n\n```python\n\nim = EyEnd #255*rgb2gray(imread('./images/snow.jpg'))\ngauss_kernel = np.outer(signal.gaussian(im.shape[0], 3), signal.gaussian(im.shape[1], 3))\n \nfreq = fp.fft2(im)\nfreq_kernel = fp.fft2(fp.ifftshift(gauss_kernel))\nconv = freq*freq_kernel\nim_blur = fp.ifft2(conv).real\nim_blur = 255*im_blur/np.max(im_blur)\n \nepsilon = 10**-6\nfreq = fp.fft2(im_blur)\nfreq_kernel = 1/(epsilon+freq_kernel) # avoid freq_kernel is zero\nim_rst = fp.ifft2(conv).real\nim_rst = 255*im_rst/np.max(im_rst)\n \npylab.figure(figsize = (10, 6))\npylab.subplot(221), pylab.imshow(im), pylab.title('Original Image'), pylab.axis('off')\npylab.subplot(222), pylab.imshow(im_blur), pylab.title('Blurred Image Image'), pylab.axis('off')\npylab.subplot(223), pylab.imshow(im_rst), pylab.title('Restored Image with inverse filter'), pylab.axis('off')\npylab.subplot(224), pylab.imshow(im_rst - im), pylab.title('Diff Image'), pylab.axis('off')\n\n```\n\n## åˆ©ç”¨ç»´çº³æ»¤æ³¢å™¨å»å·ç§¯\n\nå‰é¢çš„å»å·ç§¯æ–¹æ³•éœ€è¦å·²çŸ¥æ¨¡ç³Šæ ¸ï¼Œåœ¨è¿™é‡Œä½¿ç”¨ç»´çº³æ»¤æ³¢å™¨ï¼Œåœ¨ä¸çŸ¥é“æ¨¡ç³Šæ ¸çš„æƒ…å†µä¸‹ï¼Œä»æŸåçš„ä¿¡å·ä¸­å»é™¤å™ªå£°ï¼Œè¾¾åˆ°å¤åŸå›¾åƒçš„ç›®çš„ã€‚é¦–å…ˆæ„é€ ä¸€ä¸ªå·²ç»æŸåäº†çš„å›¾åƒã€‚\n\n```python\n\nim = rgb2gray(imread('./images/cat.jpg'))\n \nn = 7\npsf = np.ones((n, n))/n**2\nim1 = signal.convolve2d(im, psf, mode = 'same')\nim1 += 0.1*np.std(im1)*np.random.standard_normal(im.shape)\n\n```\n\nå†ä½¿ç”¨ç»´çº³æ»¤æ³¢å®Œæˆæ“ä½œï¼Œæœ€åå°±èƒ½å¾—åˆ°å›¾åƒ\n\n```python\n\nim2, _ = restoration.unsupervised_wiener(im1, psf)\nfig, axes = pylab.subplots(nrows = 1, ncols = 3, figsize = (200, 40), sharex = True,\n sharey = True)\npylab.gray()\naxes[0].imshow(im), axes[0].axis('off'), axes[0].set_title('Original image', size = 200)\naxes[1].imshow(im1), axes[1].axis('off'), axes[1].set_title('Noisy blurred image', size = 200)\naxes[2].imshow(im2), axes[2].axis('off'), axes[2].set_title('Self tuned restoration', size = 200)\nfig.tight_layout()\npylab.show()\n\n```\n\n## ä½¿ç”¨ä½é€šæ»¤æ³¢ï¼Œé‡å»ºå›¾åƒ\n\n```python\n\nim_fft = fp.ifftshift(im_fft_shift)\nim = np.clip(fp.ifft2(im_fft).real, 0, 255)\npylab.figure(figsize = (10,10))\npylab.imshow(im,pylab.cm.gray), pylab.axis('off'), pylab.title('Noise image'), pylab.show()\n\nkeep_fraction = 0.1\nr,c = im_fft.shape\nim_fft[int(r*keep_fraction):int(r*(1-keep_fraction))] = 0\nim_fft[:, int(c*keep_fraction):int(c*(1-keep_fraction))] = 0\npylab.figure(), plot_spectrum(fp.fftshift(im_fft)), pylab.title('Filitered Spectrum')\n\nim_new = fp.ifft2(im_fft).real\npylab.figure(figsize = (10, 10))\npylab.imshow(im_new,pylab.cm.gray), pylab.axis('off'), pylab.title('Reconstructed image'), pylab.show()\n\n```\n"},{"title":"é«˜æ–¯å·®åˆ†å’Œè¶…é«˜æ–¯æ»¤æ³¢","url":"/2022/07/05/gauss_diff/","content":"\n```python\n\ndef gauss_func(Nx, sigma, n):\n    x = np.arange(Nx) * dx\n    cen = x0\n    print(cen)\n    amp = 1\n    return amp * np.exp(-(x - cen) ** n / (2 * sigma ** n))\n\ndef gauss_func2d(Nx, Ny, sigma, n):\n    x = np.arange(Nx)\n    y = np.arange(Ny)\n    Y, X = np.meshgrid(y, x)\n    cen = [x0, y0]\n    print(cen)\n    amp = 1\n    R = np.sqrt((X * dx - cen[0])**2 + (Y * dy - cen[1])**2)\n    return amp * np.exp(- R ** n / (2 * sigma ** n))\n\n```"},{"title":"matplotlib colorbarä½ç½®","url":"/2022/07/04/matplotlib/","content":"\nmatplotlib 3.5ä»¥ä¸Šç‰ˆæœ¬\n\n```python\n\nfig, ax = plt.subplots(figsize = [3, 1.5])\nnorm = mpl.colors.Normalize(0, 20, clip=True)\nim = plt.pcolormesh([[0,0,0],[0,0,20],[0,6,0]], cmap = 'jet', norm = norm)\n\ncbar2 = fig.colorbar(im, cmap = 'jet', location='top',  shrink = 0.8)\ncbar2.set_label('E_k [MeV]')\n\n```\n\nå¦‚æœfigure.colorbaræ²¡æœ‰locationå‚æ•°ï¼Œåˆ™ä½¿ç”¨mpl.colorbar.make_axesæˆ–è€…mpl.colorbar.make_axes_gridspecæ„é€ caxç„¶åç”Ÿæˆè°ƒç”¨Colorbaræ„é€ å‡½æ•°ç”Ÿæˆcbar\n```python\n\n#plt.colorbar().set_label.__doc__\n#kw = {\"location\": \"top\", \"orientation\": \"horizontal\",\n#                   \"anchor\": (0.5, 0.0), \"panchor\": (0.5, 1.0), \"pad\": 0.05}\n#kw['orientation'] = kw['orientation']\n#location = kw['ticklocation'] = kw['location']\n\nkw = {'shrink': 0.8, 'orientation': \"horizontal\", 'location': 'top'}\n#cax, kw = mpl.colorbar.make_axes_gridspec(ax, **kw)\ncax, kw = mpl.colorbar.make_axes(ax, **kw)\n\nNON_COLORBAR_KEYS = ['fraction', 'pad', 'shrink', 'aspect', 'anchor',\n                        'panchor']\n\ncb_kw = {k: v for k, v in kw.items() if k not in NON_COLORBAR_KEYS}\n\ncbar = mpl.colorbar.Colorbar(cax, im, ticklocation = \"top\", orientation = \"horizontal\")\ncbar.set_label('E_k [MeV]')\n\n```\n\næ­¤å¤–ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰caxç„¶åç”Ÿæˆcbar\n\n```python\n\ncax = fig.add_axes([0.15, 1.05, 0.7, 0.05], label=\"<colorbar>\")\ncbar = mpl.colorbar.Colorbar(cax, im, orientation = \"horizontal\", ticklocation = \"top\")\ncbar.set_ticks([0, 10, 20])\ncbar.ax.xaxis.set_ticks_position('top')\ncbar.ax.xaxis.set_label_position('top')\ncbar.set_label('E_k [MeV]')\n\n```\n"},{"title":"å·ç§¯ç®—æ³•å®ç°AutoCorrå’Œé«˜æ–¯æ»¤æ³¢ï¼ˆé«˜æ–¯æ¨¡ç³Šï¼‰","url":"/2022/07/03/conv/","content":"\n## è‡ªç›¸å…³\n\n```python\n\nfrom scipy import signal\nrng = np.random.default_rng()\nsig = rng.standard_normal(1000)\nautocorr = signal.fftconvolve(sig, sig[::-1], mode='full')\n\n```\n\n## é«˜æ–¯æ»¤æ³¢\n\n```python\nimport scipy\nfrom scipy.ndimage import gaussian_filter\nimport scipy.signal as signal\n\nc = 3e8\ndx = 1e-6 * (x[1] - x[0])\nsigma = c/10e12/dx\n\nEyTHz = scipy.ndimage.gaussian_filter(EyEnd, sigma = 15)\n\n```\n\nä½¿ç”¨é«˜æ–¯æ ¸å·ç§¯è¿›è¡Œæ»¤æ³¢\n\n```python\n\nim = EyEnd\ngauss_kernel = np.outer(signal.gaussian(im.shape[0], 15), signal.gaussian(im.shape[1], 15))\n#gauss_kernel = gauss_kernel/np.sum(gauss_kernel)\ngauss_kernel /= np.trapz(np.trapz(gauss_kernel))\nim_real = signal.convolve(im, gauss_kernel, mode='same')\n#im_real = im * gauss_kernel\n\n```\n\nå…¶ä¸­sigmaä¸ºæ»¤æ³¢å®½åº¦\n\n## ä½¿ç”¨å·ç§¯å®ç°æ»¤æ³¢\n\n```python\n\nimport numpy as np\nfrom scipy import signal\n#from scipy import misc\nimport matplotlib.pyplot as plt\n\n####åŠ¨æ€æ¨¡ç³Šæ ¸å¿ƒ\nguass_kernal = [[0, 0, 1],\n                [0, 1, 0],\n                [1, 0, 0]]\n\nresult = signal.convolve2d(origin, guass_kernal, boundary='symm', mode='same')\n\n```\n\näºŒç»´çš„å·ç§¯è¿ç®—è¿˜æœ‰ä¸€ç§å‡½æ•°ï¼Œæ˜¯signal.sepfir2d()ï¼Œå®ƒå¯ä»¥ä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼Œåä¸¤ä¸ªå‚æ•°æŒ‡å®šè¡Œå’Œåˆ—çš„å·ç§¯å’Œ(ä¸¤ä¸ªæ–¹å‘ä¸Šçš„å·ç§¯æ˜¯å¯ä»¥ä¸åŒçš„ï¼Œåˆ†åˆ«æŒ‡å®šå·ç§¯å’Œåºåˆ—)ã€‚\n\n\n## é¢‘åŸŸå·ç§¯\n\n```python\n\nfrom scipy import signal\nimport numpy as np\nimport numpy.fft as fp\n\nim = EyEnd #EyEndä¸ºéœ€è¦æ»¤æ³¢çš„å›¾åƒ\n\ngauss_kernel = np.outer(signal.gaussian(im.shape[0], 15), \nsignal.gaussian(im.shape[1], 15))\n\nplt.pcolormesh(gauss_kernel, cmap = 'jet')\n\nfreq = np.fft.fft2(im)\nassert(freq.shape == gauss_kernel.shape)\nfreq_kernel = np.fft.fft2(np.fft.ifftshift(gauss_kernel))\n\nfig = plt.figure(figsize = (10, 4))\nax_1 = fig.add_subplot(121, projection='3d')\nax_2 = fig.add_subplot(122, projection='3d')\n \nY = np.arange(0 - int(im.shape[0]/2), im.shape[0] - int(im.shape[0]/2), 1)\nX = np.arange(0 - int(im.shape[1]/2), im.shape[1] - int(im.shape[1]/2), 1)\nX, Y = np.meshgrid(X, Y)\n \nax_1.plot_surface(X, Y, np.log10(np.abs(fp.ifftshift(freq))), rstride=4,\ncstride=4, cmap=plt.cm.coolwarm)\n \nax_2.plot_surface(X, Y, np.abs(fp.ifftshift(freq_kernel)), rstride=4,\ncstride=4, cmap=plt.cm.coolwarm)\nplt.show()\n\nconv = freq*freq_kernel\nim1 = fp.ifft2(conv).real\n\n```\n\nç®€æ´ç‰ˆ\n\n```python\n\nfrom scipy import signal\nimport numpy as np\nimport numpy.fft as fp\n\ndef fftConv(im, sigma):\n\n    gauss_kernel = np.outer(signal.gaussian(im.shape[0], sigma), \n    signal.gaussian(im.shape[1], sigma))\n    plotFreq(freqX, freqY, gauss_kernel.T)\n\n    freq = np.fft.fft2(im)\n    assert(freq.shape == gauss_kernel.shape)\n    freq_kernel = np.fft.fft2(np.fft.ifftshift(gauss_kernel))\n    #freq_kernel = np.fft.fft2(gauss_kernel)\n    plotField(freqX, freqY, np.log10(np.abs(fp.ifftshift(freq))).T)\n    plotFreq(freqX, freqY, np.abs(fp.ifftshift(freq_kernel)).T) \n\n    conv = freq*freq_kernel\n    im1 = fp.ifft2(conv).real\n    return im1\n\nim = EyEnd\nplotField(x, y, im.T)\nsigma = 15\nim1 = fftConv(im, sigma)\nplotField(freqX, freqY, im1.T) \n\n```\n\n\næ—¶åŸŸå’Œé¢‘åŸŸå¯¹æ¯”\n\n```python\n\nimport matplotlib.pyplot as pylab\n\nfreq = np.fft.fft2(im)\nassert(freq.shape == gauss_kernel.shape)\nfreq_kernel = np.fft.fft2(np.fft.ifftshift(gauss_kernel))\nconv = freq * freq_kernel\nim1 = fp.ifft2(conv).real\n\npylab.figure(figsize = (20, 8))\npylab.gray()\npylab.subplot(2, 3, 1), pylab.pcolormesh(im.T, cmap = 'bwr'), pylab.title('Original Image', size = 30), pylab.axis('off')\npylab.subplot(2, 3, 2), pylab.pcolormesh(gauss_kernel.T, cmap = 'jet'), pylab.title('Gaussian Kernel', size = 30), pylab.axis('off')\npylab.subplot(2, 3, 3), pylab.pcolormesh(im1.T, cmap = 'bwr'), pylab.title('Output Image', size = 30), pylab.axis('off')\n\nimOrigin = (20*np.log10(np.abs(0.1+fp.ifftshift(freq)))).astype(int)\npylab.subplot(2, 3, 4), pylab.pcolormesh(imOrigin.T, cmap = 'bwr')\npylab.title('Origin Image Spectrum', size = 30), pylab.axis('off')\n\nimGuassian = (20*np.log10(np.abs(0.1+fp.ifftshift(freq_kernel)))).astype(int)\npylab.subplot(2, 3, 5), pylab.pcolormesh(imGuassian.T, cmap = 'jet')\npylab.title('Gaussian Kernel Spectrum', size = 30), pylab.axis('off')\n\nimOutSpec = (20*np.log10(np.abs(0.1+fp.ifftshift(conv)))).astype(int)\npylab.subplot(2, 3, 6), pylab.pcolormesh(imOutSpec.T, cmap = 'jet')\npylab.title('Output Image Spectrum', size = 30), pylab.axis('off')\n\n```\n\n## å¸¦é€šæ»¤æ³¢\n\nåœ¨è¿™é‡Œå°è¯•ä½¿ç”¨é«˜æ–¯å·®åˆ†æ ¸ï¼ˆä¸¤ä¸ªé«˜æ–¯æ ¸çš„å·®ï¼‰ï¼Œä½œä¸ºå¸¦é€šæ»¤æ³¢å™¨ã€‚å¸¦é€šæ»¤æ³¢æ˜¯ä¿ç•™ä¸€å®šé¢‘æ®µå†…çš„é¢‘ç‡åˆ†é‡ï¼Œè€Œä¸¢å¼ƒå…¶ä½™æ‰€æœ‰çš„é¢‘ç‡åˆ†é‡ã€‚\n\n```python\n###è¯»å–å›¾åƒ\nim = img_as_float(pylab.imread('./images/snow.jpg'))\npylab.figure(), pylab.imshow(im), pylab.axis('off'), pylab.show()\nx = np.linspace(-10, 10, 15)\n###kernel 1 ç”Ÿæˆ\nkernel = np.exp(-0.005*x**2)\nkernel /= np.trapz(kernel)\nguass_kernel_1 = kernel[:, np.newaxis] * kernel[np.newaxis, :]\n###kernel 2 ç”Ÿæˆ\nkernel = np.exp(-5*x**2)\nkernel /= np.trapz(kernel)\nguass_kernel_2 = kernel[:, np.newaxis] * kernel[np.newaxis, :]\n###è¿›è¡Œå·®åˆ†\nDOGkernel = guass_kernel_1[:,:,np.newaxis] - guass_kernel_2[:,:,np.newaxis]\n###å·ç§¯\nim = signal.fftconvolve(im, DOGkernel, mode = 'same')\npylab.figure, pylab.imshow(np.clip(im, 0, 1)), pylab.axis('off'), print(np.max(im))\npylab.show()\n\n```\n"},{"title":"å·ç§¯ç®—æ³•å®ç°AutoCorrå’Œé«˜æ–¯æ»¤æ³¢ï¼ˆé«˜æ–¯æ¨¡ç³Šï¼‰","url":"/2022/07/03/myfftconvolve/","content":"\n## è‡ªå®šä¹‰FFTå·ç§¯\n\nä½¿ç”¨fftshift(fft(fftshift(signal))):\n\n1.ä¸æ”¹å˜é¢‘è°±çš„å¹…åº¦å’Œç›¸ä½\n\n2.ä½¿å¾—é¢‘è°±çš„èŒƒå›´ä¸º-Fs/2åˆ°Fs/2ï¼Œä¸­å¿ƒé¢‘ç‡ä¸º0\n\n```python\n\ndef fftconvolve(im, gauss_kernel):\n    gauss_f = np.fft.fftshift(np.fft.fft2(np.fft.fftshift(gauss_kernel)))\n    #plotFreq(x, y, np.log(np.abs(gauss_f)).T)\n    #plotFreq(x, y, np.log(np.angle(gauss_f)).T)\n    im_r = np.fft.fftshift(np.fft.fft2(np.fft.fftshift(im)))\n    #plotField(x, y, np.log(np.abs(im_r)).T)\n    #plotFreq(x, y, np.log(np.angle(im_r)).T)\n    im_filter = np.fft.ifftshift(np.fft.ifft2(np.fft.ifftshift(gauss_f * im_r))).real\n    #plotField(x, y, im_filter.T)\n    return im_filter\n\nim_filter = fftconvolve(im, gauss_kernel)\n\n```\n\nåªæ”¹å˜gauss_kernalçš„fftä¹Ÿå¯ä»¥å¾—åˆ°ç›¸åŒçš„ç»“æœ\n\n```python\n\ndef fftconvolve(im, gauss_kernel):\n    gauss_f = np.fft.fftshift(np.fft.fft2(np.fft.fftshift(gauss_kernel)))\n    #plotFreq(x, y, np.log(np.abs(gauss_f)).T)\n    #plotFreq(x, y, np.log(np.angle(gauss_f)).T)\n    im_r = np.fft.fftshift(np.fft.fft2(np.fft.fftshift(im)))\n    #plotField(x, y, np.log(np.abs(im_r)).T)\n    #plotFreq(x, y, np.log(np.angle(im_r)).T)\n    im_filter = np.fft.ifftshift(np.fft.ifft2(np.fft.ifftshift(gauss_f * im_r))).real\n    #plotField(x, y, im_filter.T)\n    return im_filter\n\nim_filter = fftconvolve(im, gauss_kernel)\n\n```\n\nä½¿ç”¨fftshiftå’Œä¸é€‚ç”¨fftshiftçš„ç›¸ä½è§’å¯¹æ¯”ã€‚\n"},{"title":"åˆ†æ²»ç®—æ³•","url":"/2022/07/01/Divide-and-Conquer/","content":"## é—®é¢˜\n\nç»™ä½ ä¸€ä¸ªç”±æ•°å­—å’Œè¿ç®—ç¬¦ç»„æˆçš„å­—ç¬¦ä¸²Â expression ï¼ŒæŒ‰ä¸åŒä¼˜å…ˆçº§ç»„åˆæ•°å­—å’Œè¿ç®—ç¬¦ï¼Œè®¡ç®—å¹¶è¿”å›æ‰€æœ‰å¯èƒ½ç»„åˆçš„ç»“æœã€‚ä½ å¯ä»¥ æŒ‰ä»»æ„é¡ºåº è¿”å›ç­”æ¡ˆã€‚\n\nç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹æ»¡è¶³å…¶å¯¹åº”è¾“å‡ºå€¼ç¬¦åˆ 32 ä½æ•´æ•°èŒƒå›´ï¼Œä¸åŒç»“æœçš„æ•°é‡ä¸è¶…è¿‡ \\(10^4\\) ã€‚\n\n### ç¤ºä¾‹\n\n```C++\nè¾“å…¥ï¼šexpression = \"2-1-1\"\nè¾“å‡ºï¼š[0,2]\nè§£é‡Šï¼š\n((2-1)-1) = 0 \n(2-(1-1)) = 2\n```\n\n## è§£é¢˜æ€è·¯\n\nå¯¹äºä¸€ä¸ªå½¢å¦‚ x op yï¼ˆop ä¸ºè¿ç®—ç¬¦ï¼Œx å’Œ y ä¸ºæ•°ï¼‰ çš„ç®—å¼è€Œè¨€ï¼Œå®ƒçš„ç»“æœç»„åˆå–å†³äº x å’Œ y çš„ç»“æœç»„åˆæ•°ï¼Œè€Œ x å’Œ y åˆå¯ä»¥å†™æˆå½¢å¦‚ x op y çš„ç®—å¼ã€‚\n\nå› æ­¤ï¼Œè¯¥é—®é¢˜çš„å­é—®é¢˜å°±æ˜¯ x op y ä¸­çš„ x å’Œ yï¼šä»¥è¿ç®—ç¬¦åˆ†éš”çš„å·¦å³ä¸¤ä¾§ç®—å¼è§£ã€‚\n\nç„¶åæˆ‘ä»¬æ¥è¿›è¡Œ åˆ†æ²»ç®—æ³•ä¸‰æ­¥èµ°ï¼š\n\nåˆ†è§£ï¼šæŒ‰è¿ç®—ç¬¦åˆ†æˆå·¦å³ä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«æ±‚è§£\nè§£å†³ï¼šå®ç°ä¸€ä¸ªé€’å½’å‡½æ•°ï¼Œè¾“å…¥ç®—å¼ï¼Œè¿”å›ç®—å¼è§£\nåˆå¹¶ï¼šæ ¹æ®è¿ç®—ç¬¦åˆå¹¶å·¦å³ä¸¤éƒ¨åˆ†çš„è§£ï¼Œå¾—å‡ºæœ€ç»ˆè§£\n\n```C++\n\nclass Solution {\npublic:\n    vector<int> diffWaysToCompute(string expression) {\n        vector<int> vec1, vec2, res;\n        int flag = 0;\n        int n = expression.size();\n        for(int i = 0; i < n; i++){\n            char oper = expression[i];\n            if(oper == '+' || oper == '-' || oper == '*'){\n                flag = 1;\n                vec1 = diffWaysToCompute(string(expression, 0, i));\n                vec2 = diffWaysToCompute(string(expression, i + 1, n - i - 1));\n                for(auto v1: vec1){\n                    for(auto v2: vec2){\n                        if(oper == '+'){\n                            res.push_back(v1 + v2);\n                        }else if(oper == '-'){\n                            res.push_back(v1 - v2);\n                        }else{\n                            res.push_back(v1 * v2);\n                        }\n                    }\n                }\n            }\n        }\n        if(flag == 0){\n            return {std::stoi(expression)};\n        }\n        return res;\n    }\n};\n\n```\n\nä»¥åŠ**python**ç‰ˆæœ¬\n\n```python\n\nclass Solution:\n    def diffWaysToCompute(self, input: str) -> List[int]:\n        # å¦‚æœåªæœ‰æ•°å­—ï¼Œç›´æ¥è¿”å›\n        if input.isdigit():\n            return [int(input)]\n\n        res = []\n        for i, char in enumerate(input):\n            if char in ['+', '-', '*']:\n                # 1.åˆ†è§£ï¼šé‡åˆ°è¿ç®—ç¬¦ï¼Œè®¡ç®—å·¦å³ä¸¤ä¾§çš„ç»“æœé›†\n                # 2.è§£å†³ï¼šdiffWaysToCompute é€’å½’å‡½æ•°æ±‚å‡ºå­é—®é¢˜çš„è§£\n                left = self.diffWaysToCompute(input[:i])\n                right = self.diffWaysToCompute(input[i+1:])\n                # 3.åˆå¹¶ï¼šæ ¹æ®è¿ç®—ç¬¦åˆå¹¶å­é—®é¢˜çš„è§£\n                for l in left:\n                    for r in right:\n                        if char == '+':\n                            res.append(l + r)\n                        elif char == '-':\n                            res.append(l - r)\n                        else:\n                            res.append(l * r)\n\n        return res\n\n```\n"},{"title":"EPOCH Code For Spectrum","url":"/2022/06/30/centspec/","content":"\nUse EPOCH Code to get axis spectrum\n\n## SDF_Write\n\nUse this syntex can save axis Ey to file:\n\n```Fortran\nCALL sdf_write_plain_variable(sdf_handle, id, name, \nunits, dims, stagger, & grid_id, variable,\nsubtype_field, subarray_field)  \n```\n\nThe parameters have the following types and meanings:\n\n- **block id** - The id name of the variable. This character string is a unique identifier for the variable in the file enabling a program to retrieve it later. Once defined it should not change so that newer versions of EPOCH can still identify variables generated by older versions.\n\n- **name** - The display name of the variable. This character string is the name that is used by external programs to display an identifying name for the variable. If it contains '/' characters then these are used by VisIt to group the variables.\n\n- **units** - The units of the variable. This character string is used when displaying the data units. For most variables in EPOCH these are SI units.\n\n- **dims** - An nD integer array containing the GLOBAL length of the variable across all processors. In EPOCH a variable actually called \"dims\" exists for variables which are the same size as the default field variables.\n\n- **stagger** - An integer constant containing the stagger of a variable from the cell centre of a cell. This property lets external programs know the position of a variable on the grid.\n\n- **grid id** - The id name of the grid to which the variable is attached. In EPOCH , the main grid is just called \"grid\". Note that this property is case sensitive.\n\n- **variable** - The actual variable to be written to disk.\n\n- **subtype field** - This is an MPI type representing the layout of the data across the processors. For a standard field variable, there is an automatically created type called \"subtype field\" which should be used here.\n\n- **subarray field** - This is an MPI type representing the section of the \"variable\" parameter to be written. For a standard field variable, there is an automatically created type called \"subarray field\" which should be used here.\n\n## Example\n\nFor Example, derived variables **array**\n\n```Fortran\nIF (IAND(dumpmask(c_dump_myvar), code)) THEN\n  CALL calc_my_variable(array)\n  CALL sdf_write_plain_variable(sdf_handle, â€™my_varâ€™,\n  â€™Mine/variableâ€™, â€™unitâ€™, dims, c_stagger_cell_centre, \n  â€™gridâ€™, array, subtype_field, subarray_field)\nENDIF\n```\n\n## Cent Spec\n\nextract the central ey and save to sdf by subroutine **sdf_write_plain_variable(...)**\n"},{"title":"When to Use Static Generation v.s. Server-side Rendering","url":"/2020/01/02/ssg-ssr/","content":"\nWe recommend using **Static Generation** (with and without data) whenever possible because your page can be built once and served by CDN, which makes it much faster than having a server render the page on every request.\n\nYou can use Static Generation for many types of pages, including:\n\n- Marketing pages\n- Blog posts\n- E-commerce product listings\n- Help and documentation\n\nYou should ask yourself: \"Can I pre-render this page **ahead** of a user's request?\" If the answer is yes, then you should choose Static Generation.\n\nOn the other hand, Static Generation is **not** a good idea if you cannot pre-render a page ahead of a user's request. Maybe your page shows frequently updated data, and the page content changes on every request.\n\nIn that case, you can use **Server-Side Rendering**. It will be slower, but the pre-rendered page will always be up-to-date. Or you can skip pre-rendering and use client-side JavaScript to populate data."},{"title":"Two Forms of Pre-rendering","url":"/2020/01/01/pre-rendering/","content":"\nNext.js has two forms of pre-rendering: **Static Generation** and **Server-side Rendering**. The difference is in **when** it generates the HTML for a page.\n\n- **Static Generation** is the pre-rendering method that generates the HTML at **build time**. The pre-rendered HTML is then _reused_ on each request.\n- **Server-side Rendering** is the pre-rendering method that generates the HTML on **each request**.\n\nImportantly, Next.js lets you **choose** which pre-rendering form to use for each page. You can create a \"hybrid\" Next.js app by using Static Generation for most pages and using Server-side Rendering for others."}]