<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Podman Compose 容器无法访问外网：Rootless 网络原理与解决方案（pasta vs slirp4netns）</title>
    <link href="/2026/01/02/rootless_network/"/>
    <url>/2026/01/02/rootless_network/</url>
    
    <content type="html"><![CDATA[<blockquote><p>现象：同一份 <code>docker-compose.yml</code>，用 <strong>Docker Compose</strong> 启动后容器能访问外网；用 <strong>Podman Compose</strong> 启动后容器访问外网失败。<br>结论：通常不是业务问题，而是 <strong>Podman Rootless 网络实现与 Docker Rootful NAT Bridge 的差异</strong>导致。</p></blockquote><h2 id="一、现象与定位"><a href="#一、现象与定位" class="headerlink" title="一、现象与定位"></a>一、现象与定位</h2><p>我这边首先用一条命令确认 Podman 的运行模式与网络后端：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">podman info --format <span class="hljs-string">&#x27;&#123;&#123;.Host.Security.Rootless&#125;&#125; &#123;&#123;.Host.NetworkBackend&#125;&#125;&#x27;</span><br>````<br><br>输出：<br><br>```text<br><span class="hljs-literal">true</span> netavark<br></code></pre></td></tr></table></figure><p>含义：</p><ul><li><code>true</code>：说明是 <strong>rootless（非 root）</strong> 模式在运行容器。</li><li><code>netavark</code>：Podman 的网络后端（负责创建网络等）。</li></ul><p><strong>关键点</strong>：Docker 常见是 rootful + bridge NAT，Podman rootless 则不能直接使用内核层面的 iptables&#x2F;nftables NAT 规则，需要走 rootless 专用的网络方案（如 <code>pasta</code> &#x2F; <code>slirp4netns</code>）。</p><hr><h2 id="二、为什么-Docker-能外网，Podman-rootless-却不行？"><a href="#二、为什么-Docker-能外网，Podman-rootless-却不行？" class="headerlink" title="二、为什么 Docker 能外网，Podman rootless 却不行？"></a>二、为什么 Docker 能外网，Podman rootless 却不行？</h2><h3 id="1）NAT-出口是什么？"><a href="#1）NAT-出口是什么？" class="headerlink" title="1）NAT 出口是什么？"></a>1）NAT 出口是什么？</h3><p>容器通常拿到的是私网地址（例如 <code>10.x</code> &#x2F; <code>172.16-31.x</code> &#x2F; <code>192.168.x</code>）。这些地址在公网是<strong>不可路由</strong>的：</p><ul><li>容器发起公网请求时，源 IP 是私网地址；</li><li>公网服务器回包时不知道该把响应发回哪里（私网地址在公网不可达）。</li></ul><p>因此需要一个“出口”把私网源地址<strong>改写</strong>成宿主机可路由的地址，并维护映射关系，让回包能正确回到容器。这种机制就是 <strong>NAT（Network Address Translation）</strong>，对应的位置就是 <strong>NAT 出口</strong>。</p><p>简化理解：</p><ul><li>出去：<code>容器私网 IP:端口</code> → 改写成 <code>宿主机对外 IP:端口</code></li><li>回来：根据映射表把回包还原 → 转发回容器</li></ul><p>Docker 默认 bridge 网络会配合内核 NAT（iptables&#x2F;nftables）实现这一点，所以“出公网”通常很稳。</p><h3 id="2）rootless-的限制：没有特权做系统级-NAT"><a href="#2）rootless-的限制：没有特权做系统级-NAT" class="headerlink" title="2）rootless 的限制：没有特权做系统级 NAT"></a>2）rootless 的限制：没有特权做系统级 NAT</h3><p>在 rootless 模式下，Podman 运行在普通用户权限，<strong>不能随意修改系统的 iptables&#x2F;nftables 规则</strong>，于是需要使用 rootless 专用的网络方案来实现联网。</p><p>Podman rootless 常见两种网络实现：</p><ul><li><code>pasta</code>：尽量让容器“像在宿主机网络上一样”，但在某些环境里（多网卡、VPN、策略路由、默认路由复杂等）可能出现出口选择&#x2F;回程路径问题；并且其行为与 Docker 的经典 NAT bridge 不完全一致。</li><li><code>slirp4netns</code>：通过用户态方式提供一个更“传统”的 <strong>NAT 出口模型</strong>（更接近 Docker bridge + NAT 的体验），很多场景下对“访问外网（HTTP&#x2F;HTTPS）”更稳定。</li></ul><hr><h2 id="三、排查思路（快速判断是路由问题还是-DNS-问题）"><a href="#三、排查思路（快速判断是路由问题还是-DNS-问题）" class="headerlink" title="三、排查思路（快速判断是路由问题还是 DNS 问题）"></a>三、排查思路（快速判断是路由问题还是 DNS 问题）</h2><p>进容器测试：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">podman <span class="hljs-built_in">exec</span> -it &lt;容器名&gt; sh -lc <span class="hljs-string">&#x27;</span><br><span class="hljs-string">ip route;</span><br><span class="hljs-string">cat /etc/resolv.conf;</span><br><span class="hljs-string">curl -I https://1.1.1.1 || true;</span><br><span class="hljs-string">curl -I https://example.com || true</span><br><span class="hljs-string">&#x27;</span><br></code></pre></td></tr></table></figure><p>解释：</p><ul><li><code>curl https://1.1.1.1</code> 也失败：多半是 <strong>路由&#x2F;NAT&#x2F;出口</strong>问题。</li><li><code>1.1.1.1</code> 通但 <code>example.com</code> 不通：多半是 <strong>DNS</strong> 问题（可考虑在 compose 显式配置 <code>dns:</code> 或检查 base 配置是否在 Podman 下合并生效）。</li></ul><hr><h2 id="四、最终解决方案：切换-rootless-默认网络为-slirp4netns"><a href="#四、最终解决方案：切换-rootless-默认网络为-slirp4netns" class="headerlink" title="四、最终解决方案：切换 rootless 默认网络为 slirp4netns"></a>四、最终解决方案：切换 rootless 默认网络为 slirp4netns</h2><p>编辑配置文件：</p><p><code>~/.config/containers/containers.conf</code></p><p>加入：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[network]</span><br><span class="hljs-attr">default_rootless_network_cmd</span> = <span class="hljs-string">&quot;slirp4netns&quot;</span><br></code></pre></td></tr></table></figure><p>重建容器：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">podman compose down<br>podman compose up -d<br></code></pre></td></tr></table></figure><p><strong>结果</strong>：容器恢复可访问外网。</p><h3 id="为什么这个改动有效？"><a href="#为什么这个改动有效？" class="headerlink" title="为什么这个改动有效？"></a>为什么这个改动有效？</h3><p>因为它把 rootless 容器的出网方式切换成 <code>slirp4netns</code> 的用户态 NAT 模型，提供更明确的“虚拟网关 + NAT 出口”，从而让私网地址的容器流量能稳定转换并访问公网（更接近 Docker 默认 bridge 的行为）。</p><hr><h2 id="五、备选方案"><a href="#五、备选方案" class="headerlink" title="五、备选方案"></a>五、备选方案</h2><h3 id="方案-A：直接用-rootful-运行（更接近-Docker）"><a href="#方案-A：直接用-rootful-运行（更接近-Docker）" class="headerlink" title="方案 A：直接用 rootful 运行（更接近 Docker）"></a>方案 A：直接用 rootful 运行（更接近 Docker）</h3><p>如果环境允许（并且你希望网络行为尽量和 Docker 一致）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> podman compose up -d<br></code></pre></td></tr></table></figure><p>rootful 下可以使用更标准的内核桥接与 NAT 能力。</p><h3 id="方案-B：保持-pasta，但指定出口接口（适合复杂路由）"><a href="#方案-B：保持-pasta，但指定出口接口（适合复杂路由）" class="headerlink" title="方案 B：保持 pasta，但指定出口接口（适合复杂路由）"></a>方案 B：保持 pasta，但指定出口接口（适合复杂路由）</h3><p>如果你必须使用 <code>pasta</code>（例如你更在意性能、或需要某些 pasta 特性），可以考虑指定正确的出公网接口，避免出口选择错误（多网卡&#x2F;VPN&#x2F;策略路由环境尤其重要）。</p><hr><h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><ul><li><strong>Docker Compose 能外网</strong>：典型是 rootful + bridge + 内核 NAT，出网路径明确。</li><li><strong>Podman Compose 外网失败（常见）</strong>：rootless 模式下网络实现不同，默认方案在某些环境里不稳定或行为不等价。</li><li><strong>最快&#x2F;最稳的修复</strong>：rootless 切换默认网络为 <code>slirp4netns</code>：</li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[network]</span><br><span class="hljs-attr">default_rootless_network_cmd</span> = <span class="hljs-string">&quot;slirp4netns&quot;</span><br></code></pre></td></tr></table></figure><p>如果你也遇到“Docker 能联网但 Podman 不行”的情况，优先检查是不是 rootless，并用以上方式切换网络实现，通常能立刻解决。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">::contentReference[oaicite:0]&#123;<span class="hljs-attribute">index</span>=0&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>运维</category>
      
      <category>容器</category>
      
    </categories>
    
    
    <tags>
      
      <tag>podman</tag>
      
      <tag>docker</tag>
      
      <tag>compose</tag>
      
      <tag>linux</tag>
      
      <tag>network</tag>
      
      <tag>rootless</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux cgroup 实现 SSH 用户资源限制指南</title>
    <link href="/2025/12/21/linux-cgroup-ssh-limit/"/>
    <url>/2025/12/21/linux-cgroup-ssh-limit/</url>
    
    <content type="html"><![CDATA[<h1 id="Linux-cgroup-实现-SSH-用户资源限制指南"><a href="#Linux-cgroup-实现-SSH-用户资源限制指南" class="headerlink" title="Linux cgroup 实现 SSH 用户资源限制指南"></a>Linux cgroup 实现 SSH 用户资源限制指南</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Linux 控制组（cgroup）是内核提供的资源管理机制，可用于限制、隔离和监控进程组（如用户会话）的资源使用。通过 systemd 与 cgroup 结合，我们可以为 SSH 登录用户设置公平的资源配额，避免单个用户过度占用 CPU、内存等系统资源，提升多用户环境的稳定性。本指南以实际脚本为例，逐步讲解配置方法。</p><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><ul><li><strong>系统要求</strong>：Linux 内核 ≥ 4.15（支持 cgroup v2），使用 systemd 作为初始化系统。</li><li><strong>权限需求</strong>：所有操作需 <code>sudo</code> 权限。</li></ul><hr><h2 id="配置步骤"><a href="#配置步骤" class="headerlink" title="配置步骤"></a>配置步骤</h2><h3 id="1-清理现有配置"><a href="#1-清理现有配置" class="headerlink" title="1. 清理现有配置"></a>1. 清理现有配置</h3><p>为避免残留配置干扰，首先清理旧配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-comment"># 清理现有配置</span><br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">rm</span> -rf /etc/systemd/system/user.slice.d/<br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">rm</span> -rf /etc/systemd/system/user-*.slice.d/<br></code></pre></td></tr></table></figure><p><strong>作用</strong>：删除可能存在的旧切片配置目录，确保配置纯净。</p><h3 id="2-设置全局资源限制"><a href="#2-设置全局资源限制" class="headerlink" title="2. 设置全局资源限制"></a>2. 设置全局资源限制</h3><p>创建全局切片配置，限制所有用户会话的总资源上限：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 使用正确的配置文件方式</span><br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">mkdir</span> -p /etc/systemd/system/user.slice.d/<br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">tee</span> /etc/systemd/system/user.slice.d/global.conf &lt;&lt; <span class="hljs-string">&#x27;EOF&#x27;</span><br>[Slice]<br>CPUQuota=400%     <span class="hljs-comment"># 限制所有用户会话合计最多使用 400% CPU（即 4 核）</span><br>MemoryMax=16G     <span class="hljs-comment"># 限制所有用户会话合计最多使用 16GB 内存</span><br>EOF<br></code></pre></td></tr></table></figure><p><strong>参数说明</strong>：</p><ul><li><code>CPUQuota=400%</code>：表示所有用户进程共享的 CPU 时间上限为 4 个核心的 100% 占用。</li><li><code>MemoryMax=16G</code>：全局内存使用硬限制。</li></ul><h3 id="3-设置单用户默认限制"><a href="#3-设置单用户默认限制" class="headerlink" title="3. 设置单用户默认限制"></a>3. 设置单用户默认限制</h3><p>创建用户级模板，为每个登录用户分配独立配额：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 创建用户默认模板（用户登录时自动应用）</span><br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">mkdir</span> -p /etc/systemd/system/user@.service.d/<br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">tee</span> /etc/systemd/system/user@.service.d/limit.conf &lt;&lt; <span class="hljs-string">&#x27;EOF&#x27;</span><br>[Service]<br>CPUWeight=100     <span class="hljs-comment"># CPU 相对权重（默认 100，值越高优先级越高）</span><br>MemoryMax=4G      <span class="hljs-comment"># 单用户内存使用上限为 4GB</span><br>EOF<br></code></pre></td></tr></table></figure><p><strong>参数说明</strong>：</p><ul><li><code>CPUWeight=100</code>：基于 CPU 时间分配的权重（范围 1–10000），值越大获得的 CPU 时间越多。</li><li><code>MemoryMax=4G</code>：单用户内存硬限制，超限时进程会被终止。</li></ul><h3 id="4-重载并生效配置"><a href="#4-重载并生效配置" class="headerlink" title="4. 重载并生效配置"></a>4. 重载并生效配置</h3><p>使新配置生效：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 重载配置</span><br><span class="hljs-built_in">sudo</span> systemctl daemon-reload<br><br><span class="hljs-comment"># 可选：重启用户切片（或重启系统）</span><br><span class="hljs-comment"># sudo systemctl restart user.slice</span><br></code></pre></td></tr></table></figure><p><strong>注意</strong>：配置立即生效，但已登录用户需重新登录才能应用新限制。</p><hr><h2 id="验证资源配置"><a href="#验证资源配置" class="headerlink" title="验证资源配置"></a>验证资源配置</h2><p>使用以下脚本检查当前 cgroup 设置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br>find /sys/fs/cgroup/user.slice -name <span class="hljs-string">&quot;cpu.max&quot;</span> -<span class="hljs-built_in">type</span> f -print0 |<br><span class="hljs-keyword">while</span> IFS= <span class="hljs-built_in">read</span> -r -d <span class="hljs-string">&#x27;&#x27;</span> file; <span class="hljs-keyword">do</span><br>  user_dir=$(<span class="hljs-built_in">dirname</span> <span class="hljs-string">&quot;<span class="hljs-variable">$file</span>&quot;</span>)<br>  cpu_limit=$(<span class="hljs-built_in">cat</span> <span class="hljs-string">&quot;<span class="hljs-variable">$file</span>&quot;</span>)<br>  mem_file=<span class="hljs-string">&quot;<span class="hljs-variable">$user_dir</span>/memory.max&quot;</span><br>  <br>  <span class="hljs-keyword">if</span> [ -f <span class="hljs-string">&quot;<span class="hljs-variable">$mem_file</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>    mem_limit=$(<span class="hljs-built_in">cat</span> <span class="hljs-string">&quot;<span class="hljs-variable">$mem_file</span>&quot;</span>)<br>  <span class="hljs-keyword">else</span><br>    mem_limit=<span class="hljs-string">&quot;未设置&quot;</span><br>  <span class="hljs-keyword">fi</span><br>  <br>  <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$user_dir</span>: CPU=<span class="hljs-variable">$cpu_limit</span>, Memory=<span class="hljs-variable">$mem_limit</span>&quot;</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><p><strong>输出示例</strong>：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">/<span class="hljs-keyword">user</span>.<span class="hljs-keyword">slice</span>/<span class="hljs-keyword">user</span><span class="hljs-number">-1000.</span><span class="hljs-keyword">slice</span>: CPU=max <span class="hljs-number">100000</span>, Memory=<span class="hljs-number">4294967296</span><br></code></pre></td></tr></table></figure><ul><li><code>CPU=max 100000</code>：表示 CPU 时间限制为 100000 微秒&#x2F;周期（即 100% 核心）。</li><li><code>Memory=4294967296</code>：内存限制字节数（此处 4GB）。</li></ul><hr><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ol><li><strong>资源分配公平性</strong>：<code>CPUWeight</code> 适用于 CPU 竞争场景，确保高权重用户获得更多资源。</li><li><strong>内存限制</strong>：<code>MemoryMax</code> 为硬限制，超限时进程会触发 OOM Killer。</li><li><strong>持久化配置</strong>：通过 systemd 配置可持久化，重启后依旧有效。</li><li><strong>调试建议</strong>：若配置未生效，检查 <code>systemd-cgls</code> 或 <code>cat /sys/fs/cgroup/user.slice/*/cpu.max</code> 验证。</li></ol><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过 cgroup 和 systemd 的集成，我们可以高效管理多用户环境下的资源分配。本指南提供的脚本可直接用于生产环境，但需根据实际硬件资源调整参数值。合理配置资源限制能显著提升系统稳定性，避免资源争夺导致的性能下降。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-comment"># 1. 清理现有配置</span><br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">rm</span> -rf /etc/systemd/system/user.slice.d/<br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">rm</span> -rf /etc/systemd/system/user-*.slice.d/<br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">rm</span> -rf /etc/systemd/system/user@.service.d/<br><br><span class="hljs-comment"># 2. 使用正确的配置文件方式</span><br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">mkdir</span> -p /etc/systemd/system/user.slice.d/<br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">tee</span> /etc/systemd/system/user.slice.d/global.conf &lt;&lt; <span class="hljs-string">&#x27;EOF&#x27;</span><br>[Slice]<br><span class="hljs-comment"># CPUQuota=400%</span><br><span class="hljs-comment"># MemoryMax=16G</span><br>CPUQuota=<br>MemoryMax=<br>EOF<br><br><span class="hljs-comment"># 3. 创建用户默认模板（这会在用户登录时自动应用）</span><br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">mkdir</span> -p /etc/systemd/system/user@.service.d/<br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">tee</span> /etc/systemd/system/user@.service.d/limit.conf &lt;&lt; <span class="hljs-string">&#x27;EOF&#x27;</span><br>[Service]<br><span class="hljs-comment"># CPUWeight=100</span><br>CPUQuota=100%<br>MemoryMax=4G<br>EOF<br><br><span class="hljs-comment"># 给 root 的 slice 覆盖掉限制</span><br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">mkdir</span> -p /etc/systemd/system/user-0.slice.d/<br><br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">tee</span> /etc/systemd/system/user-0.slice.d/override.conf &lt;&lt;<span class="hljs-string">&#x27;EOF&#x27;</span><br>[Slice]<br>CPUQuota=<br>MemoryMax=<br>EOF<br><br><span class="hljs-comment"># 给特定用户 ID（例如 990）的 slice 覆盖掉限制</span><br>slurm_id=$(<span class="hljs-built_in">id</span> -u slurm)<br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">mkdir</span> -p /etc/systemd/system/user-<span class="hljs-variable">$slurm_id</span>.slice.d/<br><br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">tee</span> /etc/systemd/system/user-<span class="hljs-variable">$slurm_id</span>.slice.d/override.conf &lt;&lt;<span class="hljs-string">&#x27;EOF&#x27;</span><br>[Slice]<br>CPUQuota=<br>MemoryMax=<br>CPUWeight=<br>EOF<br><br><span class="hljs-comment"># 4. 重载配置</span><br><span class="hljs-built_in">sudo</span> systemctl daemon-reload<br><br><span class="hljs-comment"># # 5. 重启用户切片（或重启系统）</span><br><span class="hljs-comment"># sudo systemctl restart user.slice</span><br><span class="hljs-built_in">sudo</span> systemctl restart systemd-logind<br></code></pre></td></tr></table></figure><hr><blockquote><p>本文仅用于教育目的，操作前请备份重要数据。建议在测试环境验证后再部署到生产系统。</p></blockquote>]]></content>
    
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>cgroup</tag>
      
      <tag>资源管理</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NVIDIA驱动和CUDA安装脚本 for CentOS Stream 9</title>
    <link href="/2025/12/21/install_driver/"/>
    <url>/2025/12/21/install_driver/</url>
    
    <content type="html"><![CDATA[<p>安装好centos9系统后，装好显卡，配置好网络环境。安装好NVIDIA驱动，然后安装CUDA工具包。以下是完整的安装脚本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-comment"># NVIDIA驱动和CUDA安装脚本 for CentOS Stream 9</span><br><span class="hljs-comment"># 作者: Assistant</span><br><span class="hljs-comment"># 说明: 此脚本用于在CentOS Stream 9上安装NVIDIA驱动和CUDA工具包</span><br><br><span class="hljs-built_in">set</span> -e  <span class="hljs-comment"># 遇到错误立即退出</span><br><br><span class="hljs-comment"># ========== 配置部分 ==========</span><br><span class="hljs-built_in">readonly</span> RED=<span class="hljs-string">&#x27;\033[0;31m&#x27;</span><br><span class="hljs-built_in">readonly</span> GREEN=<span class="hljs-string">&#x27;\033[0;32m&#x27;</span><br><span class="hljs-built_in">readonly</span> YELLOW=<span class="hljs-string">&#x27;\033[1;33m&#x27;</span><br><span class="hljs-built_in">readonly</span> BLUE=<span class="hljs-string">&#x27;\033[0;34m&#x27;</span><br><span class="hljs-built_in">readonly</span> NC=<span class="hljs-string">&#x27;\033[0m&#x27;</span> <span class="hljs-comment"># No Color</span><br><span class="hljs-built_in">readonly</span> ORIG_TARGET=$(systemctl get-default)<br><br><span class="hljs-built_in">readonly</span> NVIDIA_DRIVER_URL=<span class="hljs-string">&quot;https://download.nvidia.com/XFree86/Linux-x86_64/580.105.08/NVIDIA-Linux-x86_64-580.105.08.run&quot;</span><br><span class="hljs-built_in">readonly</span> NVIDIA_DRIVER_FILE=<span class="hljs-string">&quot;./NVIDIA-Linux-x86_64-580.105.08.run&quot;</span><br><span class="hljs-built_in">readonly</span> CUDA_VERSION=<span class="hljs-string">&quot;12.4.0&quot;</span><br><span class="hljs-built_in">readonly</span> CUDA_INSTALLER=<span class="hljs-string">&quot;cuda_<span class="hljs-variable">$&#123;CUDA_VERSION&#125;</span>_550.54.14_linux.run&quot;</span><br><span class="hljs-built_in">readonly</span> CUDA_URL=<span class="hljs-string">&quot;https://developer.download.nvidia.com/compute/cuda/<span class="hljs-variable">$&#123;CUDA_VERSION&#125;</span>/local_installers/<span class="hljs-variable">$&#123;CUDA_INSTALLER&#125;</span>&quot;</span><br><br><span class="hljs-comment"># ========== 日志函数 ==========</span><br><span class="hljs-function"><span class="hljs-title">log_info</span></span>() &#123;<br>    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;GREEN&#125;</span>[INFO]<span class="hljs-variable">$&#123;NC&#125;</span> <span class="hljs-variable">$1</span>&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">log_warn</span></span>() &#123;<br>    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;YELLOW&#125;</span>[WARN]<span class="hljs-variable">$&#123;NC&#125;</span> <span class="hljs-variable">$1</span>&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">log_error</span></span>() &#123;<br>    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;RED&#125;</span>[ERROR]<span class="hljs-variable">$&#123;NC&#125;</span> <span class="hljs-variable">$1</span>&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">log_step</span></span>() &#123;<br>    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;BLUE&#125;</span>[STEP]<span class="hljs-variable">$&#123;NC&#125;</span> <span class="hljs-variable">$1</span>&quot;</span><br>&#125;<br><br><span class="hljs-comment"># ========== 工具函数 ==========</span><br><span class="hljs-function"><span class="hljs-title">check_root</span></span>() &#123;<br>    <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$EUID</span> -ne 0 ]]; <span class="hljs-keyword">then</span><br>        log_error <span class="hljs-string">&quot;此脚本需要root权限运行&quot;</span><br>        log_info <span class="hljs-string">&quot;请使用: sudo bash <span class="hljs-variable">$0</span>&quot;</span><br>        <span class="hljs-built_in">exit</span> 1<br>    <span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">check_nvidia_gpu</span></span>() &#123;<br>    log_step <span class="hljs-string">&quot;1. 检查系统中是否存在NVIDIA GPU...&quot;</span><br>    <span class="hljs-keyword">if</span> lspci | grep -i nvidia &gt; /dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span><br>        log_info <span class="hljs-string">&quot;✓ 检测到NVIDIA GPU&quot;</span><br>        <span class="hljs-built_in">return</span> 0<br>    <span class="hljs-keyword">else</span><br>        log_error <span class="hljs-string">&quot;✗ 未检测到NVIDIA GPU&quot;</span><br>        <span class="hljs-built_in">return</span> 1<br>    <span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-comment"># ========== 系统配置函数 ==========</span><br><span class="hljs-function"><span class="hljs-title">update_system</span></span>() &#123;<br>    log_step <span class="hljs-string">&quot;2. 正在更新系统...&quot;</span><br>    dnf update -y<br>    log_info <span class="hljs-string">&quot;✓ 系统更新完成&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">configure_repos</span></span>() &#123;<br>    log_step <span class="hljs-string">&quot;3. 配置软件仓库...&quot;</span><br>    <br>    <span class="hljs-comment"># 更新DNF缓存</span><br>    dnf makecache -y<br>    <br>    <span class="hljs-comment"># 启用CRB仓库</span><br>    log_info <span class="hljs-string">&quot;启用CRB仓库...&quot;</span><br>    dnf config-manager --set-enabled crb<br>    <br>    <span class="hljs-comment"># 安装EPEL仓库</span><br>    log_info <span class="hljs-string">&quot;安装EPEL仓库...&quot;</span><br>    dnf install -y epel-release epel-next-release<br>    <br>    <span class="hljs-comment"># 再次更新缓存</span><br>    dnf makecache -y<br>    log_info <span class="hljs-string">&quot;✓ 仓库配置完成&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">install_dependencies</span></span>() &#123;<br>    log_step <span class="hljs-string">&quot;4. 安装编译依赖...&quot;</span><br>    <br>    <span class="hljs-comment"># 获取内核版本</span><br>    KERNEL_VERSION=$(<span class="hljs-built_in">uname</span> -r)<br>    log_info <span class="hljs-string">&quot;当前内核版本: <span class="hljs-variable">$KERNEL_VERSION</span>&quot;</span><br>    <br>    <span class="hljs-comment"># 安装依赖包</span><br>    dnf install -y \<br>        kernel-headers-<span class="hljs-variable">$&#123;KERNEL_VERSION&#125;</span> \<br>        kernel-devel-<span class="hljs-variable">$&#123;KERNEL_VERSION&#125;</span> \<br>        tar \<br>        bzip2 \<br>        make \<br>        automake \<br>        gcc \<br>        gcc-c++ \<br>        pciutils \<br>        elfutils-libelf-devel \<br>        libglvnd-opengl \<br>        libglvnd-glx \<br>        libglvnd-devel \<br>        acpid \<br>        pkgconfig \<br>        dkms \<br>        wget<br>    <br>    log_info <span class="hljs-string">&quot;✓ 依赖安装完成&quot;</span><br>&#125;<br><br><span class="hljs-comment"># ========== Nouveau驱动处理 ==========</span><br><span class="hljs-function"><span class="hljs-title">disable_nouveau</span></span>() &#123;<br>    log_step <span class="hljs-string">&quot;5. 禁用Nouveau驱动...&quot;</span><br>    <br>    <span class="hljs-comment"># 创建黑名单文件</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;blacklist nouveau&#x27;</span> &gt; /etc/modprobe.d/blacklist-nouveau.conf<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;options nouveau modeset=0&#x27;</span> &gt;&gt; /etc/modprobe.d/blacklist-nouveau.conf<br>    <br>    <span class="hljs-comment"># 备份原有initramfs</span><br>    <span class="hljs-built_in">local</span> initramfs_file=<span class="hljs-string">&quot;/boot/initramfs-<span class="hljs-subst">$(uname -r)</span>.img&quot;</span><br>    <span class="hljs-keyword">if</span> [ -f <span class="hljs-string">&quot;<span class="hljs-variable">$initramfs_file</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">cp</span> <span class="hljs-string">&quot;<span class="hljs-variable">$initramfs_file</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;initramfs_file&#125;</span>.backup&quot;</span><br>    <span class="hljs-keyword">fi</span><br>    <br>    <span class="hljs-comment"># 更新initramfs</span><br>    dracut --force<br>    <br>    log_info <span class="hljs-string">&quot;✓ Nouveau驱动已禁用&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">verify_nouveau_disabled</span></span>() &#123;<br>    log_step <span class="hljs-string">&quot;6. 验证Nouveau驱动状态...&quot;</span><br>    <span class="hljs-keyword">if</span> lsmod | grep nouveau &gt; /dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span><br>        log_error <span class="hljs-string">&quot;✗ Nouveau驱动仍在运行&quot;</span><br>        <span class="hljs-built_in">return</span> 1<br>    <span class="hljs-keyword">else</span><br>        log_info <span class="hljs-string">&quot;✓ Nouveau驱动已成功禁用&quot;</span><br>        <span class="hljs-built_in">return</span> 0<br>    <span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-comment"># ========== 下载函数 ==========</span><br><span class="hljs-function"><span class="hljs-title">download_file</span></span>() &#123;<br>    <span class="hljs-built_in">local</span> url=<span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span><br>    <span class="hljs-built_in">local</span> filename=<span class="hljs-string">&quot;<span class="hljs-variable">$2</span>&quot;</span><br>    <span class="hljs-built_in">local</span> description=<span class="hljs-string">&quot;<span class="hljs-variable">$3</span>&quot;</span><br>    <br>    <span class="hljs-keyword">if</span> [ -f <span class="hljs-string">&quot;<span class="hljs-variable">$filename</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>        log_info <span class="hljs-string">&quot;✓ <span class="hljs-variable">$&#123;description&#125;</span>文件已存在: <span class="hljs-variable">$filename</span>&quot;</span><br>        <span class="hljs-built_in">return</span> 0<br>    <span class="hljs-keyword">fi</span><br>    <br>    log_info <span class="hljs-string">&quot;正在下载<span class="hljs-variable">$&#123;description&#125;</span>...&quot;</span><br>    <span class="hljs-keyword">if</span> wget -q --show-progress <span class="hljs-string">&quot;<span class="hljs-variable">$url</span>&quot;</span> -O <span class="hljs-string">&quot;<span class="hljs-variable">$filename</span>&quot;</span>; <span class="hljs-keyword">then</span><br>        log_info <span class="hljs-string">&quot;✓ <span class="hljs-variable">$&#123;description&#125;</span>下载完成&quot;</span><br>        <span class="hljs-built_in">return</span> 0<br>    <span class="hljs-keyword">else</span><br>        log_error <span class="hljs-string">&quot;✗ <span class="hljs-variable">$&#123;description&#125;</span>下载失败&quot;</span><br>        log_info <span class="hljs-string">&quot;请手动下载: <span class="hljs-variable">$url</span>&quot;</span><br>        <span class="hljs-built_in">return</span> 1<br>    <span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">download_nvidia_driver</span></span>() &#123;<br>    log_step <span class="hljs-string">&quot;7. 下载NVIDIA驱动...&quot;</span><br>    download_file <span class="hljs-string">&quot;<span class="hljs-variable">$NVIDIA_DRIVER_URL</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$NVIDIA_DRIVER_FILE</span>&quot;</span> <span class="hljs-string">&quot;NVIDIA驱动&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">download_cuda</span></span>() &#123;<br>    log_step <span class="hljs-string">&quot;9. 下载CUDA工具包...&quot;</span><br>    download_file <span class="hljs-string">&quot;<span class="hljs-variable">$CUDA_URL</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$CUDA_INSTALLER</span>&quot;</span> <span class="hljs-string">&quot;CUDA <span class="hljs-variable">$&#123;CUDA_VERSION&#125;</span>&quot;</span><br>&#125;<br><br><span class="hljs-comment"># ========== NVIDIA驱动安装 ==========</span><br><span class="hljs-function"><span class="hljs-title">switch_to_text_mode</span></span>() &#123;<br>    log_info <span class="hljs-string">&quot;切换到文本模式...&quot;</span><br>    <span class="hljs-comment"># systemctl set-default multi-user.target</span><br>    systemctl isolate multi-user.target<br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">restore_target</span></span>() &#123;<br>  log_info <span class="hljs-string">&quot;恢复默认启动目标: <span class="hljs-variable">$ORIG_TARGET</span>&quot;</span><br>  systemctl set-default <span class="hljs-string">&quot;<span class="hljs-variable">$ORIG_TARGET</span>&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">install_nvidia_driver_silent</span></span>() &#123;<br>    log_info <span class="hljs-string">&quot;尝试静默安装NVIDIA驱动...&quot;</span><br>    <br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;<span class="hljs-variable">$NVIDIA_DRIVER_FILE</span>&quot;</span> \<br>        --silent \<br>        --no-nouveau-check \<br>        --no-x-check \<br>        --no-questions \<br>        --accept-license \<br>        --disable-nouveau \<br>        --install-libglvnd \<br>        --dkms; <span class="hljs-keyword">then</span><br>        log_info <span class="hljs-string">&quot;✓ NVIDIA驱动安装成功（静默模式）&quot;</span><br>        <span class="hljs-built_in">return</span> 0<br>    <span class="hljs-keyword">fi</span><br>    <span class="hljs-built_in">return</span> 1<br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">install_nvidia_driver_interactive</span></span>() &#123;<br>    log_info <span class="hljs-string">&quot;尝试交互模式安装NVIDIA驱动...&quot;</span><br>    <br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;<span class="hljs-variable">$NVIDIA_DRIVER_FILE</span>&quot;</span> --no-x-check; <span class="hljs-keyword">then</span><br>        log_info <span class="hljs-string">&quot;✓ NVIDIA驱动安装成功（交互模式）&quot;</span><br>        <span class="hljs-built_in">return</span> 0<br>    <span class="hljs-keyword">fi</span><br>    <span class="hljs-built_in">return</span> 1<br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">install_nvidia_driver</span></span>() &#123;<br>    log_step <span class="hljs-string">&quot;8. 安装NVIDIA驱动...&quot;</span><br>    <br>    <span class="hljs-comment"># 检查驱动文件是否存在</span><br>    <span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">&quot;<span class="hljs-variable">$NVIDIA_DRIVER_FILE</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>        log_error <span class="hljs-string">&quot;✗ 未找到NVIDIA驱动文件: <span class="hljs-variable">$NVIDIA_DRIVER_FILE</span>&quot;</span><br>        <span class="hljs-built_in">return</span> 1<br>    <span class="hljs-keyword">fi</span><br>    <br>    <span class="hljs-comment"># 赋予执行权限</span><br>    <span class="hljs-built_in">chmod</span> +x <span class="hljs-string">&quot;<span class="hljs-variable">$NVIDIA_DRIVER_FILE</span>&quot;</span><br>    <br>    <span class="hljs-comment"># 切换到文本模式</span><br>    switch_to_text_mode<br>    <br>    <span class="hljs-comment"># 安装驱动</span><br>    log_info <span class="hljs-string">&quot;开始安装NVIDIA驱动...&quot;</span><br>    log_info <span class="hljs-string">&quot;安装过程可能需要几分钟，请耐心等待...&quot;</span><br>    <br>    <span class="hljs-comment"># 先尝试静默安装</span><br>    <span class="hljs-keyword">if</span> install_nvidia_driver_silent; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">return</span> 0<br>    <span class="hljs-keyword">fi</span><br>    <br>    <span class="hljs-comment"># 静默安装失败，尝试交互模式</span><br>    log_warn <span class="hljs-string">&quot;静默安装失败，尝试交互模式安装...&quot;</span><br>    <span class="hljs-keyword">if</span> install_nvidia_driver_interactive; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">return</span> 0<br>    <span class="hljs-keyword">fi</span><br>    <br>    <span class="hljs-comment"># 两种方式都失败</span><br>    log_error <span class="hljs-string">&quot;✗ NVIDIA驱动安装完全失败&quot;</span><br>    <span class="hljs-built_in">return</span> 1<br>&#125;<br><br><span class="hljs-comment"># ========== CUDA安装 ==========</span><br><span class="hljs-function"><span class="hljs-title">install_cuda_toolkit</span></span>() &#123;<br>    log_step <span class="hljs-string">&quot;10. 安装CUDA工具包...&quot;</span><br>    <br>    <span class="hljs-comment"># 检查CUDA安装文件</span><br>    <span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">&quot;<span class="hljs-variable">$CUDA_INSTALLER</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>        log_error <span class="hljs-string">&quot;✗ 未找到CUDA安装文件: <span class="hljs-variable">$CUDA_INSTALLER</span>&quot;</span><br>        <span class="hljs-built_in">return</span> 1<br>    <span class="hljs-keyword">fi</span><br>    <br>    <span class="hljs-comment"># 赋予执行权限</span><br>    <span class="hljs-built_in">chmod</span> +x <span class="hljs-string">&quot;<span class="hljs-variable">$CUDA_INSTALLER</span>&quot;</span><br>    <br>    <span class="hljs-comment"># 安装CUDA（不安装驱动）</span><br>    log_info <span class="hljs-string">&quot;开始安装CUDA <span class="hljs-variable">$&#123;CUDA_VERSION&#125;</span>...&quot;</span><br>    log_info <span class="hljs-string">&quot;安装过程可能需要几分钟，请耐心等待...&quot;</span><br>    <br>    <span class="hljs-comment"># 创建安装日志</span><br>    <span class="hljs-built_in">local</span> install_log=<span class="hljs-string">&quot;/tmp/cuda_install.log&quot;</span><br>    <br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;./<span class="hljs-variable">$CUDA_INSTALLER</span>&quot;</span> \<br>        --silent \<br>        --toolkit \<br>        --override \<br>        --no-man-page \<br>        --no-opengl-libs \<br>        --installpath=/usr/local/cuda-<span class="hljs-variable">$&#123;CUDA_VERSION&#125;</span> &gt; <span class="hljs-string">&quot;<span class="hljs-variable">$install_log</span>&quot;</span> 2&gt;&amp;1; <span class="hljs-keyword">then</span><br>        log_info <span class="hljs-string">&quot;✓ CUDA安装成功&quot;</span><br>        <br>        <span class="hljs-comment"># 创建符号链接</span><br>        create_cuda_symlink<br>        <span class="hljs-built_in">return</span> 0<br>    <span class="hljs-keyword">else</span><br>        log_error <span class="hljs-string">&quot;✗ CUDA安装失败&quot;</span><br>        log_info <span class="hljs-string">&quot;安装日志: <span class="hljs-variable">$install_log</span>&quot;</span><br>        <span class="hljs-built_in">return</span> 1<br>    <span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">create_cuda_symlink</span></span>() &#123;<br>    log_info <span class="hljs-string">&quot;创建CUDA符号链接...&quot;</span><br>    <span class="hljs-built_in">ln</span> -sf /usr/local/cuda-<span class="hljs-variable">$&#123;CUDA_VERSION&#125;</span> /usr/local/cuda<br>&#125;<br><br><span class="hljs-comment"># ========== 环境配置 ==========</span><br><span class="hljs-function"><span class="hljs-title">configure_environment</span></span>() &#123;<br>    log_step <span class="hljs-string">&quot;11. 配置环境变量...&quot;</span><br>    <br>    <span class="hljs-comment"># 备份原有配置文件</span><br>    <span class="hljs-built_in">local</span> bashrc_file=<span class="hljs-string">&quot;/etc/bashrc&quot;</span><br>    <span class="hljs-keyword">if</span> [ -f <span class="hljs-string">&quot;<span class="hljs-variable">$bashrc_file</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">cp</span> <span class="hljs-string">&quot;<span class="hljs-variable">$bashrc_file</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;bashrc_file&#125;</span>.backup.<span class="hljs-subst">$(date +%Y%m%d_%H%M%S)</span>&quot;</span><br>    <span class="hljs-keyword">fi</span><br>    <br>    <span class="hljs-comment"># 添加CUDA环境变量</span><br>    <span class="hljs-built_in">cat</span> &gt;&gt; <span class="hljs-string">&quot;<span class="hljs-variable">$bashrc_file</span>&quot;</span> &lt;&lt; <span class="hljs-string">&#x27;EOF&#x27;</span><br><br><span class="hljs-comment"># CUDA Environment Variables</span><br><span class="hljs-built_in">export</span> PATH=/usr/local/cuda/bin:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=/usr/local/cuda/lib64:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br><span class="hljs-built_in">export</span> CUDA_HOME=/usr/local/cuda<br>EOF<br>    <br>    log_info <span class="hljs-string">&quot;✓ 环境变量已配置&quot;</span><br>    log_info <span class="hljs-string">&quot;请运行 &#x27;source /etc/bashrc&#x27; 或重新登录使配置生效&quot;</span><br>&#125;<br><br><span class="hljs-comment"># ========== 验证安装 ==========</span><br><span class="hljs-function"><span class="hljs-title">verify_nvidia_driver</span></span>() &#123;<br>    log_step <span class="hljs-string">&quot;12. 验证NVIDIA驱动安装...&quot;</span><br>    <br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v nvidia-smi &gt; /dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span><br>        log_info <span class="hljs-string">&quot;✓ NVIDIA驱动安装成功&quot;</span><br>        log_info <span class="hljs-string">&quot;显示GPU信息:&quot;</span><br>        nvidia-smi<br>        <span class="hljs-built_in">return</span> 0<br>    <span class="hljs-keyword">else</span><br>        log_error <span class="hljs-string">&quot;✗ NVIDIA驱动未正确安装&quot;</span><br>        <span class="hljs-built_in">return</span> 1<br>    <span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">verify_cuda_installation</span></span>() &#123;<br>    log_step <span class="hljs-string">&quot;13. 验证CUDA安装...&quot;</span><br>    <br>    <span class="hljs-keyword">if</span> [ -d <span class="hljs-string">&quot;/usr/local/cuda&quot;</span> ]; <span class="hljs-keyword">then</span><br>        log_info <span class="hljs-string">&quot;✓ CUDA目录存在: /usr/local/cuda&quot;</span><br>        <br>        <span class="hljs-comment"># 检查nvcc</span><br>        <span class="hljs-keyword">if</span> [ -f <span class="hljs-string">&quot;/usr/local/cuda/bin/nvcc&quot;</span> ]; <span class="hljs-keyword">then</span><br>            log_info <span class="hljs-string">&quot;✓ nvcc编译器存在&quot;</span><br>            log_info <span class="hljs-string">&quot;CUDA版本:&quot;</span><br>            /usr/local/cuda/bin/nvcc --version | grep release<br>            <span class="hljs-built_in">return</span> 0<br>        <span class="hljs-keyword">else</span><br>            log_error <span class="hljs-string">&quot;✗ nvcc编译器未找到&quot;</span><br>            <span class="hljs-built_in">return</span> 1<br>        <span class="hljs-keyword">fi</span><br>    <span class="hljs-keyword">else</span><br>        log_error <span class="hljs-string">&quot;✗ CUDA目录不存在&quot;</span><br>        <span class="hljs-built_in">return</span> 1<br>    <span class="hljs-keyword">fi</span><br>&#125;<br><br><span class="hljs-comment"># ========== 清理函数 ==========</span><br><span class="hljs-function"><span class="hljs-title">cleanup_installation_files</span></span>() &#123;<br>    log_step <span class="hljs-string">&quot;14. 清理安装文件...&quot;</span><br>    <br>    <span class="hljs-built_in">local</span> files_to_remove=(<br>        <span class="hljs-string">&quot;<span class="hljs-variable">$NVIDIA_DRIVER_FILE</span>&quot;</span><br>        <span class="hljs-string">&quot;<span class="hljs-variable">$CUDA_INSTALLER</span>&quot;</span><br>        <span class="hljs-string">&quot;/tmp/cuda_install.log&quot;</span><br>    )<br>    <br>    <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;files_to_remove[@]&#125;</span>&quot;</span>; <span class="hljs-keyword">do</span><br>        <span class="hljs-keyword">if</span> [ -f <span class="hljs-string">&quot;<span class="hljs-variable">$file</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">rm</span> -f <span class="hljs-string">&quot;<span class="hljs-variable">$file</span>&quot;</span><br>            log_info <span class="hljs-string">&quot;已删除: <span class="hljs-variable">$file</span>&quot;</span><br>        <span class="hljs-keyword">fi</span><br>    <span class="hljs-keyword">done</span><br>    <br>    log_info <span class="hljs-string">&quot;✓ 清理完成&quot;</span><br>&#125;<br><br><span class="hljs-comment"># ========== 重启提示 ==========</span><br><span class="hljs-function"><span class="hljs-title">show_reboot_prompt</span></span>() &#123;<br>    log_step <span class="hljs-string">&quot;15. 安装完成！&quot;</span><br>    <br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;==========================================&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;安装总结:&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;------------------------------------------&quot;</span><br>    <br>    <span class="hljs-keyword">if</span> verify_nvidia_driver; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;✓ NVIDIA驱动: 已安装&quot;</span><br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;✗ NVIDIA驱动: 安装失败&quot;</span><br>    <span class="hljs-keyword">fi</span><br>    <br>    <span class="hljs-keyword">if</span> verify_cuda_installation; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;✓ CUDA工具包: 已安装&quot;</span><br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;✗ CUDA工具包: 安装失败&quot;</span><br>    <span class="hljs-keyword">fi</span><br>    <br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;------------------------------------------&quot;</span><br>    log_warn <span class="hljs-string">&quot;重要提示: 系统需要重启以完成安装&quot;</span><br>    log_info <span class="hljs-string">&quot;请执行以下命令重启系统:&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;  sudo reboot&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;==========================================&quot;</span><br>&#125;<br><br><span class="hljs-comment"># ========== 主安装流程 ==========</span><br><span class="hljs-function"><span class="hljs-title">main_installation</span></span>() &#123;<br>    log_info <span class="hljs-string">&quot;开始NVIDIA驱动和CUDA安装流程...&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;==========================================&quot;</span><br>    <br>    <span class="hljs-comment"># 前置检查</span><br>    check_root<br>    <span class="hljs-keyword">if</span> ! check_nvidia_gpu; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">exit</span> 1<br>    <span class="hljs-keyword">fi</span><br>    <br>    <span class="hljs-comment"># 系统配置</span><br>    update_system<br>    configure_repos<br>    install_dependencies<br>    <br>    <span class="hljs-comment"># Nouveau驱动处理</span><br>    disable_nouveau<br>    <span class="hljs-keyword">if</span> ! verify_nouveau_disabled; <span class="hljs-keyword">then</span><br>        log_warn <span class="hljs-string">&quot;Nouveau驱动可能仍在运行，建议重启后继续&quot;</span><br>        <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;是否继续安装？(y/n): &quot;</span> -n 1 -r<br>        <span class="hljs-built_in">echo</span><br>        <span class="hljs-keyword">if</span> [[ ! <span class="hljs-variable">$REPLY</span> =~ ^[Yy]$ ]]; <span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">exit</span> 1<br>        <span class="hljs-keyword">fi</span><br>    <span class="hljs-keyword">fi</span><br>    <br>    <span class="hljs-comment"># NVIDIA驱动安装</span><br>    <span class="hljs-keyword">if</span> ! download_nvidia_driver; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">exit</span> 1<br>    <span class="hljs-keyword">fi</span><br>    <br>    <span class="hljs-keyword">if</span> ! install_nvidia_driver; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">exit</span> 1<br>    <span class="hljs-keyword">fi</span><br>    <br>    <span class="hljs-comment"># CUDA安装</span><br>    <span class="hljs-keyword">if</span> ! download_cuda; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">exit</span> 1<br>    <span class="hljs-keyword">fi</span><br>    <br>    <span class="hljs-keyword">if</span> ! install_cuda_toolkit; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">exit</span> 1<br>    <span class="hljs-keyword">fi</span><br>    <br>    <span class="hljs-comment"># 后续配置</span><br>    configure_environment<br>    cleanup_installation_files<br>    <br>    <span class="hljs-comment"># 验证和提示</span><br>    verify_nvidia_driver<br>    verify_cuda_installation<br>    show_reboot_prompt<br>    <br>    log_info <span class="hljs-string">&quot;安装脚本执行完毕！&quot;</span><br>&#125;<br><br><span class="hljs-comment"># ========== 错误处理 ==========</span><br><span class="hljs-function"><span class="hljs-title">handle_error</span></span>() &#123;<br>    <span class="hljs-built_in">local</span> exit_code=$?<br>    log_error <span class="hljs-string">&quot;脚本执行失败，退出码: <span class="hljs-variable">$exit_code</span>&quot;</span><br>    log_info <span class="hljs-string">&quot;请检查上述错误信息并解决问题后重试&quot;</span><br>    <span class="hljs-built_in">exit</span> <span class="hljs-variable">$exit_code</span><br>&#125;<br><br><span class="hljs-comment"># ========== 脚本入口 ==========</span><br><span class="hljs-function"><span class="hljs-title">main</span></span>() &#123;<br>    <span class="hljs-comment"># 设置错误处理</span><br>    <span class="hljs-built_in">trap</span> <span class="hljs-string">&#x27;handle_error&#x27;</span> ERR<br>    <br>    <span class="hljs-comment"># 显示欢迎信息</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;==========================================&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;NVIDIA驱动和CUDA安装脚本&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;适用于: CentOS Stream 9&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;==========================================&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;配置信息:&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;  NVIDIA驱动版本: 580.105.08&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;  CUDA版本: <span class="hljs-variable">$&#123;CUDA_VERSION&#125;</span>&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;==========================================&quot;</span><br>    <br>    <span class="hljs-comment"># 确认继续</span><br>    <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;是否继续安装？(y/n): &quot;</span> -n 1 -r<br>    <span class="hljs-built_in">echo</span><br>    <span class="hljs-keyword">if</span> [[ ! <span class="hljs-variable">$REPLY</span> =~ ^[Yy]$ ]]; <span class="hljs-keyword">then</span><br>        log_info <span class="hljs-string">&quot;安装已取消&quot;</span><br>        <span class="hljs-built_in">exit</span> 0<br>    <span class="hljs-keyword">fi</span><br>    <br>    <span class="hljs-comment"># 执行主安装流程</span><br>    main_installation<br>&#125;<br><br><span class="hljs-comment"># 执行主函数</span><br>main <span class="hljs-string">&quot;<span class="hljs-variable">$@</span>&quot;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>CentOS Stream 9 单节点 Slurm 集群部署指南</title>
    <link href="/2025/12/20/slurm-server/"/>
    <url>/2025/12/20/slurm-server/</url>
    
    <content type="html"><![CDATA[<p>本文提供 CentOS Stream 9 单节点环境下安装配置 Slurm（含 slurmctld + slurmd）的标准流程，适用于开发、测试及单机调度场景。</p><h2 id="一、环境假设与目标架构"><a href="#一、环境假设与目标架构" class="headerlink" title="一、环境假设与目标架构"></a>一、环境假设与目标架构</h2><h3 id="1-环境假设"><a href="#1-环境假设" class="headerlink" title="1. 环境假设"></a>1. 环境假设</h3><ul><li>操作系统：CentOS Stream 9（最小化或标准安装）</li><li>主机名：node1</li><li>IP：192.168.1.10（示例）</li><li>角色：<ul><li>控制节点（Controller）：node1</li><li>计算节点（Compute）：node1</li></ul></li></ul><h3 id="2-Slurm-组件"><a href="#2-Slurm-组件" class="headerlink" title="2. Slurm 组件"></a>2. Slurm 组件</h3><ul><li>slurmctld：控制守护进程</li><li>slurmd：计算节点守护进程</li><li>slurmdbd：单机测试通常不需要</li></ul><h2 id="二、系统基础准备"><a href="#二、系统基础准备" class="headerlink" title="二、系统基础准备"></a>二、系统基础准备</h2><h3 id="1-设置主机名与-hosts"><a href="#1-设置主机名与-hosts" class="headerlink" title="1. 设置主机名与 hosts"></a>1. 设置主机名与 hosts</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">hostnamectl set-hostname node1<br><span class="hljs-built_in">cat</span> &gt;&gt; /etc/hosts &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string"># 192.168.1.10   node1</span><br><span class="hljs-string">127.0.0.1   node1</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure><h3 id="2-关闭防火墙（可选，测试环境建议）"><a href="#2-关闭防火墙（可选，测试环境建议）" class="headerlink" title="2. 关闭防火墙（可选，测试环境建议）"></a>2. 关闭防火墙（可选，测试环境建议）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl <span class="hljs-built_in">disable</span> --now firewalld<br></code></pre></td></tr></table></figure><h3 id="3-关闭-SELinux（可选，测试环境建议）"><a href="#3-关闭-SELinux（可选，测试环境建议）" class="headerlink" title="3. 关闭 SELinux（可选，测试环境建议）"></a>3. 关闭 SELinux（可选，测试环境建议）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">sed -i <span class="hljs-string">&#x27;s/^SELINUX=.*/SELINUX=disabled/&#x27;</span> /etc/selinux/config<br>setenforce 0<br></code></pre></td></tr></table></figure><h2 id="三、安装-Slurm-及依赖"><a href="#三、安装-Slurm-及依赖" class="headerlink" title="三、安装 Slurm 及依赖"></a>三、安装 Slurm 及依赖</h2><p>CentOS 9 官方仓库已包含 Slurm，无需自行编译。</p><h3 id="1-安装-EPEL"><a href="#1-安装-EPEL" class="headerlink" title="1. 安装 EPEL"></a>1. 安装 EPEL</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">dnf install -y epel-release<br></code></pre></td></tr></table></figure><h3 id="2-安装-Slurm"><a href="#2-安装-Slurm" class="headerlink" title="2. 安装 Slurm"></a>2. 安装 Slurm</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">dnf install -y slurm slurm-slurmd slurm-slurmctld munge<br></code></pre></td></tr></table></figure><h2 id="四、配置-Munge（Slurm-认证核心）"><a href="#四、配置-Munge（Slurm-认证核心）" class="headerlink" title="四、配置 Munge（Slurm 认证核心）"></a>四、配置 Munge（Slurm 认证核心）</h2><p>Slurm 强依赖 munge 进行节点认证。</p><h3 id="1-创建-munge-key"><a href="#1-创建-munge-key" class="headerlink" title="1. 创建 munge key"></a>1. 创建 munge key</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/usr/sbin/create-munge-key<br></code></pre></td></tr></table></figure><h3 id="2-设置权限（可选，测试环境建议）"><a href="#2-设置权限（可选，测试环境建议）" class="headerlink" title="2. 设置权限（可选，测试环境建议）"></a>2. 设置权限（可选，测试环境建议）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chown</span> -R munge:munge /etc/munge /var/lib/munge /var/log/munge<br><span class="hljs-built_in">chmod</span> 400 /etc/munge/munge.key<br></code></pre></td></tr></table></figure><h3 id="3-启动-munge"><a href="#3-启动-munge" class="headerlink" title="3. 启动 munge"></a>3. 启动 munge</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl <span class="hljs-built_in">enable</span> --now munge<br></code></pre></td></tr></table></figure><h3 id="4-验证-munge"><a href="#4-验证-munge" class="headerlink" title="4. 验证 munge"></a>4. 验证 munge</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">munge -n | unmunge<br></code></pre></td></tr></table></figure><p>正常应看到：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">STATUS</span>:          Success (<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><h2 id="五、创建-Slurm-用户与目录"><a href="#五、创建-Slurm-用户与目录" class="headerlink" title="五、创建 Slurm 用户与目录"></a>五、创建 Slurm 用户与目录</h2><h3 id="1-创建-slurm-用户"><a href="#1-创建-slurm-用户" class="headerlink" title="1. 创建 slurm 用户"></a>1. 创建 slurm 用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">useradd -r -s /sbin/nologin slurm<br></code></pre></td></tr></table></figure><h3 id="2-创建必要目录"><a href="#2-创建必要目录" class="headerlink" title="2. 创建必要目录"></a>2. 创建必要目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /var/spool/slurm/&#123;ctld,d&#125;<br><span class="hljs-built_in">mkdir</span> -p /var/log/slurm<br><span class="hljs-built_in">chown</span> -R slurm:slurm /var/spool/slurm /var/log/slurm<br></code></pre></td></tr></table></figure><h2 id="六、配置-slurm-conf（核心）"><a href="#六、配置-slurm-conf（核心）" class="headerlink" title="六、配置 slurm.conf（核心）"></a>六、配置 slurm.conf（核心）</h2><h3 id="1-生成基础模板"><a href="#1-生成基础模板" class="headerlink" title="1. 生成基础模板"></a>1. 生成基础模板</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cp</span> /etc/slurm/slurm.conf.example /etc/slurm/slurm.conf<br></code></pre></td></tr></table></figure><h3 id="2-编辑-etc-slurm-slurm-conf"><a href="#2-编辑-etc-slurm-slurm-conf" class="headerlink" title="2. 编辑 &#x2F;etc&#x2F;slurm&#x2F;slurm.conf"></a>2. 编辑 &#x2F;etc&#x2F;slurm&#x2F;slurm.conf</h3><p>最小可用单机配置示例：</p><p>slurm.conf 示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs conf">############################<br># 基本集群信息<br>############################<br>ClusterName=single_cluster<br>SlurmctldHost=node1(127.0.0.1)<br>SlurmUser=slurm<br>SlurmdUser=root<br><br>############################<br># 端口<br>############################<br>SlurmctldPort=6817<br>SlurmdPort=6818<br><br>############################<br># 状态与日志<br>############################<br>StateSaveLocation=/var/spool/slurm/ctld<br>SlurmdSpoolDir=/var/spool/slurm/d<br>SlurmctldLogFile=/var/log/slurm/slurmctld.log<br>SlurmdLogFile=/var/log/slurm/slurmd.log<br><br>############################<br># 认证<br>############################<br>AuthType=auth/munge<br>CryptoType=crypto/munge<br><br>############################<br># 调度器<br>############################<br>SchedulerType=sched/backfill<br>SchedulerParameters=bf_continue,bf_interval=30<br><br>############################<br># 资源选择（关键）<br>############################<br>SelectType=select/cons_res<br>SelectTypeParameters=CR_Core_Memory<br><br>############################<br># cgroup（生产必开）<br>############################<br>ProctrackType=proctrack/cgroup<br>TaskPlugin=task/cgroup<br># TaskPluginParam=Sched<br>JobAcctGatherType=jobacct_gather/cgroup<br><br>############################<br># 进程跟踪 / 清理<br>############################<br>KillOnBadExit=1<br>ReturnToService=2<br><br>############################<br># 超时<br>############################<br>SlurmctldTimeout=300<br>SlurmdTimeout=300<br><br>############################<br># 节点定义（按真实资源）<br>############################<br>NodeName=node1 \<br>  CPUs=56 \<br>  RealMemory=128027 \<br>  Sockets=2 \<br>  CoresPerSocket=28 \<br>  ThreadsPerCore=1 \<br>  Gres=gpu:V100:8 \<br>  State=UNKNOWN<br><br>GresTypes=gpu<br><br>############################<br># 分区定义<br>############################<br>PartitionName=debug \<br>  Nodes=node1 \<br>  Default=YES \<br>  MaxTime=1:00:00 \<br>  State=UP<br><br>PartitionName=normal \<br>  Nodes=node1 \<br>  MaxTime=7-00:00:00 \<br>  State=UP<br></code></pre></td></tr></table></figure><p>cgroup.conf 示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs conf">###<br>#<br># Slurm cgroup support configuration file<br>#<br># See man slurm.conf and man cgroup.conf for further<br># information on cgroup configuration parameters<br>#--<br>CgroupMountpoint=/sys/fs/cgroup<br>CgroupAutomount=yes<br><br>ConstrainCores=yes<br>ConstrainRAMSpace=yes<br>ConstrainSwapSpace=yes<br>ConstrainDevices=yes<br><br>AllowedRAMSpace=100<br>AllowedSwapSpace=0<br><br>MaxRAMPercent=98<br>MaxSwapPercent=0<br><br>MinRAMSpace=30<br></code></pre></td></tr></table></figure><p><strong>注意</strong>：</p><ul><li><code>CPUs</code> 和 <code>RealMemory</code> 根据 <code>lscpu</code>、<code>free -m</code> 实际调整</li><li><code>NodeName</code> 必须与 hostname 完全一致</li></ul><h2 id="七、启动-Slurm-服务"><a href="#七、启动-Slurm-服务" class="headerlink" title="七、启动 Slurm 服务"></a>七、启动 Slurm 服务</h2><h3 id="1-启动-slurmctld"><a href="#1-启动-slurmctld" class="headerlink" title="1. 启动 slurmctld"></a>1. 启动 slurmctld</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl <span class="hljs-built_in">enable</span> --now slurmctld<br></code></pre></td></tr></table></figure><h3 id="2-启动-slurmd"><a href="#2-启动-slurmd" class="headerlink" title="2. 启动 slurmd"></a>2. 启动 slurmd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl <span class="hljs-built_in">enable</span> --now slurmd<br></code></pre></td></tr></table></figure><h2 id="八、验证-Slurm-状态"><a href="#八、验证-Slurm-状态" class="headerlink" title="八、验证 Slurm 状态"></a>八、验证 Slurm 状态</h2><h3 id="1-查看节点状态"><a href="#1-查看节点状态" class="headerlink" title="1. 查看节点状态"></a>1. 查看节点状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sinfo<br></code></pre></td></tr></table></figure><p>期望输出：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">PARTITION</span> AVAIL  TIMELIMIT  NODES  STATE NODELIST<br><span class="hljs-literal">debug</span>        up   infinite      <span class="hljs-number">1</span>   idle node1<br></code></pre></td></tr></table></figure><h3 id="2-查看节点详情"><a href="#2-查看节点详情" class="headerlink" title="2. 查看节点详情"></a>2. 查看节点详情</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">scontrol show node node1<br></code></pre></td></tr></table></figure><h2 id="九、提交测试任务"><a href="#九、提交测试任务" class="headerlink" title="九、提交测试任务"></a>九、提交测试任务</h2><h3 id="1-交互式任务"><a href="#1-交互式任务" class="headerlink" title="1. 交互式任务"></a>1. 交互式任务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">srun -n 1 hostname<br></code></pre></td></tr></table></figure><h3 id="2-批处理任务"><a href="#2-批处理任务" class="headerlink" title="2. 批处理任务"></a>2. 批处理任务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; test.sh &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">#!/bin/bash</span><br><span class="hljs-string">#SBATCH -n 1</span><br><span class="hljs-string">#SBATCH -o test.out</span><br><span class="hljs-string"></span><br><span class="hljs-string">hostname</span><br><span class="hljs-string">sleep 10</span><br><span class="hljs-string">EOF</span><br><br>sbatch test.sh<br></code></pre></td></tr></table></figure><p>查看任务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">squeue<br></code></pre></td></tr></table></figure><h2 id="十、常见问题排查"><a href="#十、常见问题排查" class="headerlink" title="十、常见问题排查"></a>十、常见问题排查</h2><h3 id="1-节点状态为-DOWN"><a href="#1-节点状态为-DOWN" class="headerlink" title="1. 节点状态为 DOWN"></a>1. 节点状态为 DOWN</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">scontrol update NodeName=node1 State=RESUME<br></code></pre></td></tr></table></figure><h3 id="2-查看日志"><a href="#2-查看日志" class="headerlink" title="2. 查看日志"></a>2. 查看日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">journalctl -u slurmctld -f<br>journalctl -u slurmd -f<br></code></pre></td></tr></table></figure><h3 id="3-Munge-错误"><a href="#3-Munge-错误" class="headerlink" title="3. Munge 错误"></a>3. Munge 错误</h3><ul><li>确认 munge 正在运行</li><li><code>/etc/munge/munge.key</code> 权限必须是 400</li></ul><h2 id="十一、slurmdbd-需求分析"><a href="#十一、slurmdbd-需求分析" class="headerlink" title="十一、slurmdbd 需求分析"></a>十一、slurmdbd 需求分析</h2><table><thead><tr><th>场景</th><th>是否需要</th></tr></thead><tbody><tr><td>单机测试</td><td>否</td></tr><tr><td>作业计费&#x2F;统计</td><td>是</td></tr><tr><td>多用户审计</td><td>是</td></tr></tbody></table><p>如需以下扩展配置，请说明使用场景：</p><ul><li>CentOS 9 + slurmdbd + MariaDB 配置</li><li>GPU（NVIDIA）节点配置</li><li>cgroup 资源隔离详细配置</li><li>多节点集群扩展方案</li></ul><h2 id="十二、GPU-配置（V100-示例）"><a href="#十二、GPU-配置（V100-示例）" class="headerlink" title="十二、GPU 配置（V100 示例）"></a>十二、GPU 配置（V100 示例）</h2><h3 id="1-确认-GPU-设备"><a href="#1-确认-GPU-设备" class="headerlink" title="1. 确认 GPU 设备"></a>1. 确认 GPU 设备</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> -l /dev/nvidia*<br></code></pre></td></tr></table></figure><p>输出示例：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/dev/</span>nvidia0<br><span class="hljs-regexp">/dev/</span>nvidia1<br><span class="hljs-regexp">/dev/</span>nvidiactl<br><span class="hljs-regexp">/dev/</span>nvidia-uvm<br></code></pre></td></tr></table></figure><h3 id="2-配置-gres-conf"><a href="#2-配置-gres-conf" class="headerlink" title="2. 配置 gres.conf"></a>2. 配置 gres.conf</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">vi /etc/slurm/gres.conf<br></code></pre></td></tr></table></figure><p>示例（2 × V100）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs conf">NodeName=node1 Name=gpu Type=V100 File=/dev/nvidia0<br>NodeName=node1 Name=gpu Type=V100 File=/dev/nvidia1<br></code></pre></td></tr></table></figure><p><strong>要点</strong>：</p><ul><li><code>Type=V100</code> 是 <code>--gres=gpu:V100:x</code> 参数的关键</li><li><code>NodeName</code> 必须和 slurm.conf 完全一致</li></ul><h3 id="3-修改-slurm-conf"><a href="#3-修改-slurm-conf" class="headerlink" title="3. 修改 slurm.conf"></a>3. 修改 slurm.conf</h3><p>在节点定义中添加 GPU 资源：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs conf">NodeName=node1 \<br>  CPUs=64 \<br>  RealMemory=125000 \<br>  Gres=gpu:V100:2 \<br>  State=UNKNOWN<br></code></pre></td></tr></table></figure><h3 id="4-启用-GPU-隔离"><a href="#4-启用-GPU-隔离" class="headerlink" title="4. 启用 GPU 隔离"></a>4. 启用 GPU 隔离</h3><p>确认 <code>/etc/slurm/cgroup.conf</code> 包含：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs conf">ConstrainDevices=yes<br></code></pre></td></tr></table></figure><p><strong>重要</strong>：未启用隔离会导致所有作业都能访问全部 GPU</p><h3 id="5-重启服务"><a href="#5-重启服务" class="headerlink" title="5. 重启服务"></a>5. 重启服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl restart slurmctld slurmd<br></code></pre></td></tr></table></figure><h2 id="十三、GPU-功能验证"><a href="#十三、GPU-功能验证" class="headerlink" title="十三、GPU 功能验证"></a>十三、GPU 功能验证</h2><h3 id="1-查看节点资源"><a href="#1-查看节点资源" class="headerlink" title="1. 查看节点资源"></a>1. 查看节点资源</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">scontrol show node node1<br></code></pre></td></tr></table></figure><p>应包含：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">Gres</span>=gpu:V100:<span class="hljs-number">2</span><br><span class="hljs-attr">GresUsed</span>=<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><h3 id="2-查看-GPU-视图"><a href="#2-查看-GPU-视图" class="headerlink" title="2. 查看 GPU 视图"></a>2. 查看 GPU 视图</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sinfo -o <span class="hljs-string">&quot;%N %G&quot;</span><br></code></pre></td></tr></table></figure><p>输出示例：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">node1</span> gpu:V100:<span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><h2 id="十四、GPU-作业示例"><a href="#十四、GPU-作业示例" class="headerlink" title="十四、GPU 作业示例"></a>十四、GPU 作业示例</h2><h3 id="1-交互式任务（单-GPU）"><a href="#1-交互式任务（单-GPU）" class="headerlink" title="1. 交互式任务（单 GPU）"></a>1. 交互式任务（单 GPU）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">srun --gres=gpu:V100:1 --pty bash<br>nvidia-smi  <span class="hljs-comment"># 应只看到1张GPU</span><br></code></pre></td></tr></table></figure><h3 id="2-批处理任务-1"><a href="#2-批处理任务-1" class="headerlink" title="2. 批处理任务"></a>2. 批处理任务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt; gpu_test.sh &lt;&lt;<span class="hljs-string">&#x27;EOF&#x27;</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#SBATCH -J gpu_test</span><br><span class="hljs-comment">#SBATCH --gres=gpu:V100:1</span><br><span class="hljs-comment">#SBATCH --cpus-per-task=4</span><br><span class="hljs-comment">#SBATCH --mem=16G</span><br><span class="hljs-comment">#SBATCH -o gpu_test.out</span><br><br>nvidia-smi<br><span class="hljs-built_in">sleep</span> 30<br>EOF<br><br>sbatch gpu_test.sh<br></code></pre></td></tr></table></figure><h3 id="3-多-GPU-任务"><a href="#3-多-GPU-任务" class="headerlink" title="3. 多 GPU 任务"></a>3. 多 GPU 任务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">srun --gres=gpu:V100:2 --pty bash<br></code></pre></td></tr></table></figure><h2 id="十五、常见-GPU-问题"><a href="#十五、常见-GPU-问题" class="headerlink" title="十五、常见 GPU 问题"></a>十五、常见 GPU 问题</h2><h3 id="❌-作业内能看到所有-GPU"><a href="#❌-作业内能看到所有-GPU" class="headerlink" title="❌ 作业内能看到所有 GPU"></a>❌ 作业内能看到所有 GPU</h3><p><strong>原因</strong>：</p><ul><li><code>ConstrainDevices=no</code></li><li>未使用 <code>task/cgroup</code></li></ul><p><strong>修复</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs conf">ConstrainDevices=yes<br>TaskPlugin=task/cgroup<br></code></pre></td></tr></table></figure><h3 id="❌-提交-GPU-作业一直排队"><a href="#❌-提交-GPU-作业一直排队" class="headerlink" title="❌ 提交 GPU 作业一直排队"></a>❌ 提交 GPU 作业一直排队</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">squeue<br>scontrol show job &lt;jobid&gt;<br></code></pre></td></tr></table></figure><p><strong>常见原因</strong>：</p><ul><li>GPU 已被占用</li><li>请求的 GPU 类型错误（如写成 A100）</li></ul><h3 id="❌-GPU-规格指定差异"><a href="#❌-GPU-规格指定差异" class="headerlink" title="❌ GPU 规格指定差异"></a>❌ GPU 规格指定差异</h3><table><thead><tr><th>写法</th><th>行为</th></tr></thead><tbody><tr><td><code>--gres=gpu:1</code></td><td>使用任意 GPU</td></tr><tr><td><code>--gres=gpu:V100:1</code></td><td>仅使用 V100</td></tr></tbody></table><p>生产环境建议始终指定 GPU 类型</p><h2 id="十六、生产环境建议"><a href="#十六、生产环境建议" class="headerlink" title="十六、生产环境建议"></a>十六、生产环境建议</h2><h3 id="1-资源限制"><a href="#1-资源限制" class="headerlink" title="1. 资源限制"></a>1. 资源限制</h3><p>在分区配置中添加：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs conf">DefMemPerGPU=32000  # 每GPU分配32GB内存<br></code></pre></td></tr></table></figure><p>避免 GPU 作业抢占全部内存</p><h3 id="2-节点隔离"><a href="#2-节点隔离" class="headerlink" title="2. 节点隔离"></a>2. 节点隔离</h3><p>未来扩展多节点时，使用独立分区区分 GPU&#x2F;CPU 节点</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>V100 GPU 的配置需要同时满足：</p><ol><li>正确的 <code>gres.conf</code> 定义</li><li><code>slurm.conf</code> 中的资源声明</li><li><code>cgroup.conf</code> 的设备隔离</li></ol><p>根据需求可进一步配置：</p><ul><li>MIG &#x2F; 多 GPU 混合调度</li><li>GPU + CPU 绑核（NUMA 亲和）</li><li>GPU 分区 &#x2F; QOS</li><li>多用户 GPU 计费</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Slurm</tag>
      
      <tag>HPC</tag>
      
      <tag>集群管理</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>广义动量守恒推导</title>
    <link href="/2025/02/27/rel_mom/"/>
    <url>/2025/02/27/rel_mom/</url>
    
    <content type="html"><![CDATA[<p>下面给出一个较为详细的推导思路，说明为什么会得到方程<br>$$<br>\frac{d}{dt}\left(\mathbf{p}_\perp + q,\mathbf{A}\right) &#x3D; 0 \quad \Longrightarrow \quad \mathbf{p}_\perp &#x3D; \mathbf{p}_\perp^0 - q,\mathbf{A},<br>$$<br>以及 $\mathbf{p}_\perp^0 &#x3D; m \gamma^0 \mathbf{v}_\perp^0$ 等结果。这里 $\mathbf{p}_\perp$ 指的是粒子的横向(与主传播方向正交)动量，$\mathbf{A}$ 是电磁势(矢势)，$q$ 是粒子电荷，$m$ 是粒子质量，$\gamma$ 是相对论因子。下面分步骤说明。</p><hr><h2 id="1-广义动量的定义与运动方程"><a href="#1-广义动量的定义与运动方程" class="headerlink" title="1. 广义动量的定义与运动方程"></a>1. 广义动量的定义与运动方程</h2><p>在经典电动力学中，带电粒子在电磁场中运动的拉格朗日量可以写作<br>$$<br>\mathcal{L} ;&#x3D;; -,m c^2,\sqrt{1 - v^2&#x2F;c^2} ;+; q,\mathbf{A}\cdot\mathbf{v} ;-; q,\phi,<br>$$<br>其中 $\mathbf{A}$ 是矢势、$\phi$ 是标势，$\mathbf{v}$ 是粒子速度，$c$ 是光速。相应的<strong>广义动量</strong>(canonical momentum)定义为<br>$$<br>\mathbf{P} ;&#x3D;; \frac{\partial \mathcal{L}}{\partial \mathbf{v}}<br>;&#x3D;; \mathbf{p} + q,\mathbf{A},<br>$$<br>其中<br>$$<br>\mathbf{p} ;&#x3D;; \gamma m,\mathbf{v}<br>\quad (\text{惯性动量或机械动量}).<br>$$<br>因此<br>$$<br>\mathbf{p} ;&#x3D;; \mathbf{P} ;-; q,\mathbf{A}.<br>$$</p><h3 id="电磁场中的牛顿方程"><a href="#电磁场中的牛顿方程" class="headerlink" title="电磁场中的牛顿方程"></a>电磁场中的牛顿方程</h3><p>带电粒子在电磁场中的相对论运动方程(牛顿-洛伦兹方程)可以写作<br>$$<br>\frac{d\mathbf{p}}{dt} ;&#x3D;; q,\bigl(\mathbf{E} + \mathbf{v}\times\mathbf{B}\bigr).<br>$$<br>若用广义动量 $\mathbf{P} &#x3D; \mathbf{p} + q\mathbf{A}$ 来表述，则有<br>$$<br>\frac{d\mathbf{P}}{dt}<br>;&#x3D;; q,\mathbf{E} + q,\frac{d\mathbf{A}}{dt}<br>;&#x3D;; q\bigl(\mathbf{E} + \mathbf{v}\times\mathbf{B}\bigr),<br>$$<br>因为 $\mathbf{E} &#x3D; -,\nabla \phi - \partial_t \mathbf{A}$ 且 $\mathbf{v}\times\mathbf{B}$ 也可以用 $\mathbf{A}$ 表示。经过一系列推导后，若在某些方向(比如横向方向 $\perp$)上，系统的对称性或平移不变性保证了对该分量的广义动量守恒，那么就会得到<br>$$<br>\frac{d}{dt}(\mathbf{p}_\perp + q,\mathbf{A}_\perp) ;&#x3D;; 0.<br>$$</p><hr><h2 id="2-为何-frac-d-dt-mathbf-p-perp-q-mathbf-A-0-？"><a href="#2-为何-frac-d-dt-mathbf-p-perp-q-mathbf-A-0-？" class="headerlink" title="2. 为何 $\frac{d}{dt}(\mathbf{p}_\perp + q,\mathbf{A}) &#x3D; 0$？"></a>2. 为何 $\frac{d}{dt}(\mathbf{p}_\perp + q,\mathbf{A}) &#x3D; 0$？</h2><p>在文中(方程(10b))，作者给出的理由是「由于在 $y$ 和 $z$ 方向的平移不变性(translational invariance)」，导致横向广义动量不随时间变化，即<br>$$<br>\frac{d}{dt}\bigl(\mathbf{p}_\perp + q,\mathbf{A}\bigr) &#x3D; 0.<br>$$<br>换言之，在横向方向(相对于主传播或流动方向)没有空间上的变化或外力的额外依赖，因而该分量的广义动量守恒。  </p><p>如果令 $\mathbf{p}_\perp^0$ 表示 $t &lt; 0$ 时刻(或“初始”)的横向动量，且当 $t&lt;0$ 时矢势 $\mathbf{A} &#x3D; 0$，那么守恒量就是<br>$$<br>\mathbf{p}<em>\perp^0 + q,\mathbf{A}\big|</em>{t&lt;0} ;&#x3D;; \mathbf{p}_\perp^0.<br>$$<br>因为守恒，所以在 $t\ge 0$ 的任何时刻都满足<br>$$<br>\mathbf{p}_\perp(t) + q,\mathbf{A}(t) ;&#x3D;; \mathbf{p}_\perp^0.<br>$$<br>从而得到<br>$$<br>\mathbf{p}_\perp(t)<br>;&#x3D;; \mathbf{p}_\perp^0 - q,\mathbf{A}(t).<br>$$<br>这正是方程(11)的主要形式。</p><hr><h2 id="3-初始横向动量-mathbf-p-perp-0-的物理含义"><a href="#3-初始横向动量-mathbf-p-perp-0-的物理含义" class="headerlink" title="3. 初始横向动量 $\mathbf{p}_\perp^0$ 的物理含义"></a>3. 初始横向动量 $\mathbf{p}_\perp^0$ 的物理含义</h2><!-- 作者接下来又写道   --><p>$$<br>\mathbf{p}_\perp^0 ;&#x3D;; m,\gamma^0 ,\mathbf{v}_\perp^0<br>;&#x3D;; -,\hat{\mathbf{y}},m,c,\tan\alpha,<br>$$<br>表明最初(比如等离子体还未受到后续场作用时，$t&lt;0$)，带电粒子在横向($\perp$)方向有一个初始速度 $\mathbf{v}_\perp^0$，对应的相对论动量即<br>$$<br>\mathbf{p}_\perp^0 &#x3D; \gamma^0 m \mathbf{v}_\perp^0.<br>$$<br>这里 $\gamma^0 &#x3D; 1&#x2F;\sqrt{1 - (v_\perp^0)^2&#x2F;c^2}$ 表示初始速度对应的相对论因子。文中举例给出了 $\mathbf{p}_\perp^0 &#x3D; -,\hat{\mathbf{y}},m,c,\tan\alpha$ 这样一个具体数值，说明粒子初始时在负 $y$ 方向以一定速度($\tan\alpha$ 相关)运动。</p><hr><h2 id="4-总结推导脉络"><a href="#4-总结推导脉络" class="headerlink" title="4. 总结推导脉络"></a>4. 总结推导脉络</h2><ol><li><strong>广义动量守恒的关键</strong>：由于在横向方向上(这里指 $y,z$ 或者作者只关注某个正交方向)不存在对粒子的净推力，或者说系统在该方向上具备平移对称性，因此$\mathbf{p}_\perp + q,\mathbf{A}$ 守恒。  </li><li><strong>初始条件</strong>：$t&lt;0$ 时，$\mathbf{A}&#x3D;0$，故初始时刻的广义动量就是粒子的机械动量 $\mathbf{p}_\perp^0$。  </li><li><strong>随时间推演</strong>：由于守恒量不变，可写出<br>$$<br>\mathbf{p}_\perp(t) + q,\mathbf{A}(t)<br>;&#x3D;; \mathbf{p}_\perp^0<br>\quad\Longrightarrow\quad<br>\mathbf{p}_\perp(t)<br>;&#x3D;; \mathbf{p}_\perp^0 - q,\mathbf{A}(t).<br>$$  </li><li><strong>相对论动量表达</strong>：$\mathbf{p}_\perp^0 &#x3D; m,\gamma^0,\mathbf{v}_\perp^0$，并且在具体物理情景(例如等离子体流动)中可以给出速度或动量的方向和大小，如文中的 $-\hat{\mathbf{y}},m,c,\tan\alpha$。</li></ol><!-- 这就是文中方程(10b) 和(11)背后的主要推导逻辑。 --><p>要点在于：  </p><ul><li>电磁场中，<strong>机械动量</strong> $\mathbf{p}$ 并非一定守恒，但<strong>广义动量</strong> $\mathbf{p} + q\mathbf{A}$ 可能由于对称性而守恒。  </li><li>一旦认定在某个方向上无净力(或场结构具备平移不变性)，就可断言那一方向的广义动量守恒，从而得到 $\mathbf{p}_\perp &#x3D; \mathbf{p}_\perp^0 - q\mathbf{A}$ 这样的形式。  </li><li>初始条件决定了 $\mathbf{p}_\perp^0$ 的具体值，再结合守恒方程就能得到随时间演化的横向动量。</li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Cloudflare tunnel 内网穿透</title>
    <link href="/2025/02/02/cloudflare/"/>
    <url>/2025/02/02/cloudflare/</url>
    
    <content type="html"><![CDATA[<ul><li><a href="https://cloudflared.cn/get-started/create-local-tunnel/">https://cloudflared.cn/get-started/create-local-tunnel/</a></li></ul><p>Cloudflare 实现内网穿透主要通过其 <strong>Cloudflare Tunnel</strong>（也叫 Argo Tunnel）功能来实现。它允许你在不暴露公共 IP 的情况下，将本地服务器或应用暴露到互联网上，从而实现内网穿透。以下是 Cloudflare Tunnel 的基本工作原理和步骤：</p><h3 id="工作原理："><a href="#工作原理：" class="headerlink" title="工作原理："></a>工作原理：</h3><ol><li><strong>Cloudflare Tunnel</strong> 创建了一个从本地服务器到 Cloudflare 的加密隧道。你的应用或服务运行在内网中，但它通过这个隧道连接到 Cloudflare 的网络。</li><li><strong>Cloudflare 网络</strong> 接收到来自用户请求的流量，然后转发到本地服务器。</li><li>用户与本地服务进行交互时，数据流经过加密隧道传输，从而避免了暴露内网 IP 地址和端口。</li></ol><h3 id="实现步骤："><a href="#实现步骤：" class="headerlink" title="实现步骤："></a>实现步骤：</h3><ol><li><p><strong>注册 Cloudflare 账户并添加域名：</strong></p><ul><li>如果还没有 Cloudflare 账户，首先去 <a href="https://www.cloudflare.com/">Cloudflare 官网</a> 注册一个。</li><li>将你的域名添加到 Cloudflare，并修改 DNS 设置（如果是现有域名）。</li></ul></li><li><p><strong>安装 Cloudflare Tunnel 客户端：</strong></p><ul><li>在你的本地服务器上安装 <code>cloudflared</code> 客户端。你可以通过 <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation">Cloudflare 的官方文档</a> 了解详细的安装过程。大致步骤：<ul><li>在 Linux 上，你可以使用以下命令：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb<br><span class="hljs-built_in">sudo</span> dpkg -i cloudflared-linux-amd64.deb<br></code></pre></td></tr></table></figure>对于没有sudo权限的普通用户<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64<br></code></pre></td></tr></table></figure></li><li>也可以在 macOS、Windows 等其他平台上进行类似安装。</li></ul></li></ul></li><li><p><strong>认证 Cloudflare Tunnel：</strong></p><ul><li>在服务器上运行以下命令，进行认证：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cloudflared tunnel login<br></code></pre></td></tr></table></figure></li><li>该命令会打开一个浏览器窗口，要求你登录到 Cloudflare 账户并授权。</li></ul></li><li><p><strong>创建 Tunnel：</strong></p><ul><li>创建一个新的 Tunnel：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cloudflared tunnel create &lt;tunnel-name&gt;<br></code></pre></td></tr></table></figure></li><li>这会生成一个隧道 ID 和证书文件。</li></ul></li><li><p><strong>配置 Tunnel 代理：</strong></p><ul><li>设置隧道代理，通常是在本地应用监听的端口上。例如，如果你的服务在 <code>localhost:8080</code> 上运行，可以使用以下命令将流量通过隧道转发：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cloudflared tunnel --url http://localhost:8080<br></code></pre></td></tr></table></figure></li><li>或者也可以直接更改配置文件”~&#x2F;.cloudflared&#x2F;config.yml” <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">tunnel:</span> <span class="hljs-string">6bc4c976-1c0c-45a4-bab0-93b7eed4e1d1</span> <span class="hljs-comment"># 你的 Tunnel ID</span><br><span class="hljs-attr">credentials-file:</span> <span class="hljs-string">$HOME/.cloudflared/6bc4c976-1c0c-45a4-bab0-93b7eed4e1d1.json</span><br><br><span class="hljs-attr">ingress:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hostname:</span> <span class="hljs-string">rentereview.cn</span><br>    <span class="hljs-attr">service:</span> <span class="hljs-string">http://localhost:8080</span>  <span class="hljs-comment"># 你的 Web 服务监听端口</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">service:</span> <span class="hljs-string">http_status:404</span><br></code></pre></td></tr></table></figure></li><li>然后运行 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cloudflared tunnel run &lt;tunnel-name&gt;<br></code></pre></td></tr></table></figure></li></ul></li><li><p><strong>配置 DNS 和路由：</strong></p><ul><li><p>在 Cloudflare 控制面板中，配置你的 DNS 设置，将域名指向 <code>cloudflare-tunnel</code>。</p></li><li><p>在 Cloudflare 的 DNS 配置中，添加一条 CNAME 记录，将子域（例如 <code>tunnel.yourdomain.com</code>）指向 <code>tunnel.cloudflare.com</code>。</p></li><li><p>总结一下</p></li><li><p>在 Cloudflare 控制面板中，通过 DNS 设置，手动添加一个 CNAME 记录，将子域（如 tunnel.retereview.cn）指向 your-tunnel-id.cfargotunnel.com。</p></li><li><p>确保你的 Cloudflare Tunnel 在本地启动并运行。</p></li><li><p>等待 DNS 记录生效后，你应该就可以通过访问 tunnel.retereview.cn 来访问你本地的服务了。</p></li><li><p>或者通过cloudflared程序进行路由</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cloudflared tunnel route dns &lt;tunnel-name&gt; rentereview.cn<br></code></pre></td></tr></table></figure></li><li><p>这将把域名 rentereview.cn 路由到名为 <tunnel-name> 的 Tunnel。</p></li></ul></li><li><p><strong>启动和验证：</strong></p><ul><li>运行 Cloudflare Tunnel 服务：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">cloudflared tunnel run &lt;tunnel-name&gt;<br></code></pre></td></tr></table></figure></li><li>此时，你的本地服务就已经通过 Cloudflare Tunnel 暴露到互联网上了。</li></ul></li><li><p><strong>持久化服务（使用 systemd）</strong></p><ul><li>以上步骤中运行 <code>cloudflared tunnel run</code> 的方式在终端退出后就会停止，为了让服务在后台持续运行，可以使用 systemd 来管理。</li></ul><p> <strong>方法一：使用 systemd 创建服务（推荐）</strong></p><ol><li><p>创建服务文件<br>使用文本编辑器创建服务文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> nano /etc/systemd/system/cloudflared-tunnel.service<br></code></pre></td></tr></table></figure></li><li><p>服务文件内容<br>将以下内容复制到文件中，注意替换 <code>&lt;tunnel-name&gt;</code> 为你的隧道名称：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Unit]</span><br><span class="hljs-attr">Description</span>=Cloudflare Tunnel<br><span class="hljs-attr">After</span>=network.target<br><br><span class="hljs-section">[Service]</span><br><span class="hljs-attr">Type</span>=simple<br><span class="hljs-attr">User</span>=root<br><span class="hljs-attr">ExecStart</span>=/usr/local/bin/cloudflared tunnel run &lt;tunnel-name&gt;<br><span class="hljs-attr">Restart</span>=always<br><span class="hljs-attr">RestartSec</span>=<span class="hljs-number">5</span><br><span class="hljs-comment"># 可选：设置环境变量</span><br><span class="hljs-attr">Environment</span>=TUNNEL_ORIGIN_CERT=/path/to/cert.pem<br><span class="hljs-comment"># 可选：指定配置文件</span><br><span class="hljs-attr">Environment</span>=CLOUDFLARED_CONFIG=/path/to/config.yml<br><br><span class="hljs-section">[Install]</span><br><span class="hljs-attr">WantedBy</span>=multi-user.target<br></code></pre></td></tr></table></figure></li><li><p>启用并启动服务<br>依次执行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 重新加载 systemd</span><br><span class="hljs-built_in">sudo</span> systemctl daemon-reload<br><br><span class="hljs-comment"># 启用开机自启</span><br><span class="hljs-built_in">sudo</span> systemctl <span class="hljs-built_in">enable</span> cloudflared-tunnel.service<br><br><span class="hljs-comment"># 启动服务</span><br><span class="hljs-built_in">sudo</span> systemctl start cloudflared-tunnel.service<br></code></pre></td></tr></table></figure><p>之后，可以使用以下命令检查服务状态和日志：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 检查状态</span><br><span class="hljs-built_in">sudo</span> systemctl status cloudflared-tunnel.service<br><br><span class="hljs-comment"># 查看日志</span><br><span class="hljs-built_in">sudo</span> journalctl -u cloudflared-tunnel.service -f<br></code></pre></td></tr></table></figure></li></ol></li><li><p><strong>启用 “Always Use HTTPS” 设置</strong></p><ul><li><p>Cloudflare 提供了一个非常简单的方法来自动将所有 HTTP 流量重定向到 HTTPS：通过 “Always Use HTTPS” 选项。这是最直接的方式，适用于大多数场景。</p></li><li><p>操作步骤：</p></li><li><p>登录到你的 Cloudflare 控制面板。</p></li><li><p>选择你要配置的域名。</p></li><li><p>进入 “SSL&#x2F;TLS” 设置页面。</p></li><li><p>在页面顶部，点击 “Edge Certificates” 选项卡。</p></li><li><p>向下滚动，找到 “Always Use HTTPS” 设置。</p></li><li><p>开启这个选项，将所有的 HTTP 请求自动重定向到 HTTPS。</p></li></ul></li></ol><h3 id="优点："><a href="#优点：" class="headerlink" title="优点："></a>优点：</h3><ul><li><strong>安全性高</strong>：内网不需要暴露在公网，只通过加密隧道进行通信。</li><li><strong>无公网 IP</strong>：适用于没有固定公网 IP 的环境。</li><li><strong>简化配置</strong>：不需要复杂的端口映射或 NAT 配置。</li></ul><h3 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h3><ul><li>Cloudflare Tunnel 是一种基于 Cloudflare 的服务，因此需要有一个 Cloudflare 账户，并且 DNS 需要指向 Cloudflare 才能使用。</li><li>可能会有流量限制或费用问题，特别是在高流量场景下。</li></ul><p>这种方式的好处是可以轻松实现内网穿透，并且利用 Cloudflare 的全球加速和安全防护功能，使你的应用更加可靠和安全。如果有其他问题，或对某些配置有疑问，欢迎继续提问！</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Subtree仓库添加</title>
    <link href="/2025/02/02/subtree/"/>
    <url>/2025/02/02/subtree/</url>
    
    <content type="html"><![CDATA[<h2 id="Step-1"><a href="#Step-1" class="headerlink" title="Step 1"></a>Step 1</h2><p>初始化 git 仓库并提交初始文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 在当前目录初始化仓库</span><br>git init<br><br><span class="hljs-comment"># 创建或编辑 README.md（示例）</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;# 项目&quot;</span> &gt; README.md<br><br><span class="hljs-comment"># 将所有改动添加到暂存区</span><br>git add .<br><br><span class="hljs-comment"># 提交到本地仓库</span><br>git commit -m <span class="hljs-string">&quot;Init&quot;</span><br></code></pre></td></tr></table></figure><p>解释：</p><ul><li>git init：在当前目录创建一个新的 Git 仓库（.git 目录）。</li><li>git add .：把当前目录下的所有新文件和修改记录到暂存区，准备提交。</li><li>git commit -m “Init”：把暂存区内容作为一次提交写入本地仓库，-m 后面是提交说明。</li></ul><h2 id="Step-2"><a href="#Step-2" class="headerlink" title="Step 2"></a>Step 2</h2><p>把另一个仓库作为子树（subtree）添加到本仓库的某个目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 添加远程仓库（label 为远程名，&lt;git-url&gt; 为远程仓库地址）</span><br>git remote add label &lt;git-url&gt;<br><br><span class="hljs-comment"># 抓取远程分支到本地（不合并，只获取引用和对象）</span><br>git fetch label<br><br><span class="hljs-comment"># 将远程仓库的某个分支以子树形式合并到当前仓库的指定目录</span><br>git subtree add --prefix=&lt;path&gt; label &lt;branch&gt;<br><span class="hljs-comment"># 可选：加上 --squash 将远程历史合并为单个提交</span><br><span class="hljs-comment"># git subtree add --prefix=&lt;path&gt; label &lt;branch&gt; --squash</span><br></code></pre></td></tr></table></figure><p>解释：</p><ul><li>git remote add label <git-url>：为远程仓库起一个名字（这里用 label），便于后续引用。</li><li>git fetch label：从名为 label 的远程抓取最新对象和引用，但不自动合并到当前分支。</li><li>git subtree add –prefix&#x3D;<path> label <branch>：<ul><li>–prefix&#x3D;<path>：把子仓库的内容导入到当前仓库的 <path> 目录下（该目录会被创建）。</li><li>label：上一步添加的远程名。</li><li><branch>：远程仓库中要导入的分支名（如 master 或 main）。</li><li>该命令会把远程分支的内容合并到本仓库的指定目录，并保留可追溯的合并提交；–squash 可把全部历史压缩为一个提交。</li></ul></li></ul><p>补充常用操作：</p><ul><li>更新子树到远程最新：git subtree pull –prefix&#x3D;<path> label <branch> [–squash]</li><li>将子树的变更推送回远程：git subtree push –prefix&#x3D;<path> label <branch></li></ul><p>注意事项：</p><ul><li>git subtree 在现代 Git 中通常可用；若不可用，需安装 contrib 工具或使用其他方式（如 git submodule）。</li><li>在使用前确认 <path>、<git-url>、<branch> 填写正确，避免覆盖已有重要文件。</li><li>若希望保留完整历史，勿使用 –squash；若想保持主仓库历史简洁，可使用 –squash。</li><li>相关操作会在本地产生合并提交，合并策略与普通合并类似，请根据需要在分支上操作并做好备份。</li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>机器学习资源</title>
    <link href="/2023/08/10/datascience/"/>
    <url>/2023/08/10/datascience/</url>
    
    <content type="html"><![CDATA[<h2 id="数据分析入门"><a href="#数据分析入门" class="headerlink" title="数据分析入门"></a>数据分析入门</h2><p><a href="https://github.com/apachecn/pyda-2e-zh.git">https://github.com/apachecn/pyda-2e-zh.git</a></p><h2 id="Twitter算法"><a href="#Twitter算法" class="headerlink" title="Twitter算法"></a>Twitter算法</h2><p><a href="https://github.com/twitter/the-algorithm.git">https://github.com/twitter/the-algorithm.git</a></p><h2 id="Data-Science笔记"><a href="#Data-Science笔记" class="headerlink" title="Data Science笔记"></a>Data Science笔记</h2><p><a href="https://github.com/fengdu78/Data-Science-Notes">https://github.com/fengdu78/Data-Science-Notes</a></p><h2 id="Machine-Learning笔记"><a href="#Machine-Learning笔记" class="headerlink" title="Machine Learning笔记"></a>Machine Learning笔记</h2><p>吴恩达Machine learning笔记。</p><p><a href="https://github.com/fengdu78/Coursera-ML-AndrewNg-Notes.git">https://github.com/fengdu78/Coursera-ML-AndrewNg-Notes.git</a></p><h2 id="100-Day-Machine-Learning"><a href="#100-Day-Machine-Learning" class="headerlink" title="100-Day-Machine-Learning"></a>100-Day-Machine-Learning</h2><p>100-Days-Of-ML-Code中文版</p><p><a href="https://github.com/MLEveryday/100-Days-Of-ML-Code.git">https://github.com/MLEveryday/100-Days-Of-ML-Code.git</a></p><h2 id="Deep-Learning-Book"><a href="#Deep-Learning-Book" class="headerlink" title="Deep Learning Book"></a>Deep Learning Book</h2><p>Deep Learning Book Chinese online： <a href="https://exacity.github.io/deeplearningbook-chinese/Chapter1_introduction/">https://exacity.github.io/deeplearningbook-chinese/Chapter1_introduction/</a></p><p>Source Code： <a href="https://github.com/exacity/deeplearningbook-chinese.git">https://github.com/exacity/deeplearningbook-chinese.git</a></p><h2 id="Huawei-拍月亮"><a href="#Huawei-拍月亮" class="headerlink" title="Huawei 拍月亮"></a>Huawei 拍月亮</h2><p><a href="https://github.com/zhazhajust/Learning-to-See-in-the-Dark.git">https://github.com/zhazhajust/Learning-to-See-in-the-Dark.git</a></p><h2 id="GPT2-0"><a href="#GPT2-0" class="headerlink" title="GPT2.0"></a>GPT2.0</h2><p>基于开源GPT2.0的初代创作型人工智能 | 可扩展、可进化</p><p><a href="https://github.com/EssayKillerBrain/WriteGPT.git">https://github.com/EssayKillerBrain/WriteGPT.git</a></p><h2 id="Full-Stack"><a href="#Full-Stack" class="headerlink" title="Full Stack"></a>Full Stack</h2><p>🚀 fullstack tutorial 2022，后台技术栈&#x2F;架构师之路&#x2F;全栈开发社区，春招&#x2F;秋招&#x2F;校招&#x2F;面试。</p><p><a href="https://github.com/frank-lam/fullstack-tutorial.git">https://github.com/frank-lam/fullstack-tutorial.git</a></p><h2 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h2><p>21天学会JAVA</p><p><a href="https://github.com/DuGuQiuBai/Java.git">https://github.com/DuGuQiuBai/Java.git</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>远程连接与唤醒</title>
    <link href="/2023/08/10/remote/"/>
    <url>/2023/08/10/remote/</url>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>首先准备好公网ipv4 or ipv6，使用ddns-go绑定动态ip地址到dns服务器（静态ip不需要），此时可。随后运行WolGoWeb服务，即可使用url进行远程唤醒。</p><h2 id="dynv6"><a href="#dynv6" class="headerlink" title="dynv6"></a>dynv6</h2><p>使用 <a href="https://dynv6.com/">https://dynv6.com</a> 进行动态域名解析，绑定ipv6于自定义域名 <a href="https://xxx.dynv6.net/">https://xxx.dynv6.net</a> 。</p><h2 id="ddns-go"><a href="#ddns-go" class="headerlink" title="ddns-go"></a>ddns-go</h2><p>简单好用的DDNS。自动更新域名解析到公网IP(支持阿里云、腾讯云、Dnspod、Cloudflare、Callback、华为云、百度云、Porkbun、GoDaddy、Google Domain)</p><p><a href="https://github.com/jeessy2/ddns-go.git">https://github.com/jeessy2/ddns-go.git</a></p><p>此时，ipv6已解析于ddns服务器，通过自定义url可以通过远程连接软件如rdp、moonlight、parsec等直接访问。</p><h2 id="WolGoWeb"><a href="#WolGoWeb" class="headerlink" title="WolGoWeb"></a>WolGoWeb</h2><p>基于Golang的Web服务器，使用url链接即可发起wake on lan局域网唤醒。</p><p><a href="https://github.com/zhazhajust/WolGoWeb.git">https://github.com/zhazhajust/WolGoWeb.git</a></p><p>然后测试url唤醒，在浏览器输入 <a href="http://xxx:9090/wol?mac=00-00-00-00-00-00">http://xxx:9090/wol?mac=00-00-00-00-00-00</a> （网卡MAC地址）。</p><h2 id="Wake-On-Lan-GUI-程序（Optional）"><a href="#Wake-On-Lan-GUI-程序（Optional）" class="headerlink" title="Wake On Lan GUI 程序（Optional）"></a>Wake On Lan GUI 程序（Optional）</h2><p><a href="https://github.com/basildane/WakeOnLAN.git">https://github.com/basildane/WakeOnLAN.git</a></p><h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><p><a href="https://www.jianshu.com/p/6622c33f4cd3">https://www.jianshu.com/p/6622c33f4cd3</a></p><p><a href="https://zhouym.tech/2022/Wake-On-Lan/">https://zhouym.tech/2022/Wake-On-Lan/</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Frequency moved undulator</title>
    <link href="/2022/09/15/undulator/"/>
    <url>/2022/09/15/undulator/</url>
    
    <content type="html"><![CDATA[<h2 id="Smilei-or-EPOCH"><a href="#Smilei-or-EPOCH" class="headerlink" title="Smilei or EPOCH"></a>Smilei or EPOCH</h2><p>Mark the oscillate electrons, and save the field produced by them. Then sparated them from the total electric field and save to a new file.</p><h2 id="光波荡器推导"><a href="#光波荡器推导" class="headerlink" title="光波荡器推导"></a>光波荡器推导</h2><p>假设平面波激光方向为$\hat k &#x3D; \frac{\mathbf{k}}{k_L}$，则 $B &#x3D; \frac{(\hat k \times E)}{c}$，电子在激光场中运动方程写为：</p><p>$$<br>\frac{d}{dt}(\gamma mc \beta) &#x3D; -e(E + v \times B)<br>$$</p><p>$$<br>\frac{d}{dt}(\gamma mc \beta) &#x3D; -e[E + \beta \times (\hat k \times E)] &#x3D; -e[E + (\beta \cdot E)\hat k - (\beta \cdot \hat k)E]<br>$$</p><p>我们假设激光沿着x方向偏振，$E &#x3D; E_0 \sin(\omega_Lt − k \cdot x)\hat x$，沿着z方向传播，与z轴呈夹角$\varphi$，波矢$k &#x3D; k_L(0, -\sin \varphi, +\cos \varphi)$，并且 $\omega_L &#x3D; ck_L$。运动方程写为：</p><p>$$<br>\frac{d}{dt}(\gamma mc \beta) &#x3D; -eE_0\sin(ck_Lt - \mathbf{k} \cdot x)[1 - (\hat k \cdot \beta)] &#x3D; \frac{eE_0}{ck_L}\frac{d}{dt}\cos(ck_Lt - \mathbf{k} \cdot x)<br>$$</p><p>方程表明水平方向动量守恒，通过积分可以很容易得出，</p><p>$$<br>\beta_x &#x3D; \frac{eE_0}{\gamma mc^2k_L}\cos(ck_Lt - \mathbf{k}\cdot x)<br>$$</p><p>波荡器参数为$K &#x3D; \frac{eE_0}{mc^2k_L}$，对于Undulator， $K&lt;&lt;1$，$t \approx c&#x2F;\beta_z$，横向振动速度为$\cos(k_L(1&#x2F;\overline{\beta}_z - \cos\varphi)z + k_Ly\sin\varphi)$，则波荡器周期为：</p><p>$$<br>\lambda_u \rightarrow \frac{\overline{\beta}_z\lambda_L}{1 - \overline{\beta}_z\cos\varphi}<br>$$</p><p>将波荡器周期和参数K带入波荡器辐射公式,</p><p>$$<br>\frac{\lambda_1(\phi)}{c} &#x3D; \frac{\lambda_u}{c}[\frac{1 + K^2&#x2F;(4\gamma^2)}{\beta} - (1 - \frac{\phi^2}{2})] \approx \frac{\lambda_u}{c}\frac{1 + K^2&#x2F;2 + \gamma^2\phi^2}{2\gamma^2}<br>$$</p><p>同步辐射共振波长为</p><p>$$<br>\lambda &#x3D; \frac{1 + K^2&#x2F;2}{2\gamma^2}\frac{\lambda_L}{1 - \overline{\beta}_z\cos\varphi}<br>$$</p><p>当满足$\varphi \rightarrow 0, K &lt;&lt; 1$(undulator的假设)时</p><p>$$<br>\lambda \rightarrow \lambda_L<br>$$</p><h2 id="时间收缩效应"><a href="#时间收缩效应" class="headerlink" title="时间收缩效应"></a>时间收缩效应</h2><p>假设$t^{‘}$为粒子静止坐标系，则 $1 - \beta(t^{‘})\cos\phi(t^{‘})$ 为时间收缩因子，对于相对论电子，</p><p>$$<br>\beta &#x3D; \sqrt{1 - \frac{1}{\gamma^2}} \approx 1 - \frac{1}{1\gamma^2}<br>$$</p><p>对于$\gamma &gt;&gt; 1$，$\phi &lt;&lt; 1$</p><p>$$<br>1 - \beta \cos\phi \approx \frac{1}{2}(\frac{1}{\gamma^2} + \phi^2)<br>$$</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>偏微分方程求解</title>
    <link href="/2022/08/17/numerical/"/>
    <url>/2022/08/17/numerical/</url>
    
    <content type="html"><![CDATA[<h1 id="偏微分方程求解"><a href="#偏微分方程求解" class="headerlink" title="偏微分方程求解"></a>偏微分方程求解</h1><p>对于波动方程等偏微分方程，难以直接求解析解，一般采用数值方法求解。目前电磁学主要通过有限元法（FEM）（通过Galerkin法基函数分解）、有限时域差分法（FDTD）、矩量法（MoM）等进行数值模拟。对于更一般的偏微分方程求解方法，这里介绍Method of Lines方法求解。</p><h2 id="Method-of-Lines"><a href="#Method-of-Lines" class="headerlink" title="Method of Lines"></a>Method of Lines</h2><p>Method of Lines是求解偏微分方程的一种通用计算方法。Method of Lines方法通过空间离散，将偏微分方程转化为常微分方程组ODEs，后续通过Eular法，隐式欧拉法（牛顿迭代、不动点法）等求解。</p><h2 id="基本案例"><a href="#基本案例" class="headerlink" title="基本案例"></a>基本案例</h2><p>例：求解扩散方程</p><p>$$<br>\frac{\partial u}{\partial t} &#x3D; D\frac{\partial^2 u}{\partial x^2}<br>$$</p><p>将$D\frac{\partial^2}{\partial x^2}$离散化为矩阵$A$，将$\frac{d}{dt}U$写为$\dot U$，使用矩阵形式表示为$\dot U &#x3D; AU$。</p><p>例如$\frac{du_i}{dt} &#x3D; -v\frac{du}{dx}$<br>方程转化为$\frac{du_i}{dt} &#x3D; -v\frac{(u_i - u_{i-1})}{\delta x}, 1 \leq i \leq M$，再转化为矩阵形式。</p><h2 id="forward-eular"><a href="#forward-eular" class="headerlink" title="forward eular"></a>forward eular</h2><p>讲矩阵乘积写为函数形式<br>$$<br>\dot U &#x3D; F(U)<br>$$<br>则可使用前向欧拉法进行求解<br>$$<br>U_{k+1} &#x3D; U_k + \delta tF(U_k)<br>$$</p><h2 id="RK方法"><a href="#RK方法" class="headerlink" title="RK方法"></a>RK方法</h2><p>龙格库塔方法显式求解Method of Lines得到的ODEs，可以得到更高精度的解。</p><p>积分中值定理可以得出<br>$$<br>U(t + \delta t) &#x3D; U(t) + \delta tF(U(t + \frac{1}{2}\delta t)) + O(\delta t^3)<br>$$</p><p>龙格库塔法通过预测$U(t + \frac{1}{2}\delta t)$来使用前向欧拉法<br>$$<br>\widetilde U_{k+\frac{1}{2}} &#x3D; U_k + \frac{\delta t}{2}F(U_k)<br>$$</p><p>$$<br>U_{k+1} &#x3D; U_k + \delta tF(\widetilde U_{k+\frac{1}{2}})<br>$$</p><p>这是一种两阶段方法。第一阶段预测中点值，第二阶段，即校正阶段，使用预测的中点值进行时间步进。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>牛顿迭代法隐式欧拉法求解微分方程</title>
    <link href="/2022/08/16/NewtonMethod/"/>
    <url>/2022/08/16/NewtonMethod/</url>
    
    <content type="html"><![CDATA[<h1 id="牛顿迭代法求解ODE"><a href="#牛顿迭代法求解ODE" class="headerlink" title="牛顿迭代法求解ODE"></a>牛顿迭代法求解ODE</h1><p>首先根据 (\frac{dy}{dx} &#x3D; f(x, y)) 构建 (F(x, y) &#x3D; 0)，然后求解(F(x, y))对(y)的导数，然后迭代求解零点误差 (\text{abs}(F(x, y) - F(x, \text{next}_y))) 最小处的(y)，将(\text{next}_y)作为(y)带入下一个递归，</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">import matplotlib.pyplot as plt</span><br><span class="line">import numpy as np</span><br><span class="line">import sympy</span><br><span class="line"></span><br><span class="line">x = np.zeros(20)</span><br><span class="line">y = np.zeros(20)</span><br><span class="line">y_E = np.zeros(20)</span><br><span class="line">z = np.zeros(20)</span><br><span class="line">x[0] = 0</span><br><span class="line">y[0] = 1</span><br><span class="line">y_E[0] = 1</span><br><span class="line">z[0] = (1+2*x[0])**0.5</span><br><span class="line">h = 0.05</span><br><span class="line"></span><br><span class="line"># dy/dx 导数</span><br><span class="line">def f(x, y):</span><br><span class="line">    return y-2*x/y</span><br><span class="line"></span><br><span class="line">############################</span><br><span class="line">##### 牛顿迭代法构建方程 #####</span><br><span class="line">############################</span><br><span class="line"></span><br><span class="line"># dy/dx = f(x, y)</span><br><span class="line"># y - yn = (x - xn) * f(x, y)</span><br><span class="line"># h * f(x, y) - (y - yn) = 0</span><br><span class="line">def F(x, y, yn):</span><br><span class="line">    return h * f(x, y) - (y - yn)</span><br><span class="line"></span><br><span class="line"># 求解dF(x, y, yn)/dy</span><br><span class="line"># d(0.05 * (y - 2*x/y) - y + yn) / dy</span><br><span class="line"># 0.05 * (1 + 2*x/y**2) - 1</span><br><span class="line"># 0.1 * x/y**2 - 0.95</span><br><span class="line">def dF(x, y):</span><br><span class="line">    return 0.1*x/y**2 - 0.95</span><br><span class="line"></span><br><span class="line">############################</span><br><span class="line">############################</span><br><span class="line">############################</span><br><span class="line"></span><br><span class="line">def newtonMethod(assum, d1, d3):</span><br><span class="line">    y = assum</span><br><span class="line">    Next_y = 0</span><br><span class="line">    if F(d1, y, d3) == 0.0:</span><br><span class="line">        return  y</span><br><span class="line">    else:</span><br><span class="line">        Next_y = y - F(d1, y, d3) / dF(d1, y)</span><br><span class="line"></span><br><span class="line">    # 零点距离</span><br><span class="line">    if abs(F(d1, y, d3) - F(d1, Next_y, d3)) &lt; 1e-5:</span><br><span class="line">        return Next_y</span><br><span class="line">        &#x27;&#x27;&#x27;设置迭代跳出条件, 同时输出满足f(x) = 0的x值&#x27;&#x27;&#x27;</span><br><span class="line">    else:</span><br><span class="line">        return newtonMethod(Next_y, d1, d3)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for i in range(1, 20):</span><br><span class="line">    x[i] = x[i-1]+h</span><br><span class="line">    y[i] = newtonMethod(4, x[i], y[i-1])</span><br><span class="line">    y_E[i] = y_E[i-1] + h*f(x[i-1], y_E[i-1])</span><br><span class="line">    z[i] = (1+2*x[i])**0.5</span><br><span class="line"></span><br><span class="line">plt.plot(x, y, label=&#x27;Implicit Euler&#x27;, color=&#x27;green&#x27;)</span><br><span class="line">plt.plot(x, y_E, label=&#x27;Euler&#x27;, color=&#x27;orange&#x27;)</span><br><span class="line">plt.plot(x, z, label=&#x27;true&#x27;, color=&#x27;red&#x27;)</span><br><span class="line">plt.legend()</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Marching Cube算法提取网格</title>
    <link href="/2022/08/15/pymesh/"/>
    <url>/2022/08/15/pymesh/</url>
    
    <content type="html"><![CDATA[<h1 id="PyMesh3D"><a href="#PyMesh3D" class="headerlink" title="PyMesh3D"></a>PyMesh3D</h1><h2 id="Basic-Installation"><a href="#Basic-Installation" class="headerlink" title="Basic Installation"></a>Basic Installation</h2><p>This project for mesh render in data science.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install --upgrade pip</span><br><span class="line">pip install pymesh3d</span><br></pre></td></tr></table></figure><p>If you need mayavi backend.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install mayavi</span><br><span class="line">pip install pyqt</span><br></pre></td></tr></table></figure><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymesh</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br></pre></td></tr></table></figure><p>Look at the directory example for full example.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##########################################</span></span><br><span class="line"><span class="comment">############ Rotate Mesh Data ############</span></span><br><span class="line"><span class="comment">##########################################</span></span><br><span class="line"></span><br><span class="line">wkdir = <span class="string">&quot;../../Render&quot;</span></span><br><span class="line"></span><br><span class="line">ey = np.load(wkdir + <span class="string">&quot;/Ez.npy&quot;</span>)[::<span class="number">2</span>, ::<span class="number">50</span>]</span><br><span class="line"></span><br><span class="line">m, n = ey.shape[<span class="number">0</span>], ey.shape[<span class="number">1</span>]</span><br><span class="line">res = np.zeros([m, n, n])</span><br><span class="line">pymesh.rotate(ey, res, ifhalf = <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">fig = plt.figure(figsize=(<span class="number">4</span>, <span class="number">3</span>))</span><br><span class="line">plt.contourf(res[:, <span class="built_in">int</span>(n/<span class="number">2</span>), :].T)</span><br><span class="line">cbar = plt.colorbar()</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zhazhajust/pymesh/blob/main/example/example_files/example_1_0.png?raw=true" alt="png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##########################################</span></span><br><span class="line"><span class="comment">############# Save Mesh Data #############</span></span><br><span class="line"><span class="comment">##########################################</span></span><br><span class="line"></span><br><span class="line">mesh = pymesh.get_iso_surf(res, contours_number = <span class="number">4</span>, cmap = <span class="string">&quot;jet&quot;</span>)</span><br><span class="line">color = pymesh.interp_color(mesh.iso_vals, cmap = <span class="string">&quot;jet&quot;</span>)</span><br><span class="line">mesh.export(wkdir + <span class="string">&quot;test&quot;</span>, <span class="string">&quot;obj&quot;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##########################################</span></span><br><span class="line"><span class="comment">############# Load Mesh Data #############</span></span><br><span class="line"><span class="comment">##########################################</span></span><br><span class="line"></span><br><span class="line">mesh = pymesh.Mesh.load(wkdir + <span class="string">&quot;test&quot;</span>, <span class="string">&quot;obj&quot;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##########################################</span></span><br><span class="line"><span class="comment">############# Plot Mesh Data #############</span></span><br><span class="line"><span class="comment">##########################################</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mayavi <span class="keyword">import</span> mlab</span><br><span class="line"></span><br><span class="line">mlab_mesh = pymesh.iso_surface(mesh, colormap = <span class="string">&quot;RdBu&quot;</span>)</span><br><span class="line">mlab.colorbar()</span><br><span class="line">mlab.show()</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zhazhajust/pymesh/blob/main/example/example_files/example_3_0.png?raw=true" alt="png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">################ plt example #################</span></span><br><span class="line"></span><br><span class="line">surf = mesh.plt_trisurf(cmap = <span class="string">&quot;jet&quot;</span>)</span><br><span class="line">plt.colorbar(surf, orientation = <span class="string">&#x27;horizontal&#x27;</span>)</span><br><span class="line">plt.tight_layout()</span><br></pre></td></tr></table></figure><p><img src="https://github.com/zhazhajust/pymesh/blob/main/example/example_files/example_2_0.png?raw=true" alt="png"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>动态开点线段树</title>
    <link href="/2022/07/09/segmentTree/"/>
    <url>/2022/07/09/segmentTree/</url>
    
    <content type="html"><![CDATA[<h2 id="动态线段树模板"><a href="#动态线段树模板" class="headerlink" title="动态线段树模板"></a>动态线段树模板</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @Description: 线段树（动态开点）</span></span><br><span class="line"><span class="comment"> * @Author: LFool</span></span><br><span class="line"><span class="comment"> * @Date 2022/6/7 09:15</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SegmentTreeDynamic</span> &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">        Node left, right;</span><br><span class="line">        <span class="type">int</span> val, add;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> N = (<span class="type">int</span>) <span class="number">1e9</span>;</span><br><span class="line">    <span class="keyword">private</span> Node root = <span class="keyword">new</span> <span class="built_in">Node</span>();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="type">void</span> <span class="title">update</span><span class="params">(Node node, <span class="type">int</span> start, <span class="type">int</span> end, <span class="type">int</span> l, <span class="type">int</span> r, <span class="type">int</span> val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (l &lt;= start &amp;&amp; end &lt;= r) &#123;</span><br><span class="line">            node.val += (end - start + <span class="number">1</span>) * val;</span><br><span class="line">            node.add += val;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> mid = (start + end) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">pushDown</span>(node, mid - start + <span class="number">1</span>, end - mid);</span><br><span class="line">        <span class="keyword">if</span> (l &lt;= mid) <span class="built_in">update</span>(node.left, start, mid, l, r, val);</span><br><span class="line">        <span class="keyword">if</span> (r &gt; mid) <span class="built_in">update</span>(node.right, mid + <span class="number">1</span>, end, l, r, val);</span><br><span class="line">        <span class="built_in">pushUp</span>(node);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="type">int</span> <span class="title">query</span><span class="params">(Node node, <span class="type">int</span> start, <span class="type">int</span> end, <span class="type">int</span> l, <span class="type">int</span> r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (l &lt;= start &amp;&amp; end &lt;= r) <span class="keyword">return</span> node.val;</span><br><span class="line">        <span class="type">int</span> mid = (start + end) &gt;&gt; <span class="number">1</span>, ans = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">pushDown</span>(node, mid - start + <span class="number">1</span>, end - mid);</span><br><span class="line">        <span class="keyword">if</span> (l &lt;= mid) ans += <span class="built_in">query</span>(node.left, start, mid, l, r);</span><br><span class="line">        <span class="keyword">if</span> (r &gt; mid) ans += <span class="built_in">query</span>(node.right, mid + <span class="number">1</span>, end, l, r);</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="type">void</span> <span class="title">pushUp</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">        node.val = node.left.val + node.right.val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="type">void</span> <span class="title">pushDown</span><span class="params">(Node node, <span class="type">int</span> leftNum, <span class="type">int</span> rightNum)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (node.left == null) node.left = <span class="keyword">new</span> <span class="built_in">Node</span>();</span><br><span class="line">        <span class="keyword">if</span> (node.right == null) node.right = <span class="keyword">new</span> <span class="built_in">Node</span>();</span><br><span class="line">        <span class="keyword">if</span> (node.add == <span class="number">0</span>) <span class="keyword">return</span> ;</span><br><span class="line">        node.left.val += node.add * leftNum;</span><br><span class="line">        node.right.val += node.add * rightNum;</span><br><span class="line">        <span class="comment">// 对区间进行「加减」的更新操作，下推懒惰标记时需要累加起来，不能直接覆盖</span></span><br><span class="line">        node.left.add += node.add;</span><br><span class="line">        node.right.add += node.add;</span><br><span class="line">        node.add = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>对于表示为「区间和」且对区间进行「加减」的更新操作的情况，我们在更新节点值的时候『需要✖️左右孩子区间叶子节点的数量 (注意是叶子节点的数量)』；我们在下推懒惰标记的时候『需要累加』！！(这种情况和模版一致！！) 如题目 最近的请求次数<br>对于表示为「区间和」且对区间进行「覆盖」的更新操作的情况，我们在更新节点值的时候『需要✖️左右孩子区间叶子节点的数量 (注意是叶子节点的数量)』；我们在下推懒惰标记的时候『不需要累加』！！(因为是覆盖操作！！) 如题目 区域和检索 - 数组可修改<br>对于表示为「区间最值」且对区间进行「加减」的更新操作的情况，我们在更新节点值的时候『不需要✖️左右孩子区间叶子节点的数量 (注意是叶子节点的数量)』；我们在下推懒惰标记的时候『需要累加』！！ 如题目 我的日程安排表 I、我的日程安排表 III</p><h2 id="我的日程安排表-I"><a href="#我的日程安排表-I" class="headerlink" title="我的日程安排表 I"></a>我的日程安排表 I</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">MyCalendar</span>;</span><br><span class="line">    <span class="comment">// 左右孩子节点</span></span><br><span class="line">    Node *left, *right;</span><br><span class="line">    <span class="comment">// 当前节点值，以及懒惰标记的值</span></span><br><span class="line">    <span class="type">int</span> val, add;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyCalendar</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:    </span><br><span class="line">        <span class="built_in">MyCalendar</span>():<span class="built_in">N</span>(<span class="number">1e9</span>), <span class="built_in">root</span>(<span class="keyword">new</span> <span class="built_in">Node</span>())&#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">bool</span> <span class="title">book</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> end)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 先查询该区间是否为 0</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">query</span>(root, <span class="number">0</span>, N, start, end - <span class="number">1</span>) != <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// 更新该区间</span></span><br><span class="line">            <span class="built_in">update</span>(root, <span class="number">0</span>, N, start, end - <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(Node* node, <span class="type">int</span> start, <span class="type">int</span> end, <span class="type">int</span> l, <span class="type">int</span> r, <span class="type">int</span> val)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (l &lt;= start &amp;&amp; end &lt;= r) &#123;</span><br><span class="line">                node -&gt; val += val;</span><br><span class="line">                node -&gt; add += val;</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">pushDown</span>(node);</span><br><span class="line">            <span class="type">int</span> mid = (start + end) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (l &lt;= mid) <span class="built_in">update</span>(node -&gt; left, start, mid, l, r, val);</span><br><span class="line">            <span class="keyword">if</span> (r &gt; mid) <span class="built_in">update</span>(node -&gt; right, mid + <span class="number">1</span>, end, l, r, val);</span><br><span class="line">            <span class="built_in">pushUp</span>(node);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">int</span> <span class="title">query</span><span class="params">(Node* node, <span class="type">int</span> start, <span class="type">int</span> end, <span class="type">int</span> l, <span class="type">int</span> r)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (l &lt;= start &amp;&amp; end &lt;= r) <span class="keyword">return</span> node -&gt; val;</span><br><span class="line">            <span class="built_in">pushDown</span>(node);</span><br><span class="line">            <span class="type">int</span> mid = (start + end) &gt;&gt; <span class="number">1</span>, ans = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (l &lt;= mid) ans = <span class="built_in">query</span>(node -&gt; left, start, mid, l, r);</span><br><span class="line">            <span class="keyword">if</span> (r &gt; mid) ans = <span class="built_in">max</span>(ans, <span class="built_in">query</span>(node -&gt; right, mid + <span class="number">1</span>, end, l, r));</span><br><span class="line">            <span class="keyword">return</span> ans;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// *************** 下面是模版 ***************</span></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="type">int</span> N;</span><br><span class="line">        Node* root;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">pushUp</span><span class="params">(Node* node)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 每个节点存的是当前区间的最大值</span></span><br><span class="line">            node -&gt; val = <span class="built_in">max</span>(node -&gt; left -&gt; val, node -&gt; right -&gt; val);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">pushDown</span><span class="params">(Node* node)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (node -&gt; left == <span class="literal">nullptr</span>) node -&gt; left = <span class="keyword">new</span> <span class="built_in">Node</span>();</span><br><span class="line">            <span class="keyword">if</span> (node -&gt; right == <span class="literal">nullptr</span>) node -&gt; right = <span class="keyword">new</span> <span class="built_in">Node</span>();</span><br><span class="line">            <span class="keyword">if</span> (node -&gt; add == <span class="number">0</span>) <span class="keyword">return</span> ;</span><br><span class="line">            node -&gt; left -&gt; val += node -&gt; add;</span><br><span class="line">            node -&gt; right -&gt; val += node -&gt; add;</span><br><span class="line">            node -&gt; left -&gt; add += node -&gt; add;</span><br><span class="line">            node -&gt; right -&gt;add += node -&gt; add;</span><br><span class="line">            node -&gt; add = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Your MyCalendar object will be instantiated and called as such:</span></span><br><span class="line"><span class="comment"> * MyCalendar* obj = new MyCalendar();</span></span><br><span class="line"><span class="comment"> * bool param_1 = obj-&gt;book(start,end);</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>滤波与反滤波</title>
    <link href="/2022/07/03/conv/"/>
    <url>/2022/07/03/conv/</url>
    
    <content type="html"><![CDATA[<h2 id="自相关"><a href="#自相关" class="headerlink" title="自相关"></a>自相关</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-keyword">from</span> scipy <span class="hljs-keyword">import</span> signal<br>rng = np.random.default_rng()<br>sig = rng.standard_normal(<span class="hljs-number">1000</span>)<br>autocorr = signal.fftconvolve(sig, sig[::-<span class="hljs-number">1</span>], mode=<span class="hljs-string">&#x27;full&#x27;</span>)<br><br></code></pre></td></tr></table></figure><h2 id="高斯滤波"><a href="#高斯滤波" class="headerlink" title="高斯滤波"></a>高斯滤波</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> scipy<br><span class="hljs-keyword">from</span> scipy.ndimage <span class="hljs-keyword">import</span> gaussian_filter<br><span class="hljs-keyword">import</span> scipy.signal <span class="hljs-keyword">as</span> signal<br><br>c = <span class="hljs-number">3e8</span><br>dx = <span class="hljs-number">1e-6</span> * (x[<span class="hljs-number">1</span>] - x[<span class="hljs-number">0</span>])<br>sigma = c/<span class="hljs-number">10e12</span>/dx<br><br>EyTHz = scipy.ndimage.gaussian_filter(EyEnd, sigma = <span class="hljs-number">15</span>)<br><br></code></pre></td></tr></table></figure><p>使用高斯核卷积进行滤波</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><br>im = EyEnd<br>gauss_kernel = np.outer(signal.gaussian(im.shape[<span class="hljs-number">0</span>], <span class="hljs-number">15</span>), signal.gaussian(im.shape[<span class="hljs-number">1</span>], <span class="hljs-number">15</span>))<br><span class="hljs-comment">#gauss_kernel = gauss_kernel/np.sum(gauss_kernel)</span><br>gauss_kernel /= np.trapz(np.trapz(gauss_kernel))<br>im_real = signal.convolve(im, gauss_kernel, mode=<span class="hljs-string">&#x27;same&#x27;</span>)<br><span class="hljs-comment">#im_real = im * gauss_kernel</span><br><br></code></pre></td></tr></table></figure><p>其中sigma为滤波宽度</p><h2 id="使用卷积实现滤波"><a href="#使用卷积实现滤波" class="headerlink" title="使用卷积实现滤波"></a>使用卷积实现滤波</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> scipy <span class="hljs-keyword">import</span> signal<br><span class="hljs-comment">#from scipy import misc</span><br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br><br><span class="hljs-comment">####动态模糊核心</span><br>guass_kernal = [[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>],<br>                [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>],<br>                [<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]]<br><br>result = signal.convolve2d(origin, guass_kernal, boundary=<span class="hljs-string">&#x27;symm&#x27;</span>, mode=<span class="hljs-string">&#x27;same&#x27;</span>)<br><br></code></pre></td></tr></table></figure><p>二维的卷积运算还有一种函数，是signal.sepfir2d()，它可以传入三个参数，后两个参数指定行和列的卷积和(两个方向上的卷积是可以不同的，分别指定卷积和序列)。</p><h2 id="频域卷积"><a href="#频域卷积" class="headerlink" title="频域卷积"></a>频域卷积</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-keyword">from</span> scipy <span class="hljs-keyword">import</span> signal<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> numpy.fft <span class="hljs-keyword">as</span> fp<br><br>im = EyEnd <span class="hljs-comment">#EyEnd为需要滤波的图像</span><br><br>gauss_kernel = np.outer(signal.gaussian(im.shape[<span class="hljs-number">0</span>], <span class="hljs-number">15</span>), <br>signal.gaussian(im.shape[<span class="hljs-number">1</span>], <span class="hljs-number">15</span>))<br><br>plt.pcolormesh(gauss_kernel, cmap = <span class="hljs-string">&#x27;jet&#x27;</span>)<br><br>freq = np.fft.fft2(im)<br><span class="hljs-keyword">assert</span>(freq.shape == gauss_kernel.shape)<br>freq_kernel = np.fft.fft2(np.fft.ifftshift(gauss_kernel))<br><br>fig = plt.figure(figsize = (<span class="hljs-number">10</span>, <span class="hljs-number">4</span>))<br>ax_1 = fig.add_subplot(<span class="hljs-number">121</span>, projection=<span class="hljs-string">&#x27;3d&#x27;</span>)<br>ax_2 = fig.add_subplot(<span class="hljs-number">122</span>, projection=<span class="hljs-string">&#x27;3d&#x27;</span>)<br> <br>Y = np.arange(<span class="hljs-number">0</span> - <span class="hljs-built_in">int</span>(im.shape[<span class="hljs-number">0</span>]/<span class="hljs-number">2</span>), im.shape[<span class="hljs-number">0</span>] - <span class="hljs-built_in">int</span>(im.shape[<span class="hljs-number">0</span>]/<span class="hljs-number">2</span>), <span class="hljs-number">1</span>)<br>X = np.arange(<span class="hljs-number">0</span> - <span class="hljs-built_in">int</span>(im.shape[<span class="hljs-number">1</span>]/<span class="hljs-number">2</span>), im.shape[<span class="hljs-number">1</span>] - <span class="hljs-built_in">int</span>(im.shape[<span class="hljs-number">1</span>]/<span class="hljs-number">2</span>), <span class="hljs-number">1</span>)<br>X, Y = np.meshgrid(X, Y)<br> <br>ax_1.plot_surface(X, Y, np.log10(np.<span class="hljs-built_in">abs</span>(fp.ifftshift(freq))), rstride=<span class="hljs-number">4</span>,<br>cstride=<span class="hljs-number">4</span>, cmap=plt.cm.coolwarm)<br> <br>ax_2.plot_surface(X, Y, np.<span class="hljs-built_in">abs</span>(fp.ifftshift(freq_kernel)), rstride=<span class="hljs-number">4</span>,<br>cstride=<span class="hljs-number">4</span>, cmap=plt.cm.coolwarm)<br>plt.show()<br><br>conv = freq*freq_kernel<br>im1 = fp.ifft2(conv).real<br><br></code></pre></td></tr></table></figure><p>简洁版</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-keyword">from</span> scipy <span class="hljs-keyword">import</span> signal<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> numpy.fft <span class="hljs-keyword">as</span> fp<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fftConv</span>(<span class="hljs-params">im, sigma</span>):<br><br>    gauss_kernel = np.outer(signal.gaussian(im.shape[<span class="hljs-number">0</span>], sigma), <br>    signal.gaussian(im.shape[<span class="hljs-number">1</span>], sigma))<br>    plotFreq(freqX, freqY, gauss_kernel.T)<br><br>    freq = np.fft.fft2(im)<br>    <span class="hljs-keyword">assert</span>(freq.shape == gauss_kernel.shape)<br>    freq_kernel = np.fft.fft2(np.fft.ifftshift(gauss_kernel))<br>    <span class="hljs-comment">#freq_kernel = np.fft.fft2(gauss_kernel)</span><br>    plotField(freqX, freqY, np.log10(np.<span class="hljs-built_in">abs</span>(fp.ifftshift(freq))).T)<br>    plotFreq(freqX, freqY, np.<span class="hljs-built_in">abs</span>(fp.ifftshift(freq_kernel)).T) <br><br>    conv = freq*freq_kernel<br>    im1 = fp.ifft2(conv).real<br>    <span class="hljs-keyword">return</span> im1<br><br>im = EyEnd<br>plotField(x, y, im.T)<br>sigma = <span class="hljs-number">15</span><br>im1 = fftConv(im, sigma)<br>plotField(freqX, freqY, im1.T) <br><br></code></pre></td></tr></table></figure><p>时域和频域对比</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> pylab<br><br>freq = np.fft.fft2(im)<br><span class="hljs-keyword">assert</span>(freq.shape == gauss_kernel.shape)<br>freq_kernel = np.fft.fft2(np.fft.ifftshift(gauss_kernel))<br>conv = freq * freq_kernel<br>im1 = fp.ifft2(conv).real<br><br>pylab.figure(figsize = (<span class="hljs-number">20</span>, <span class="hljs-number">8</span>))<br>pylab.gray()<br>pylab.subplot(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>), pylab.pcolormesh(im.T, cmap = <span class="hljs-string">&#x27;bwr&#x27;</span>), pylab.title(<span class="hljs-string">&#x27;Original Image&#x27;</span>, size = <span class="hljs-number">30</span>), pylab.axis(<span class="hljs-string">&#x27;off&#x27;</span>)<br>pylab.subplot(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>), pylab.pcolormesh(gauss_kernel.T, cmap = <span class="hljs-string">&#x27;jet&#x27;</span>), pylab.title(<span class="hljs-string">&#x27;Gaussian Kernel&#x27;</span>, size = <span class="hljs-number">30</span>), pylab.axis(<span class="hljs-string">&#x27;off&#x27;</span>)<br>pylab.subplot(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>), pylab.pcolormesh(im1.T, cmap = <span class="hljs-string">&#x27;bwr&#x27;</span>), pylab.title(<span class="hljs-string">&#x27;Output Image&#x27;</span>, size = <span class="hljs-number">30</span>), pylab.axis(<span class="hljs-string">&#x27;off&#x27;</span>)<br><br>imOrigin = (<span class="hljs-number">20</span>*np.log10(np.<span class="hljs-built_in">abs</span>(<span class="hljs-number">0.1</span>+fp.ifftshift(freq)))).astype(<span class="hljs-built_in">int</span>)<br>pylab.subplot(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>), pylab.pcolormesh(imOrigin.T, cmap = <span class="hljs-string">&#x27;bwr&#x27;</span>)<br>pylab.title(<span class="hljs-string">&#x27;Origin Image Spectrum&#x27;</span>, size = <span class="hljs-number">30</span>), pylab.axis(<span class="hljs-string">&#x27;off&#x27;</span>)<br><br>imGuassian = (<span class="hljs-number">20</span>*np.log10(np.<span class="hljs-built_in">abs</span>(<span class="hljs-number">0.1</span>+fp.ifftshift(freq_kernel)))).astype(<span class="hljs-built_in">int</span>)<br>pylab.subplot(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>), pylab.pcolormesh(imGuassian.T, cmap = <span class="hljs-string">&#x27;jet&#x27;</span>)<br>pylab.title(<span class="hljs-string">&#x27;Gaussian Kernel Spectrum&#x27;</span>, size = <span class="hljs-number">30</span>), pylab.axis(<span class="hljs-string">&#x27;off&#x27;</span>)<br><br>imOutSpec = (<span class="hljs-number">20</span>*np.log10(np.<span class="hljs-built_in">abs</span>(<span class="hljs-number">0.1</span>+fp.ifftshift(conv)))).astype(<span class="hljs-built_in">int</span>)<br>pylab.subplot(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>), pylab.pcolormesh(imOutSpec.T, cmap = <span class="hljs-string">&#x27;jet&#x27;</span>)<br>pylab.title(<span class="hljs-string">&#x27;Output Image Spectrum&#x27;</span>, size = <span class="hljs-number">30</span>), pylab.axis(<span class="hljs-string">&#x27;off&#x27;</span>)<br><br></code></pre></td></tr></table></figure><h2 id="带通滤波"><a href="#带通滤波" class="headerlink" title="带通滤波"></a>带通滤波</h2><p>在这里尝试使用高斯差分核（两个高斯核的差），作为带通滤波器。带通滤波是保留一定频段内的频率分量，而丢弃其余所有的频率分量。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">###读取图像</span><br>im = img_as_float(pylab.imread(<span class="hljs-string">&#x27;./images/snow.jpg&#x27;</span>))<br>pylab.figure(), pylab.imshow(im), pylab.axis(<span class="hljs-string">&#x27;off&#x27;</span>), pylab.show()<br>x = np.linspace(-<span class="hljs-number">10</span>, <span class="hljs-number">10</span>, <span class="hljs-number">15</span>)<br><span class="hljs-comment">###kernel 1 生成</span><br>kernel = np.exp(-<span class="hljs-number">0.005</span>*x**<span class="hljs-number">2</span>)<br>kernel /= np.trapz(kernel)<br>guass_kernel_1 = kernel[:, np.newaxis] * kernel[np.newaxis, :]<br><span class="hljs-comment">###kernel 2 生成</span><br>kernel = np.exp(-<span class="hljs-number">5</span>*x**<span class="hljs-number">2</span>)<br>kernel /= np.trapz(kernel)<br>guass_kernel_2 = kernel[:, np.newaxis] * kernel[np.newaxis, :]<br><span class="hljs-comment">###进行差分</span><br>DOGkernel = guass_kernel_1[:,:,np.newaxis] - guass_kernel_2[:,:,np.newaxis]<br><span class="hljs-comment">###卷积</span><br>im = signal.fftconvolve(im, DOGkernel, mode = <span class="hljs-string">&#x27;same&#x27;</span>)<br>pylab.figure, pylab.imshow(np.clip(im, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>)), pylab.axis(<span class="hljs-string">&#x27;off&#x27;</span>), <span class="hljs-built_in">print</span>(np.<span class="hljs-built_in">max</span>(im))<br>pylab.show()<br><br></code></pre></td></tr></table></figure><h2 id="使用傅里叶变换去卷积和逆滤波"><a href="#使用傅里叶变换去卷积和逆滤波" class="headerlink" title="使用傅里叶变换去卷积和逆滤波"></a>使用傅里叶变换去卷积和逆滤波</h2><p>如果已经有了一张具有模糊核的模糊图像，我们需要将其恢复到原始图像。原理上，我们只需要对原有的滤波卷积核每一个值进行倒数的操作即可实现逆滤波器的效果。在此我们仍然是在频域上进行卷积，代码如下。</p><p>需要注意的是，卷积核取到数的过程中需要在原来的数值上加一个微小数值epsilon，以避免分母为零。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><br>im = EyEnd <span class="hljs-comment">#255*rgb2gray(imread(&#x27;./images/snow.jpg&#x27;))</span><br>gauss_kernel = np.outer(signal.gaussian(im.shape[<span class="hljs-number">0</span>], <span class="hljs-number">3</span>), signal.gaussian(im.shape[<span class="hljs-number">1</span>], <span class="hljs-number">3</span>))<br> <br>freq = fp.fft2(im)<br>freq_kernel = fp.fft2(fp.ifftshift(gauss_kernel))<br>conv = freq*freq_kernel<br>im_blur = fp.ifft2(conv).real<br>im_blur = <span class="hljs-number">255</span>*im_blur/np.<span class="hljs-built_in">max</span>(im_blur)<br> <br>epsilon = <span class="hljs-number">10</span>**-<span class="hljs-number">6</span><br>freq = fp.fft2(im_blur)<br>freq_kernel = <span class="hljs-number">1</span>/(epsilon+freq_kernel) <span class="hljs-comment"># avoid freq_kernel is zero</span><br>im_rst = fp.ifft2(conv).real<br>im_rst = <span class="hljs-number">255</span>*im_rst/np.<span class="hljs-built_in">max</span>(im_rst)<br> <br>pylab.figure(figsize = (<span class="hljs-number">10</span>, <span class="hljs-number">6</span>))<br>pylab.subplot(<span class="hljs-number">221</span>), pylab.imshow(im), pylab.title(<span class="hljs-string">&#x27;Original Image&#x27;</span>), pylab.axis(<span class="hljs-string">&#x27;off&#x27;</span>)<br>pylab.subplot(<span class="hljs-number">222</span>), pylab.imshow(im_blur), pylab.title(<span class="hljs-string">&#x27;Blurred Image Image&#x27;</span>), pylab.axis(<span class="hljs-string">&#x27;off&#x27;</span>)<br>pylab.subplot(<span class="hljs-number">223</span>), pylab.imshow(im_rst), pylab.title(<span class="hljs-string">&#x27;Restored Image with inverse filter&#x27;</span>), pylab.axis(<span class="hljs-string">&#x27;off&#x27;</span>)<br>pylab.subplot(<span class="hljs-number">224</span>), pylab.imshow(im_rst - im), pylab.title(<span class="hljs-string">&#x27;Diff Image&#x27;</span>), pylab.axis(<span class="hljs-string">&#x27;off&#x27;</span>)<br><br></code></pre></td></tr></table></figure><h2 id="利用维纳滤波器去卷积"><a href="#利用维纳滤波器去卷积" class="headerlink" title="利用维纳滤波器去卷积"></a>利用维纳滤波器去卷积</h2><p>前面的去卷积方法需要已知模糊核，在这里使用维纳滤波器，在不知道模糊核的情况下，从损坏的信号中去除噪声，达到复原图像的目的。首先构造一个已经损坏了的图像。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><br>im = rgb2gray(imread(<span class="hljs-string">&#x27;./images/cat.jpg&#x27;</span>))<br> <br>n = <span class="hljs-number">7</span><br>psf = np.ones((n, n))/n**<span class="hljs-number">2</span><br>im1 = signal.convolve2d(im, psf, mode = <span class="hljs-string">&#x27;same&#x27;</span>)<br>im1 += <span class="hljs-number">0.1</span>*np.std(im1)*np.random.standard_normal(im.shape)<br><br></code></pre></td></tr></table></figure><p>再使用维纳滤波完成操作，最后就能得到图像</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><br>im2, _ = restoration.unsupervised_wiener(im1, psf)<br>fig, axes = pylab.subplots(nrows = <span class="hljs-number">1</span>, ncols = <span class="hljs-number">3</span>, figsize = (<span class="hljs-number">200</span>, <span class="hljs-number">40</span>), sharex = <span class="hljs-literal">True</span>,<br> sharey = <span class="hljs-literal">True</span>)<br>pylab.gray()<br>axes[<span class="hljs-number">0</span>].imshow(im), axes[<span class="hljs-number">0</span>].axis(<span class="hljs-string">&#x27;off&#x27;</span>), axes[<span class="hljs-number">0</span>].set_title(<span class="hljs-string">&#x27;Original image&#x27;</span>, size = <span class="hljs-number">200</span>)<br>axes[<span class="hljs-number">1</span>].imshow(im1), axes[<span class="hljs-number">1</span>].axis(<span class="hljs-string">&#x27;off&#x27;</span>), axes[<span class="hljs-number">1</span>].set_title(<span class="hljs-string">&#x27;Noisy blurred image&#x27;</span>, size = <span class="hljs-number">200</span>)<br>axes[<span class="hljs-number">2</span>].imshow(im2), axes[<span class="hljs-number">2</span>].axis(<span class="hljs-string">&#x27;off&#x27;</span>), axes[<span class="hljs-number">2</span>].set_title(<span class="hljs-string">&#x27;Self tuned restoration&#x27;</span>, size = <span class="hljs-number">200</span>)<br>fig.tight_layout()<br>pylab.show()<br><br></code></pre></td></tr></table></figure><h2 id="使用低通滤波，重建图像"><a href="#使用低通滤波，重建图像" class="headerlink" title="使用低通滤波，重建图像"></a>使用低通滤波，重建图像</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><br>im_fft = fp.ifftshift(im_fft_shift)<br>im = np.clip(fp.ifft2(im_fft).real, <span class="hljs-number">0</span>, <span class="hljs-number">255</span>)<br>pylab.figure(figsize = (<span class="hljs-number">10</span>,<span class="hljs-number">10</span>))<br>pylab.imshow(im,pylab.cm.gray), pylab.axis(<span class="hljs-string">&#x27;off&#x27;</span>), pylab.title(<span class="hljs-string">&#x27;Noise image&#x27;</span>), pylab.show()<br><br>keep_fraction = <span class="hljs-number">0.1</span><br>r,c = im_fft.shape<br>im_fft[<span class="hljs-built_in">int</span>(r*keep_fraction):<span class="hljs-built_in">int</span>(r*(<span class="hljs-number">1</span>-keep_fraction))] = <span class="hljs-number">0</span><br>im_fft[:, <span class="hljs-built_in">int</span>(c*keep_fraction):<span class="hljs-built_in">int</span>(c*(<span class="hljs-number">1</span>-keep_fraction))] = <span class="hljs-number">0</span><br>pylab.figure(), plot_spectrum(fp.fftshift(im_fft)), pylab.title(<span class="hljs-string">&#x27;Filitered Spectrum&#x27;</span>)<br><br>im_new = fp.ifft2(im_fft).real<br>pylab.figure(figsize = (<span class="hljs-number">10</span>, <span class="hljs-number">10</span>))<br>pylab.imshow(im_new,pylab.cm.gray), pylab.axis(<span class="hljs-string">&#x27;off&#x27;</span>), pylab.title(<span class="hljs-string">&#x27;Reconstructed image&#x27;</span>), pylab.show()<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>分治算法</title>
    <link href="/2022/07/01/Divide-and-Conquer/"/>
    <url>/2022/07/01/Divide-and-Conquer/</url>
    
    <content type="html"><![CDATA[<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>给你一个由数字和运算符组成的字符串 expression ，按不同优先级组合数字和运算符，计算并返回所有可能组合的结果。你可以 按任意顺序 返回答案。</p><p>生成的测试用例满足其对应输出值符合 32 位整数范围，不同结果的数量不超过 (10^4) 。</p><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">输入：expression = <span class="string">&quot;2-1-1&quot;</span></span><br><span class="line">输出：[<span class="number">0</span>,<span class="number">2</span>]</span><br><span class="line">解释：</span><br><span class="line">((<span class="number">2</span><span class="number">-1</span>)<span class="number">-1</span>) = <span class="number">0</span> </span><br><span class="line">(<span class="number">2</span>-(<span class="number">1</span><span class="number">-1</span>)) = <span class="number">2</span></span><br></pre></td></tr></table></figure><h2 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h2><p>对于一个形如 x op y（op 为运算符，x 和 y 为数） 的算式而言，它的结果组合取决于 x 和 y 的结果组合数，而 x 和 y 又可以写成形如 x op y 的算式。</p><p>因此，该问题的子问题就是 x op y 中的 x 和 y：以运算符分隔的左右两侧算式解。</p><p>然后我们来进行 分治算法三步走：</p><p>分解：按运算符分成左右两部分，分别求解<br>解决：实现一个递归函数，输入算式，返回算式解<br>合并：根据运算符合并左右两部分的解，得出最终解</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">diffWaysToCompute</span><span class="params">(string expression)</span> </span>&#123;</span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; vec1, vec2, res;</span><br><span class="line">        <span class="type">int</span> flag = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> n = expression.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)&#123;</span><br><span class="line">            <span class="type">char</span> oper = expression[i];</span><br><span class="line">            <span class="keyword">if</span>(oper == <span class="string">&#x27;+&#x27;</span> || oper == <span class="string">&#x27;-&#x27;</span> || oper == <span class="string">&#x27;*&#x27;</span>)&#123;</span><br><span class="line">                flag = <span class="number">1</span>;</span><br><span class="line">                vec1 = <span class="built_in">diffWaysToCompute</span>(<span class="built_in">string</span>(expression, <span class="number">0</span>, i));</span><br><span class="line">                vec2 = <span class="built_in">diffWaysToCompute</span>(<span class="built_in">string</span>(expression, i + <span class="number">1</span>, n - i - <span class="number">1</span>));</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">auto</span> v1: vec1)&#123;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">auto</span> v2: vec2)&#123;</span><br><span class="line">                        <span class="keyword">if</span>(oper == <span class="string">&#x27;+&#x27;</span>)&#123;</span><br><span class="line">                            res.<span class="built_in">push_back</span>(v1 + v2);</span><br><span class="line">                        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(oper == <span class="string">&#x27;-&#x27;</span>)&#123;</span><br><span class="line">                            res.<span class="built_in">push_back</span>(v1 - v2);</span><br><span class="line">                        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                            res.<span class="built_in">push_back</span>(v1 * v2);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(flag == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;std::<span class="built_in">stoi</span>(expression)&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>以及<strong>python</strong>版本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">diffWaysToCompute</span>(<span class="params">self, <span class="built_in">input</span>: <span class="built_in">str</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">        <span class="comment"># 如果只有数字，直接返回</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">input</span>.isdigit():</span><br><span class="line">            <span class="keyword">return</span> [<span class="built_in">int</span>(<span class="built_in">input</span>)]</span><br><span class="line"></span><br><span class="line">        res = []</span><br><span class="line">        <span class="keyword">for</span> i, char <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="built_in">input</span>):</span><br><span class="line">            <span class="keyword">if</span> char <span class="keyword">in</span> [<span class="string">&#x27;+&#x27;</span>, <span class="string">&#x27;-&#x27;</span>, <span class="string">&#x27;*&#x27;</span>]:</span><br><span class="line">                <span class="comment"># 1.分解：遇到运算符，计算左右两侧的结果集</span></span><br><span class="line">                <span class="comment"># 2.解决：diffWaysToCompute 递归函数求出子问题的解</span></span><br><span class="line">                left = <span class="variable language_">self</span>.diffWaysToCompute(<span class="built_in">input</span>[:i])</span><br><span class="line">                right = <span class="variable language_">self</span>.diffWaysToCompute(<span class="built_in">input</span>[i+<span class="number">1</span>:])</span><br><span class="line">                <span class="comment"># 3.合并：根据运算符合并子问题的解</span></span><br><span class="line">                <span class="keyword">for</span> l <span class="keyword">in</span> left:</span><br><span class="line">                    <span class="keyword">for</span> r <span class="keyword">in</span> right:</span><br><span class="line">                        <span class="keyword">if</span> char == <span class="string">&#x27;+&#x27;</span>:</span><br><span class="line">                            res.append(l + r)</span><br><span class="line">                        <span class="keyword">elif</span> char == <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">                            res.append(l - r)</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            res.append(l * r)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>EPOCH Code For Spectrum</title>
    <link href="/2022/06/30/centspec/"/>
    <url>/2022/06/30/centspec/</url>
    
    <content type="html"><![CDATA[<p>Use EPOCH Code to get axis spectrum</p><h2 id="SDF-Write"><a href="#SDF-Write" class="headerlink" title="SDF_Write"></a>SDF_Write</h2><p>Use this syntex can save axis Ey to file:</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CALL</span> sdf_write_plain_variable(sdf_handle, id, <span class="keyword">name</span>, </span><br><span class="line">units, dims, stagger, &amp; grid_id, variable,</span><br><span class="line">subtype_field, subarray_field)  </span><br></pre></td></tr></table></figure><p>The parameters have the following types and meanings:</p><ul><li><p><strong>block id</strong> - The id name of the variable. This character string is a unique identifier for the variable in the file enabling a program to retrieve it later. Once defined it should not change so that newer versions of EPOCH can still identify variables generated by older versions.</p></li><li><p><strong>name</strong> - The display name of the variable. This character string is the name that is used by external programs to display an identifying name for the variable. If it contains ‘&#x2F;‘ characters then these are used by VisIt to group the variables.</p></li><li><p><strong>units</strong> - The units of the variable. This character string is used when displaying the data units. For most variables in EPOCH these are SI units.</p></li><li><p><strong>dims</strong> - An nD integer array containing the GLOBAL length of the variable across all processors. In EPOCH a variable actually called “dims” exists for variables which are the same size as the default field variables.</p></li><li><p><strong>stagger</strong> - An integer constant containing the stagger of a variable from the cell centre of a cell. This property lets external programs know the position of a variable on the grid.</p></li><li><p><strong>grid id</strong> - The id name of the grid to which the variable is attached. In EPOCH , the main grid is just called “grid”. Note that this property is case sensitive.</p></li><li><p><strong>variable</strong> - The actual variable to be written to disk.</p></li><li><p><strong>subtype field</strong> - This is an MPI type representing the layout of the data across the processors. For a standard field variable, there is an automatically created type called “subtype field” which should be used here.</p></li><li><p><strong>subarray field</strong> - This is an MPI type representing the section of the “variable” parameter to be written. For a standard field variable, there is an automatically created type called “subarray field” which should be used here.</p></li></ul><h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><p>For Example, derived variables <strong>array</strong></p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">IF</span> (<span class="built_in">IAND</span>(dumpmask(c_dump_myvar), code)) <span class="keyword">THEN</span></span><br><span class="line">  <span class="keyword">CALL</span> calc_my_variable(array)</span><br><span class="line">  <span class="keyword">CALL</span> sdf_write_plain_variable(sdf_handle, ’my_var’,</span><br><span class="line">  ’Mine/variable’, ’<span class="keyword">unit</span>’, dims, c_stagger_cell_centre, </span><br><span class="line">  ’grid’, array, subtype_field, subarray_field)</span><br><span class="line"><span class="keyword">ENDIF</span></span><br></pre></td></tr></table></figure><h2 id="Cent-Spec"><a href="#Cent-Spec" class="headerlink" title="Cent Spec"></a>Cent Spec</h2><p>extract the central ey and save to sdf by subroutine <strong>sdf_write_plain_variable(…)</strong></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
